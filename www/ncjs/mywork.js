
(function(){var lib=page;var geom=idv.geom;var imlib=idv.image;var com=idv.common;var util=idv.util;lib.createAlbumWd=450;lib.editAlbumDiv=$('<div class="editAlbumDiv">'+'<div id="note">Note: these fields are optional, and can be edited later via "image details/ Edit"  </div>'+'<hr/>'+'<div class="albumFields">'+'<div id="editAlbumExplanation" style="text-align:center;margin-bottom:10px"></div>'+'<table id="albumFields">'+'<tr><td class="inputsTD">Title<td><td><input size="40" id="albumCaption" value="Untitled" type="text"/></td></tr>'+'<tr><td class="inputsTD"></td><td></td><td>To include links or other formatting in the description, use   <a href="http://daringfireball.net/projects/markdown/basics" target="idvWindow">Markdown</a></i></td></tr>'+'<tr><td class="inputsTD">Description<td><td><textarea rows="6" cols="50" id="albumDescription"/></td></tr>'+
'</table>'+'</div>'+'</table>'+'<div id="editAlbumButtons" class="buttonLine">'+'<span id="submitAlbum" class="clickableElement">Save</span>'+'<span id="cancelAlbum" class="clickableElement">Cancel</span>'+'</div>'+'</div>');lib.deleteAlbumDiv=$('<div id="deleteAlbum">'+'<div class="areYouSure">Are you sure you wish to delete this album, and its snapshots? There is no undo.</div>'+'<div>'+'<span  style="margin-left:20px" id="yesDeleteAlbum" class="clickableElement">Yes, Delete</span>'+'<span   id="noDontDeleteAlbum" style="margin-left:30px"  class="clickableElement">Cancel</span>'+'</div>'+'</div>');lib.createAlbumJsonP=function(imTopic,cb){var data={image:imTopic};var url="http://"+idv.apiHost+"/api/newAlbumJsonP";util.getJsonP(url,data,function(rs){cb(rs.value);});}
lib.deleteTheAlbum=function(){var data={topic:lib.albumD.topic};var url="/api/deleteAlbum";var imtp=lib.albumD.image.topic;util.post(url,data,function(rs){if(rs.status!="ok"){util.logout();location.href="/timeout";return;}
location.href="/mywork";},"json");util.log("api","uuuuu");}
lib.editAlbumFields=function(){var caption=$('#albumCaption',lib.editAlbumDiv).attr('value');var ds=$('#albumDescription',lib.editAlbumDiv).attr('value');var data={caption:caption,description:ds,topic:lib.albumD.topic};var url="/api/editAlbum";util.post(url,data,function(rs){lib.albumD.caption=data.caption;lib.albumD.description=data.description;lib.updateTopbarOptions(lib.topbar.options);lib.topbar.render()
lib.lightbox.dismiss();});}
lib.popEditAlbumLightbox=function(){lib.lightbox.pop();lib.lightbox.element.empty();lib.editAlbumDiv.css({"margin":"20px"});lib.lightbox.addClose();lib.albumD.caption='Untitled';lib.lightbox.element.append(lib.editAlbumDiv);$('#submitAlbum',lib.editAlbumDiv).click(function(){lib.editAlbumFields();});$('#cancelAlbum',lib.editAlbumDiv).click(function(){lib.lightbox.dismiss();});return;}
lib.showAlbumChoice=function(albums,im){var tp=im.topic;if(!albums||(albums.length==0)){var tpo=new util.topicOb(tp);tpo.albumId="-";tpo.kind="album";var atp=tpo.topic();var dst="http://"+idv.apiHost+idv.topicDir+atp+"/index.html";location.href=dst;return;}
var msg=$('<div id="lightboxMessage"/>');msg.css({'margin':'30px'});msg.append('<div>These are your albums of annotations of <i>'+util.imTitle(im)+'</i>:</div>');util.arrayForEach(albums,function(a){var abc=22;var ael=$('<div>').html(a.caption).css({'margin-top':'10px','margin-left':'20px','text-decoration':'underline','cursor':'pointer'});var dst="http://"+idv.apiHost+idv.topicDir+(a.topic)+'/index.html';ael.click(function(){location.href=dst;})
msg.append(ael);});util.addButton(msg,"Create New Album",function(){lib.createAlbumJsonP(tp,function(atp){var dst="http://"+idv.apiHost+idv.topicDir+atp+"/index.html?new=1";location.href=dst;});},true).css({"margin-top":"20px"});lib.lightbox.popMessage(msg);}
lib.popAlbumChoice=function(im){var tp=im.topic;if(!idv.loggedInUser){var tpo=new util.topicOb(tp);var url=idv.topicDir+"/album/"+tpo.imageOwner+"/"+tpo.imageName+"/-/index.html";location.href=url;return;}
var url="http://"+idv.apiHost+"/api/albumsForImageJsonP";var data={image:tp};util.getJsonP(url,data,function(rs){var albums=rs.value;lib.showAlbumChoice(albums,im);})}})();
(function(){var lib=page;var geom=idv.geom;var imlib=idv.image;var common=idv.common;var util=idv.util;lib.minLeftWd=300;lib.imHeight=100;lib.titleHt=50;lib.imPaddingY=30;lib.imPaddingX=20;lib.minImWd=70;lib.maxImWd=300;lib.imEls=[];lib.imDivs=[];lib.cntEls=[];lib.closeX='<div class="closeX" style="padding:3px;cursor:pointer;background-color:red;font-weight:bold;border:thin solid white;font-size:10pt;color:white;float:right">X</div>';lib.addClose=function(el){var thisHere=this;var close=$(lib.closeX);close.click(function(){el.hide();});el.append(close);}
lib.addHead=function(table,leftWd,rightWd){var imRow=$('<div/>');imRow.css({"margin":"20px","margin-top":"50px"});table.append(imRow);var left=$('<div/>');left.css({"display":"inline-block","font-weight":"bold","width":leftWd+"px"});imRow.append(left);left.html("Image");var right=$('<div/>');imRow.append(right);right.css({"display":"inline-block","width":rightWd+"px","vertical-align":"top"});var explain,qm;if(1||lib.hasActiveAlbum){right.append($('<span>Albums</span>').css({"display":"inline-block","font-weight":"bold","width":rightWd+"px","vertical-align":"top"}).append(qm=$('<span>?</span>').css({"margin-left":"10px","color":"blue","font-size":"8pt","cursor":"pointer"})));right.append(explain=$('<div/>'));explain.css({"border":"solid thin black","width":"300px","font-size":"8pt","padding":"5px"});lib.addClose(explain);explain.append($('<span>An album is a collection of annotated snapshots from an image. Each image may have '+'several albums. When an image is first added, an album is automatically created for it.</span>'));qm.click(function(){explain.show()});explain.hide();}}
lib.deleteAlbum=function(topic){var data={topic:topic};var url="/api/deleteAlbum";util.post(url,data,function(rs){if(rs.status!="ok"){util.logout();location.href="/timeout";return;}
location.href="/mywork";},"json");util.log("api","uuuuu");}
lib.deleteImage=function(topic){var data={topic:topic};var url="/api/deleteImage";util.post(url,data,function(rs){if(rs.status!="ok"){util.logout();location.href="/timeout";return;}
location.href="/mywork"},"json");util.log("api","uuuuu");}
lib.addPic=function(table,im,leftWd,rightWd,pubWd){var tp=im.topic;var albums=lib.albumsByImage[tp];var aln=0;if(albums){aln=albums.length;}
var snapCount=0;var sna=im.snapsAlbum;if(sna){snapCount=sna.snapCount;} 
var ttl=im.title;if(!ttl){ttl=im.name;}
var imRow=$('<div/>');imRow.css({"border-top":"solid thin black","margin":"20px"});table.append(imRow);var left=$('<div/>');left.css({"display":"inline-block","width":leftWd+"px"});imRow.append(left);var right=$('<div/>');imRow.append(right);right.css({"display":"inline-block","width":rightWd+"px","vertical-align":"top"});var ttldiv=$('<div/>');ttldiv.html(ttl);left.append(ttldiv);if(!im.atS3){right.html("Now importing ...");return;}
if(aln>0){for(var i=0;i<aln;i++){var alb=albums[i];var cp=alb.caption;if(!cp)cp="untitled";var csp=$('<div/>');csp.css({"padding-left":"10px","padding-right":"10px"});url=idv.topicDir+(alb.topic)+"/index.html?unpublished=1";var icsp=$('<span/>').css({"text-decoration":"underline","cursor":"pointer"}).html(cp);(function(iurl){ icsp.click(function(){location.href=iurl});})(url);csp.html((i+1)+".");csp.append(icsp);var dl;csp.append(dl=$('<span>delete</span>'));dl.css({"margin-left":"10px","font-size":"8pt","text-decoration":"underline","cursor":"pointer"});(function(atp){dl.click(function(){util.myConfirm("Delete Album","Are you sure you wish to delete this album, and all of its snaps?",function(){lib.deleteAlbum(atp);},function(){util.closeDialog()});});})(alb.topic);right.append(csp);}}else{right.html("No albums")}
var newAlbumButton,moreAlbumsButton;(function(itp){util.addButton(right,"Create New Album",function(){lib.createAlbumJsonP(itp,function(atp){var dst=idv.topicDir+atp+"/index.html?new=1";location.href=dst;});},true).css({"font-size":"9pt","margin-top":"10px"});})(tp);var tpo=new util.topicOb(tp);var tps=tp.split("/");var imo=tpo.imageOwner;var imname=tpo.imageName;var imdim=im.dimensions;var arti=(imdim.x)/(imdim.y);var ht=lib.imHeight;var wd=Math.max(Math.ceil(ht*arti),lib.minImWd);if(wd>lib.maxImWd){ var sc=lib.maxImWd/wd;ht=ht*sc;wd=lib.maxImWd;}
var imsrc=util.s3imDir(imo,imname)+"resized/area_50000.jpg";var imel=$('<img src="'+imsrc+'"/>');left.append(imel);imel.css({"cursor":"pointer"});imel.attr("width",wd);imel.attr("height",ht);if(im.s3Storage){var bs=util.bytesstring(im.s3Storage);var sdiv=$('<div/>');left.append(sdiv);sdiv.html("Storage: "+bs);}
(function(iim,aln,tpo,albums){ if(!iim.shared){var imdel=$('<div>delete image</div>');left.append(imdel);imdel.css({"margin-left":"10px","font-size":"8pt","text-decoration":"underline","cursor":"pointer"});imdel.click(function(){util.myConfirm("Delete Image","Are you sure you wish to delete this image, and all of its albums?",function(){lib.deleteImage(iim.topic);},function(){util.closeDialog()});})
}
imel.click(function(){ var liim=iim;var ltpo=tpo;var laln=aln;var lalbums;if(aln==0){var dst=idv.topicDir+"/album/"+tpo.imageOwner+"/"+tpo.imageName+"/-/index.html";location.href=dst;}else if(aln==1){var altp=albums[0].topic;var dst=idv.topicDir+altp+"/index.html";location.href=dst;}else{lib.popAlbumChoice(iim);}});})(im,aln,tpo,albums);lib.imEls.push(imel);}
lib.imagesByTopic={};lib.albumsByImage={};lib.maxImageWd=function(){var rs=0;util.arrayMap(lib.images,function(im){var imdim=im.dimensions;var arti=(imdim.x)/(imdim.y);var ht=lib.imHeight;var wd=Math.max(Math.ceil(ht*arti),lib.minImWd);if(wd>rs)rs=wd;});return Math.min(lib.maxImWd,rs);}
lib.organizeData=function(){var ims=lib.images;ims.sort(function(im0,im1){return(im0.current_item_create_time)<(im1.current_item_create_time)?1:-1});var albums=lib.albums;util.arrayMap(ims,function(im){var tp=im.topic;lib.imagesByTopic[tp]=im;});var abyim=lib.albumsByImage;lib.hasActiveAlbum=0;util.arrayMap(albums,function(album){var imtp=album.image;if(album.caption==".snaps."){var im=lib.imagesByTopic[imtp];im.snapsAlbum=album;}
var aby=abyim[imtp];if(aby==undefined){aby=[album];abyim[imtp]=aby;}else{aby.push(album);}});for(var ab in abyim){var albums=abyim[ab]
albums.sort(function(a0,a1){return a0<a1?1:-1});if(albums.length>1){lib.hasMultiAlbums=1;}
}}
lib.addPics=function(){ imDiv=$('<div/>');$('.infoDiv').append(imDiv);var pdiv=imDiv;var ims=lib.images;var albums=lib.albums;var leftWd=Math.max(lib.minLeftWd,lib.maxImageWd()+10);var twd=$('.infoDiv').width();var rightWd=twd-leftWd-40;var pubWd=150;
var ln=lib.images.length;if(ln==0){var noteDiv=$("<div>To get started, we suggest that you do some practice annotation on an existing image. "+" Click on the image (Holbein's The Ambassadors) below to give it a whirl:</div>"+" <div id='imageDiv'><div id='annotate_me'>Annotate Me</div><div><img id='theimage' width='200' src='http://static.imagediver.org/images/4294b0e/the_ambassadors/resized/area_50000.jpg'/></div></div> "+"<div> It's safe to practice. Annotations can always be edited or deleted.</div> "+"<div>Alternatively, you can annotate any of these <a href='/images'>images</a> just by clicking on them. Or, go ahead and "+" <a href='/upload'>import</a> your own image from your computer or from the web.</div>");pdiv.append(noteDiv);noteDiv.css({"margin-top":30,"margin-left":30});function annotate(){location.href=idv.topicDir+'/album/4294b0e/the_ambassadors/-/index.html'}
$('#annotate_me').css({'text-decoration':'underline','cursor':'pointer','width':'200px','text-align':'center',"color":util.linkColor}).click(annotate);$('#theimage').css({'cursor':'pointer'}).click(annotate);$('#imageDiv').css({"padding-left":"250px","padding-right":"250px"});
return;}
lib.addHead(pdiv,leftWd,rightWd);for(var i=0;i<ln;i++){var cim=lib.images[i];lib.addPic(pdiv,cim,leftWd,rightWd,pubWd);}
lib.picsAdded=true;}
lib.initialize=function(){idv.util.commonInit();idv.topbar.genTopbar(undefined,{title:"Content"});var jsonUrl='/api/albumsAndImages'
idv.util.get(jsonUrl,function(rs){if(rs.status!="ok"){location.href="/timeout";return;}
var top=50;var lbwd=600;var lft=winCenter=0.5*lbwd;var wht=$(window).height();var lbht=200;var lightboxRect=new geom.Rect(new geom.Point(lft,top),new geom.Point(lbwd,lbht));var lb=new common.Lightbox($('body'),lightboxRect);lb.render();lib.lightbox=lb;var pdiv=$('.infoDiv');lib.images=rs.value.images;lib.albums=rs.value.albums;lib.organizeData();lib.thePics=[];lib.addPics();});}})();
