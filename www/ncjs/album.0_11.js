(function(){var lib=page;var geom=exports.GEOM2D;var imlib=exports.IMAGE;var com=idv.common;var util=idv.util;lib.scaleDivForPanel=function(panel){return;util.log("scale",panel.name);if(panel.selfScaling)return;var scalable=panel.scalable;var iht=panel.height;if(iht){if(scalable){var ht=lib.scale*iht;}else{ht=iht;}}else{ht=null;}
lib.panelDiv.css("height",ht);}
lib.resizeCurrentPanel=function(){if(!lib.currentPanel)return;var pn=lib.currentPanel.panel;var resizer=pn.data("resizer");if(resizer){resizer();}} 
lib.selectPanel=function(panelName,initData,dontCallInitializer){if(lib.currentPanel){lib.lastPanel=lib.currentPanel;}
if(typeof(panelName)!="string"){panelName=panelName.name;}
var selPanel=lib.panels[panelName];
var selActv=selPanel.activator;for(var nm in lib.panels){var cpan=lib.panels[nm];var cpn=cpan.panel;var actv=cpan.activator;if(!cpn)continue;if(nm==panelName){if(lib.currentPanel==cpan)continue;if(actv){lib.selectClickable(actv);}
if(lib.vp){if(!lib.showSnapsMode)lib.vp.clearOverlays();}
cpn.show();lib.scaleDivForPanel(cpan);lib.currentPanel=cpan;var initializer=cpn.data("initializer");if(initializer&&!dontCallInitializer){if(initData){initializer(initData);}else{initializer();}}}else{if(actv&&selActv){ lib.enableClickable(actv);}
cpn.hide();}}}
lib.setPanelPanel=function(name,panel){var pn=lib.panels[name];if(!pn){pn={panel:panel,name:name};lib.panels[name]=pn;return pn;}
pn.panel=panel;return pn;}
lib.setPanelNominalHeight=function(name,ht){var pn=lib.panels[name];pn.nominalHeight=ht;}
lib.setPanelActivator=function(name,activator){var pn=lib.panels[name];if(!pn){pn={activator:activator,name:name};lib.panels[name]=pn;return pn;}
pn.activator=activator;return pn;}
lib.hookupPanelActivator=function(name){var pnd=lib.panels[name];var actv=pnd.activator;if(pnd&&actv){lib.setClickMethod(actv,function(){lib.selectPanel(name);})
actv.mousedown(function(e){e.preventDefault();});}}
lib.hookupPanelActivators=function(){for(nm in lib.panels){lib.hookupPanelActivator(nm);}}
lib.pathLast=function(p){var sp=p.split("/");var ln=sp.length;return sp[ln-1];}
lib.setPanelDivHeight=function(ht){lib.panelDiv.css("height",ht);var ofs=lib.panelDiv.offset();}})();
(function(){var lib=page;var geom=exports.GEOM2D;var imlib=exports.IMAGE;var com=idv.common;var util=idv.util;lib.snapArrayDiv=$('<div id="snapArray">'+'<div id="snapArrayNoSnaps">No snapshots have been added to this album yet</div>'+'<div id="snapArrayIntro">Click on snapshot for detail</div>'+'<div id="snapArraySnaps"></div>'+'</div');lib.checkNoSnaps=function(){if(lib.snaps.length==0){$('#snapArrayNoSnaps').show();$('#snapArrayIntro').hide();}else{$('#snapArrayNoSnaps').hide();$('#snapArrayIntro').show();lib.positionSnaps(undefined,false,true);}}
lib.snapArrayDiv.data("initializer",function(){$('#snapArrayNoSnaps').hide();$('#snapArrayIntro').hide();if(lib.selectedSnaps.length<2){ lib.setSelectedSnap(undefined,lib.showSnapsMode?lib.stdSnapAdvice():" ");}
lib.positionSnaps(undefined,false,true);});lib.minAspectRatio=0.82;lib.snapArrayThumbWidth=function(snapD){var xt=snapD.coverage.extent;var aspectRatio=Math.max(lib.minAspectRatio,xt.y/xt.x);var snapH=lib.snapThumbHeight;return snapH/aspectRatio;}
lib.snapArrayThumbContainerWidth=function(snapD){var tw=lib.snapArrayThumbWidth(snapD);var rs=tw+lib.snapThumbMargin*2;if(rs<lib.snapArrayMinThumbWidth){rs=lib.snapArrayMinThumbWidth;}
return rs;}
lib.fixSnapCoverage=function(snapD){var sc=snapD.shares_coverage;if(sc>0){var sw=lib.snapDsByTopicNum[sc];snapD.coverage=sw.coverage;snapD.cropid=sw.cropid;}}
lib.snapWidth=function(snapD){var xt=snapD.coverage.extent;var aspectRatio=xt.y/xt.x;var snapH=lib.snapHeight;return snapH/aspectRatio;} 
lib.setThumbCss=function(snap,left,top,sc,useThisCapHeight){ if(useThisCapHeight){}
sc=Math.max(sc,lib.minSnapScale);var snapH=lib.snapThumbHeight;var snapBottomMargin=lib.snapThumbBottomMargin;var snapCapHeight=lib.snapThumbCaptionHeight;if(useThisCapHeight){var aaa=22;snapCapHeight=useThisCapHeight/sc+20;}
var snapW=lib.snapArrayThumbWidth(snap.snapD);var snapCW=lib.snapArrayThumbContainerWidth(snap.snapD);idv.util.log("snaparray","snapW",snapW,"snapCW",snapCW);var imleft=(snapCW-snapW)/2;var snapCH=snapH+snapBottomMargin+snapCapHeight; var cnt=snap.container;var css={"border":"solid thin gray",left:sc*left,top:sc*top,width:sc*snapCW,height:sc*snapCH,position:"absolute"};cnt.css(css);var cse=snap.img;cse.css({left:sc*imleft,top:sc*(5+snapCapHeight),width:sc*snapW,height:sc*snapH,position:"absolute"}); var snapD=snap.snapD;snapD.thumbCaptionEl.empty();var cap=util.removeWikiSymbols(snapD.caption);if(useThisCapHeight){var chta=useThisCapHeight;}else{var chta=sc*(snapCH-snapH);}
snapD.thumbCaptionEl.html(cap);var cht=snapD.thumbCaptionEl.height(); if(cht<10)cht=10; var cnt=0;if(lib.shortCaptions)return[cht,snapH] 
while((cht>chta)&&(cnt<3)){ var cln=cap.length;var ratio=chta/(cht);var nln=Math.max(Math.floor(cln*ratio)-3,1);var cap=cap.substr(0,nln);snapD.thumbCaptionEl.html(cap);cht=snapD.thumbCaptionEl.height(); cnt++;}
if(cnt>0){snapD.thumbCaptionEl.html("<p>"+cap+"...</p>");}else{snapD.thumbCaptionEl.html("<p>"+cap+"</p>");}
return cht;}
lib.mouseenterSnap=function(snap){var snapD=snap.snapD;var cv=snapD.coverage;var vp=lib.vp;lib.setSelectedSnap(snap,lib.stdSnapAdvice());var cnt=snap.container;cnt.css({"background-color":"#dddddd"});var cap=snap.caption;cap.css({"color":"black"});}
lib.mouseleaveSnap=function(snap){
var cnt=snap.container;cnt.css({"background-color":"black"});var cap=snap.caption;cap.css({"color":"white"});if(page.currentPanel.name!="snapArray")return;lib.setSelectedSnap(undefined,lib.stdSnapAdvice());}
lib.minSnapScale=0.4;
lib.showAllSnaps=1; lib.positionSnaps=function(rowHeights,force,iShowAll){if(iShowAll==undefined){if(!force)return;var showAll=lib.showAllSnaps;}else{lib.showAllSnaps=iShowAll;showAll=iShowAll;}
if(lib.zooming)return;var firstPass=!rowHeights;if(lib.custom)return;var minHt=lib.standardPanelHeight;var sc=lib.scale;if(lib.twoColumns){var uW=950;}else{uW=2000;sc=sc*0.5;}
var mss=lib.minSnapScale;var eWd=(sc<mss)?uW*(sc/mss):uW; var wd=1000;var snaps=lib.snaps;var ln=snaps.length;var gapX=lib.snapGapX;var gapY=lib.snapGapY;var snapH=lib.snapThumbHeight;var snapCapH=lib.snapThumbCaptionHeight;var snapCapBottom=lib.snapThumbBottomMargin;var cx=gapX;var cy=gapY;var cy=40;var noSnaps=true;var ns=lib.snapsActive;var lastSnapTooWide=false; if(firstPass){rowHeights=[];maxCapHt=0;} 
var rowNum=0;for(var i=0;i<ns;i++){var cs=snaps[i];var snapD=cs.snapD;if(snapD.relevant||showAll){cs.container.show();noSnaps=false;}else{cs.container.hide();continue;}
var snapW=lib.snapArrayThumbContainerWidth(cs.snapD); nx=cx+snapW+gapX;if(nx>eWd){ rowNum++;if(firstPass){rowHeights.push(Math.min(100,maxCapHt));maxCapHt=0;}
cy=cy+lastThumbHt+gapY;cx=gapX;nx=cx+snapW+gapX;}
if(firstPass){var cht=lib.setThumbCss(cs,cx,cy,sc,undefined);}else{lib.setThumbCss(cs,cx,cy,sc,rowHeights[rowNum]);}
var lastThumbHt=cs.container.height()/sc;if(cht>maxCapHt)maxCapHt=cht;cx=nx;}
rowHeights.push(Math.min(50,maxCapHt));if(!lib.twoColumns){var sht=cy+snapH+snapCapH+snapCapBottom+gapY+20;lib.setPanelDivHeight(sc*sht);}
if(noSnaps){$("#snapArrayIntro").html("No snapshot selected");lib.hideAllSelectedSnaps();return;}else{$("#snapArrayIntro").html("Click on snapshot for detail")}
if(firstPass)lib.positionSnaps(rowHeights,1);}
lib.snapArrayDiv.data("resizer",function(){lib.positionSnaps(undefined,true);});lib.snaps=[];lib.snapImUrl=function(snapD,thumb){ var cv=snapD.coverage;var xt=cv.extent;var aratio=xt.y/xt.x;var tp=snapD.topic;var tps=tp.split("/");var tpln=tps.length;var uname=tps[2];var imname=tps[3];var im=lib.albumD.image;var imowner=util.pathLast(im.owner);var sc=snapD.cropid;if(sc!=undefined){var snapNum=sc;}else{util.error("NO CROPID");snapNum=tps[tpln-1];}
var cropId=snapD.cropid;if(cropId==undefined){cropId=snapNum;}
if(thumb){var rimd="snapthumb/"+cropId+".jpg";}else{var rimd="snap/"+cropId+".jpg";}
if(lib.published){var rs=util.s3imDir(imowner,imname)+rimd+"?album="+lib.albumString;}else{var rs=util.localImDir(imowner,imname)+rimd+"?album="+lib.albumString;}
return rs;}
lib.snapDthumb=function(snapD){return lib.snapImUrl(snapD,true);}
lib.snapDfullsize=function(snapD){return lib.snapImUrl(snapD,false);}
lib.showSnapsMode=false;lib.snapsByTopic={};lib.displayTopicId=0;
lib.showSnapByTopic=function(n){if(n==undefined){n=lib.urlSnap;}
var snd=page.snapDsByTopicNum[n];if(snd){lib.showSelectedSnap(snd);}}
lib.addSnap=function(snapD,editingSnap){var topicId=util.lastPathElement(snapD.topic);snapD.topicId=topicId;
if(editingSnap){ var dst=editingSnap;util.setProperties(dst,snapD,["caption","description","cropid"]);}else{dst=snapD;}
dst.coverage=geom.internalizeRect(snapD.coverage);var imsrc=lib.snapDthumb(snapD);if(editingSnap){var imjq=editingSnap.thumbImageEl;}else{var thumbc=$("<div class='thumbc'/>");var caption=$("<div class='thumbCaption'></div>");snapD.thumbCaptionEl=caption;if(lib.displayTopicId){thumbc.append(topicId);}else{thumbc.append(caption);}
var imjq=$("<img class='thumb' />");snapD.thumbImageEl=imjq;thumbc.append(imjq);lib.snapArraySnapsDiv.append(thumbc);thumbc.click(function(){lib.vp.setZoom(1);lib.showSelectedSnap(snapD)});var esd={snapD:snapD,container:thumbc,img:imjq,caption:caption};thumbc.mouseenter(function(){lib.mouseenterSnap(esd)});thumbc.mouseleave(function(){lib.mouseleaveSnap(esd);});thumbc.mousedown(function(e){e.preventDefault();});lib.snaps.push(esd);var tp=snapD.topic;lib.snapsByTopic[tp]=esd;lib.snapsActive=lib.snaps.length;}
util.log("imsrc",imsrc);imlib.loadImage(imjq,imsrc);}
lib.anyCaptions=function(){var ln=lib.snaps.length;for(var i=0;i<ln;i++){var sd=lib.snaps[i].snapD;if(sd.caption)return true;}
return false;}
lib.longCaptions=function(cln){var ln=lib.snapDs.length;for(var i=0;i<ln;i++){var sd=lib.snapDs[i];if(sd.caption&&sd.caption.length>cln)return true;}
return false;}
lib.snapsReady=false;lib.snapsActive=0; lib.addSnaps=function(snapDs,mxn){var ln=snapDs.length;if(!lib.custom){if(!lib.anyCaptions()){lib.snapThumbCaptionHeight=20;}
if(!lib.longCaptions(12)){lib.shortCaptions=true;lib.snapThumbCaptionHeight=40;}}
if(ln>mxn){var ns=mxn;var rs=false;}else{ns=ln;rs=true;}
lib.snapsActive=ns;for(var i=0;i<ns;i++){var sd=snapDs[i]; lib.addSnap(sd);}
if(!lib.custom)lib.positionSnaps(undefined,true,true);if(rs)lib.snapsReady=true;return rs;}
lib.addSnapArrayDiv=function(container){container.append(lib.snapArrayDiv);lib.setPanelPanel("snapArray",lib.snapArrayDiv);lib.snapArrayDiv.css({width:"100%"});lib.snapArraySnapsDiv=$('#snapArraySnaps');if(lib.editPermissions()){$('#snapArrayNoSnaps').html('To add your first annotation, click "new snap"');$('#snapArrayNoSnaps').css({'font-size':'15pt'});}}
lib.internalizeSnapD=function(snapD,sc){var cv=snapD.coverage;var ext=cv.extent;var crn=cv.corner;var nc={extent:{x:ext.x*sc,y:ext.y*sc},corner:{x:crn.x*sc,y:crn.y*sc}};snapD.coverage=nc;}})();
(function(){var lib=page;var geom=exports.GEOM2D;var imlib=exports.IMAGE;var com=idv.common;var util=idv.util;lib.interpolateCoverage=function(startCov,destCov,v){if(v>=1)v=1;lib.animationUnderway=true;var covNow=startCov.interpolate(destCov,v);var covRect=geom.internalizeRect(covNow);lib.vp.setCoverage(covRect);lib.zSlider.positionSliderFromZoom(lib.vp.zoom);if(v<1){setTimeout(function(){lib.interpolateCoverage(startCov,destCov,v+0.1);},50);}else{page.zooming=false;lib.vp.refreshOverlays();lib.zSlider.setZoom(lib.zSlider.getZoom());}}
lib.immediateZoomToSnap=function(snapD,scale){if(!scale)scale=1.1;var cov=snapD.coverage;var scov=cov.scale(scale);var covRect=geom.internalizeRect(scov);lib.vp.setCoverage(covRect);lib.zSlider.positionSliderFromZoom(lib.vp.zoom);}
lib.animatedZoomToSnap=function(snapD,scale){page.zooming=true;var startCov=lib.vp.coverage();if(!scale)scale=1.1;var destCov=snapD.coverage.scale(scale);lib.interpolateCoverage(startCov,destCov,0);}
lib.zoomToSelectedSnap=function(){lib.vp.setZoom(1);lib.animatedZoomToSnap(lib.selectedSnap.snapD,1.1);}})();
(function(){var lib=page;var geom=exports.GEOM2D;var imlib=exports.IMAGE;var com=idv.common;var util=idv.util;lib.allSelectedSnaps={}; lib.selectedSnaps=[]; lib.selectedSnap=undefined;
lib.setSelectedSnapCallbacks=[];lib.setSelectedSnaps=function(sns,snapAdvice,noBuild){lib.clearOverlayState();var ln=sns.length;var sna=snapAdvice;var ss=[];for(var i=0;i<ln;i++){var sn=sns[i];var snapD=sn.snapD;snapD.overlayState="selected";ss.push(lib.buildSelectedSnap(snapD.topic,true));}
if(ln==1){lib.selectedSnap=ss[0];if(!sna)sna=lib.stdSnapAdvice();}else if(ln==0){lib.selectedSnap=undefined;if(!sna)sna="no snap selected. try again if you like.";}else{ lib.selectedSnap=undefined;if(!sna)sna="multiple snaps selected. choose one from left panel";}
if(sna!="nochange")lib.snapAdvice.html(sna);lib.selectedSnaps=ss;lib.updateOverlays("selected"); util.runCallbacks(lib.setSelectedSnapCallbacks);}
lib.setSelectedSnap=function(s,snapAdvice,noBuild){if(s){lib.setSelectedSnaps([s],snapAdvice,noBuild);}else{lib.setSelectedSnaps([],snapAdvice);}}
lib.maxOrdinal=function(){var mxo=0;util.arrayForEach(lib.snapDs,function(snd){mxo=Math.max(mxo,snd.ordinal);})
return mxo;}
lib.snapCallback=function(data){var snapD=data.value;if(!lib.editingSnap){snapD.ordinal=lib.maxOrdinal()+1;snapD.myIndex=lib.snapDs.length;lib.snapDs.push(snapD);}
lib.addSnap(snapD,lib.editingSnap);if(lib.editingSnap){lib.clearSelectedSnaps();lib.showSelectedSnap(lib.editingSnap);}else{lib.fixNextToLastSelectedSnap();lib.showSelectedSnap(snapD);}
if(lib.showSnapsMode){lib.redisplaySnaps();}
}
lib.editSnap=function(){var selsnap=lib.selectedSnap;lib.selectPanel("createSnap",selsnap);}
lib.hideSelectedSnap=function(selsnap){if(!selsnap){selsnap=lib.selectedSnap;}
if(!selsnap)return;function hideIfNonNull(x){if(x)x.hide();}
hideIfNonNull(selsnap.prevThumb);hideIfNonNull(selsnap.nextThumb);hideIfNonNull(selsnap.element);hideIfNonNull(selsnap.bigImg);}
lib.hideAllSelectedSnaps=function(){util.resetClock();var ss=lib.allSelectedSnaps;for(var k in ss){var cs=ss[k];lib.hideSelectedSnap(cs);}
util.tlog("hideAllSelectedSnaps");}
lib.thumbWidth=function(snapD){var xt=snapD.coverage.extent;var aspectRatio=Math.max(lib.minAspectRatio,xt.y/xt.x);var snapH=lib.snapThumbHeight;return snapH/aspectRatio;}
lib.positionsForSelectedSnapElements=function(snapC){
var halveHeight=!lib.twoColumns;var divW=lib.panelDiv.width();if(lib.twoColumns){var uW=950;}else{uW=3000;}
var snaps=lib.snaps;var snapD=snapC.snapD;var o=snapD.myIndex;var prevThumb=snapC.prevThumb;var prevNextWidth=lib.prevNextWidth;if(!lib.twoColumns){prevNextWidth=2*prevNextWidth;var availWidthForSnap=uW-2*prevNextWidth-400;}else{var availWidthForSnap=uW-2*prevNextWidth-200;}
var rs={};var snapW=lib.snapWidth(snapD);var snapH=lib.snapHeight;var snapDH=0;if(snapW>availWidthForSnap){var snapH=snapH*availWidthForSnap/snapW;var snapDH=lib.snapHeight-snapH; idv.util.log("snapW",snapW);snapW=availWidthForSnap;}
var snapLeft=(0.5*(uW-snapW));var asnapTop=lib.snapTop+0.5*snapDH;var snapCenterY=asnapTop+0.5*snapH;var snapExtent=new geom.Point(snapW,snapH);var snapCorner=new geom.Point(snapLeft,asnapTop);rs.snap=new geom.Rect(snapCorner,snapExtent);var thumbH=lib.snapThumbHeight;var athumbTop=snapCenterY-0.5*thumbH;if(prevThumb){var prevSnapC=snaps[o-1];var prevSnapD=prevSnapC.snapD;var thumbW=lib.thumbWidth(prevSnapD);if(thumbW<lib.snapThumbMinWidth){thumbH=thumbH*(lib.snapThumbMinWidth/thumbW);thumbW=lib.snapThumbMinWidth;util.log("thumbH",lib.snapThumbMinWidth/thumbW,thumbH);}
if(thumbW>prevNextWidth){thumbH=thumbH*prevNextWidth/thumbW;thumbW=prevNextWidth;}
var prevExtent=new geom.Point(thumbW,thumbH);var prevCorner=new geom.Point(10,athumbTop);rs.prev=new geom.Rect(prevCorner,prevExtent);}
var nextThumb=snapC.nextThumb;var nextAreaWidth=0;if(nextThumb){var nextSnapC=snaps[o+1];var nextSnapD=nextSnapC.snapD;var thumbW=lib.thumbWidth(nextSnapD);var thumbH=lib.snapThumbHeight;var thumbW=lib.thumbWidth(nextSnapD);idv.util.log("snapW","thumbW",thumbW,prevNextWidth)
if(thumbW>prevNextWidth){thumbH=thumbH*prevNextWidth/thumbW;thumbW=prevNextWidth;}
var thumbLeft=uW-thumbW-30;var nextExtent=new geom.Point(thumbW,thumbH);var nextCorner=new geom.Point(thumbLeft,athumbTop);rs.nxt=new geom.Rect(nextCorner,nextExtent);}
return rs;}
lib.rectToCss=function(r,sc){if(!sc)sc=1;var c=r.corner;var xt=r.extent;return{"positions":"absolute","left":sc*c.x,"top":sc*c.y,"width":sc*xt.x,"height":sc*xt.y}}
lib.positionPic=function(picElement,container,rect,sc){if(!sc)sc=1;var c=rect.corner;var xt=rect.extent;picElement.css({width:sc*xt.x,height:sc*xt.y});idv.util.log("snapW","actual",xt.x,sc*xt.x);var css={position:"absolute","top":sc*c.y,left:sc*c.x,width:sc*xt.x};container.css(css);picElement.show();}
lib.mainImage=function(snap){if(snap.bigImageLoaded){return snap.bigImg;}else{return snap.element;}}
lib.showMainImage=function(snap){if(snap.bigImageLoaded){util.tlog("SHOWING BIG IMG FOR ",snap.snapD.topic);snap.element.hide();snap.bigImg.show();var rs=snap.bigImg;}else{util.tlog("SHOWING SMALL IMG FOR ",snap.snapD.topic);rs=snap.element;snap.element.show();snap.bigImg.hide();}
return rs;}
lib.positionSelectedSnapElements=function(snapC){var sc=lib.scale;if(lib.twoColumns){var uW=950;}else{uW=3000;sc=0.333333*sc;}
var mainImg=lib.showMainImage(snapC);var positions=lib.positionsForSelectedSnapElements(snapC);var divW=lib.panelDiv.width();var snaps=lib.snaps;var snapD=snapC.snapD;var o=snapD.myIndex;var prevp=positions.prev;if(prevp){var prevThumb=snapC.prevThumb;lib.positionPic(prevThumb,$("#selectedSnapPrev"),prevp,sc);}
var nextp=positions.nxt;if(nextp){var nextThumb=snapC.nextThumb;lib.positionPic(nextThumb,$("#selectedSnapNext"),nextp,sc);} 
var snapp=positions.snap;lib.positionPic(mainImg,$('#selectedSnap'),snapp,sc);idv.util.log("snaparray","SNAPP",snapp);var dW=sc*uW*0.6; var dLeft=sc*uW*0.2; var dsTop=sc*(snapp.extent.y+snapp.corner.y)+$('.selectedSnapImages').position().top;util.log("snaparray","CORNER",snapp.corner.y);var capht=$("#selectedSnapCaption").height();var capTop=sc*(snapp.corner.y)+$('.selectedSnapImages').position().top-15-capht; util.log("snaparray","DSTOP",dsTop);$('#selectedSnapCaption').css({left:dLeft-10,top:capTop,width:dW,"text-align":"center"});$('#selectedSnapDescription').css({left:dLeft-10,top:dsTop,width:dW,"text-align":"center"});if(snapD.description){var dht=$("#selectedSnapDescription").height();}else{dht=0;}
util.log("dht",dht);if(!lib.twoColumns){var ht=lib.theLayout.panelCss.height;lib.setPanelDivHeight(ht+dht);}}
lib.positionMainImg=function(snapC){var sc=lib.scale;if(lib.twoColumns){var uW=950;}else{uW=3000;sc=0.333333*sc;}
var mainImg=lib.showMainImage(snapC);var positions=lib.positionsForSelectedSnapElements(snapC); var snapp=positions.snap;lib.positionPic(mainImg,$('#selectedSnap'),snapp,sc);} 
lib.interpolateSnapElements=function(snapC,direction,v){var sc=lib.scale;if(!lib.twoColumns)sc=0.5*sc;var snapD=snapC.snapD;var o=snapD.myIndex;var snaps=lib.snaps;if(o>=snaps.length-1)return;var nsnap=snaps[o+1]; var nsnapC=lib.buildSelectedSnap(nsnap.snapD.topic,true);
var p0=lib.positionsForSelectedSnapElements(snapC);var p1=lib.positionsForSelectedSnapElements(nsnapC);var nxtDest=p1.snap; var nxtStart=p0.nxt;var nxtNow=nxtStart.interpolate(nxtDest,v);var nextThumb=snapC.nextThumb;lib.positionPic(nextThumb,$("#selectedSnapNext"),nxtNow,sc);var snapDest=p1.prev;var snapStart=p0.snap;var snapNow=snapStart.interpolate(snapDest,v);lib.positionPic(snapC.element,$('#selectedSnap'),snapNow,sc);}
lib.buildInterpolators=function(snapC,direction){var rs=[];var snapD=snapC.snapD;var o=snapD.myIndex;var snaps=lib.snaps;var numSnaps=snaps.length; if(direction==1){if(o>=numSnaps-1)return;var isFirstSnap=o==0;var nsnap=snaps[o+1]; var nsnapC=lib.buildSelectedSnap(nsnap.snapD.topic,true);
var p0=lib.positionsForSelectedSnapElements(snapC);var p1=lib.positionsForSelectedSnapElements(nsnapC);if(!isFirstSnap){var prevDest=new geom.Rect(p0.prev.center(),new geom.Point(1,1));var prevStart=p0.prev;var prevThumb=snapC.prevThumb;var intr={startRect:prevStart,destRect:prevDest,pic:prevThumb,container:$("#selectedSnapPrev")};rs.push(intr);}
var snapDest=p1.prev;var snapStart=p0.snap;intr={startRect:snapStart,destRect:snapDest,pic:snapC.element,container:$("#selectedSnap")};rs.push(intr);var nxtDest=p1.snap; var nxtStart=p0.nxt;var nextThumb=snapC.nextThumb;var intr={startRect:nxtStart,destRect:nxtDest,pic:nextThumb,container:$("#selectedSnapNext")};rs.push(intr);var cv0=snapD.coverage;var cv1=nsnapC.snapD.coverage;intr={startRect:cv0,destRect:cv1,drawRect:true}
rs.push(intr);return rs;}else{if(o==0)return;var isLastSnap=o==numSnaps-1;var nsnap=snaps[o-1]; var nsnapC=lib.buildSelectedSnap(nsnap.snapD.topic,true);
var p0=lib.positionsForSelectedSnapElements(snapC);var p1=lib.positionsForSelectedSnapElements(nsnapC);if(!isLastSnap){ var nextDest=new geom.Rect(p0.nxt.center(),new geom.Point(1,1));var nextStart=p0.nxt;var nextThumb=snapC.nextThumb;var intr={startRect:nextStart,destRect:nextDest,pic:nextThumb,container:$("#selectedSnapNext")};rs.push(intr);}
var snapCDest=p1.nxt; var snapCStart=p0.snap;intr={startRect:snapCStart,destRect:snapCDest,pic:snapC.element,container:$("#selectedSnap")};rs.push(intr);var nsnapCDest=p1.snap; var nsnapCStart=p0.prev; var prevThumb=snapC.prevThumb;intr={startRect:nsnapCStart,destRect:nsnapCDest,pic:prevThumb,container:$("#selectedSnapPrev")};rs.push(intr);var cv0=snapD.coverage;var cv1=nsnapC.snapD.coverage;intr={startRect:cv0,destRect:cv1,drawRect:true}
rs.push(intr);return rs;}}
lib.evalInterpolators=function(interpolators,v){var sc=lib.scale;if(!lib.twoColumns)sc=0.3333*sc;var ln=interpolators.length;for(var i=0;i<ln;i++){var intr=interpolators[i];var st=intr.startRect;var dst=intr.destRect;var cp=st.interpolate(dst,v);if(intr.drawRect){var vp=lib.vp;lib.drawOneRect(cp,"yellow",1);}else{var pic=intr.pic;var container=intr.container;lib.positionPic(pic,container,cp,sc);}}}
lib.snapAnimateIncrement=0.2;lib.snapAnimateDelay=30;lib.animateSnapTransition=function(interpolators,v,whenDone){if(v>=1){v=1;}
lib.evalInterpolators(interpolators,v);if(v<1){setTimeout(function(){lib.animateSnapTransition(interpolators,v+lib.snapAnimateIncrement,whenDone);util.slog("ANIMATE ",v);},lib.snapAnimateDelay);}else{util.slog("ANIMATE DONE");whenDone();}} 
lib.toNextOrPrevSnap=function(direction){var snaps=lib.snaps;var selsnap=lib.selectedSnap;var snapD=selsnap.snapD;var o=snapD.myIndex;if(direction==1){if(o>=snaps.length-1)return;$('#selectedSnapPrevLabel').css("color","black");}else{if(o==0)return;$('#selectedSnapNextLabel').css("color","black");}
lib.vp.setZoom(1);lib.setSelectedSnaps([],lib.stdSnapAdvice());var ints=lib.buildInterpolators(selsnap,direction); selsnap.bigImg.hide();lib.animateSnapTransition(ints,0,function(){var nsnap=snaps[o+direction].snapD;lib.setSelectedSnap(undefined);lib.hideSelectedSnap(selsnap);lib.showSelectedSnap(nsnap);lib.setSelectedSnap(snaps[o+direction]);$('#selectedSnapPrevLabel').css("color","white");$('#selectedSnapNextLabel').css("color","white");});}
lib.toPrevSnap=function(){lib.toNextOrPrevSnap(-1);return;}
lib.toNextSnap=function(){lib.toNextOrPrevSnap(1);return;}
lib.itest=function(v){var snapC=lib.selectedSnap;var ints=lib.buildInterpolators(snapC,1);lib.animateSnapTransition(ints,0);} 
lib.loadSelectedSnapBigImage=function(ss){var snapD=ss.snapD;var tp=snapD.topic;if(ss.bigImageLoadStarted)return;ss.bigImageLoadStarted=true;var ssbe=ss.bigImg;var imsrc=lib.snapDfullsize(snapD);ssbe.load(function(){ss.bigImageLoaded=true;if(lib.selectedSnap&&(ss.snapD.topic==lib.selectedSnap.snapD.topic)){util.slog("POSITIONED BIG IMAGE");ss.element.hide();lib.positionMainImg(ss);ssbe.show();}else{ssbe.hide();}});ssbe.attr("src",imsrc);}
lib.fixNextToLastSelectedSnap=function(){var ln=lib.snaps.length;if(ln<2)return;var assn=lib.allSelectedSnaps;if(!assn)return;var lastSnapD=lib.snaps[ln-1].snapD;var nextToLastSnapD=lib.snaps[ln-2].snapD;var ntlSelSnap=lib.allSelectedSnaps[nextToLastSnapD.topic];if(!ntlSelSnap)return;if(ntlSelSnap.nextThumb)return; var nextThumb=lib.buildNextThumb(ln-2);ntlSelSnap.nextThumb=nextThumb;}
lib.buildNextThumb=function(idx){var next=$('#selectedSnapNext');var nextSnapC=lib.snaps[idx+1];var nextSnapD=nextSnapC.snapD;var nextThumb=$("<img class='thumb' />");next.append(nextThumb);var imsrc=lib.snapDthumb(nextSnapD);nextThumb.attr("src",imsrc);return nextThumb;} 
lib.clearSelectedSnaps=function(){$('#selectedSnapPrev').empty();$('#selectedSnapNext').empty();$('#selectedSnap').empty();lib.allSelectedSnaps={};}
lib.aTest=33;lib.buildSelectedSnap=function(tp,hide){var sso=lib.allSelectedSnaps[tp];if(sso){if(!hide){lib.loadSelectedSnapBigImage(sso);}
return sso;}
var snap=lib.snapsByTopic[tp];var o=snap.snapD.myIndex;var snapD=snap.snapD;var snaps=lib.snaps;var sln=snaps.length;var prevThumb=null;var nextThumb=null;var prev=$('#selectedSnapPrev');var next=$('#selectedSnapNext');if(o>0){var prevSnapC=snaps[o-1];var prevSnapD=prevSnapC.snapD;var prevThumb=$("<img draggable='false' class='thumb' />");prev.append(prevThumb);var imsrc=lib.snapDthumb(prevSnapD);prevThumb.attr("src",imsrc);if(hide)prevThumb.hide();}
if(o<sln-1){var nextThumb=lib.buildNextThumb(o);if(hide)nextThumb.hide();}
var sse=$('<img id="'+tp+'"/>');var ssbe=$('<img id="/big'+tp+'"/>');
var ssic=$('#selectedSnap');var snapW=lib.snapWidth(snapD);ssic.append(sse);ssic.append(ssbe);var imsrc=lib.snapDthumb(snapD); var sso={topic:tp,element:sse,bigImg:ssbe,snap:snap,snapD:snapD,prevThumb:prevThumb,nextThumb:nextThumb};if(hide){var whenLoaded=function(imel){if(lib.selectedSnap&&(tp==lib.selectedSnap.snapD.topic)){lib.positionMainImg(sso);}else{imel.hide();}};}else{whenLoaded=undefined;}
imlib.loadImage(sse,imsrc,whenLoaded,true);if(!hide){lib.loadSelectedSnapBigImage(sso);}
lib.allSelectedSnaps[tp]=sso;return sso;}
lib.showSelectedSnap=function(snapD){if(lib.hideLinks)lib.hideLinks();lib.hideAllSelectedSnaps(); if(!snapD){lib.setSelectedSnap(undefined);$('.selectedSnapBody').hide();$('#zoomAdvice').html("No snap selected");$('#deleteSnap').hide();$('#editSnap').hide();return;}
$('.selectedSnapBody').show();$('#zoomAdvice').html("Click on central image to zoom to the snap");lib.permissionsForSelectedSnap();var xt=snapD.coverage.extent;var art=xt.y/xt.x;if(!snapD)return;var snapNum=lib.pathLast(snapD.topic);document.location.hash="snap="+snapNum; $('#selectedSnapPrev').show();var snapCount=lib.snaps.length;var isLastSnap=(snapD.myIndex)==snapCount-1;if(isLastSnap){$('#selectedSnapNext').hide();}else{$('#selectedSnapNext').show();}
if(snapD.myIndex==0){$('#selectedSnapPrev').hide();}else{$('#selectedSnapPrev').show();}
var lastSnap=lib.selectedSnap;if(snapD){lib.nowSelectedSnapD=snapD;}else{snapD=lib.nowSelectedSnapD;}
var caption=snapD.caption;var description=snapD.description;if(!caption){caption="";}
var wtdst=$('#selectedSnapCaption');wtdst.empty();wtdst.html(util.processMarkdown(caption));var ssd=$('#selectedSnapDescription');if(description){ssd.show();wtdst=$('#selectedSnapDescription');wtdst.empty();wtdst.html(util.processMarkdown(description));if(description.length<50){$('p',ssd).css("text-align","center");}else{$('p',ssd).css("text-align","left");}}else{ssd.hide();}
lib.selectPanel("selectedSnap",null,true); lib.permissionsForSelectedSnap();if(lastSnap){ lastSnap.element.hide();lastSnap.bigImg.hide();if(lastSnap.prevThumb)lastSnap.prevThumb.hide();if(lastSnap.nextThumb)lastSnap.nextThumb.hide();}
var sso=lib.buildSelectedSnap(snapD.topic);lib.setSelectedSnap(sso);lib.positionSelectedSnapElements(sso);return;}
lib.selectedSnapDiv=$('<div class="selectedSnap">'+'<div class="selectedSnapHead">'+'<div id="yesSnaps">'+'<div class="selectedSnapControls" >'+
'<div id="zoomAdvice"><i>Click on central image to zoom to the snap</i></div>'+
'<span id="editSnap" class="clickableElement">Edit This Snap</span>'+'<span id="deleteSnap" class="clickableElement">Delete This Snap</span>'+
'</div>'+'</div>'+'<div class="selectedSnapBody">'+'<div id="selectedSnapCaption"/>'+'<div class="selectedSnapImages">'+'<div id="selectedSnapPrev">'+'<div  id="selectedSnapPrevLabel" class="prevNextLabel">PREV</div>'+'<div id="prevSnapImageContainer" class="imageContainer"/>'+'</div>'+'<div id="selectedSnap">'+'<div id="loadingMsg"> loading ... <img src="/ajax-loader.gif"/></div>'+
'</div>'+'<div id="selectedSnapNext">'+'<div  id="selectedSnapNextLabel" class="prevNextLabel">NEXT</div>'+'<div id="nextSnapImageContainer" class="imageContainer"/>'+'</div>'+'<div id="selectedSnapIncoming"/>'+'<div id="selectedSnapOutgoing"/>'+'</div>'+'<div id="selectedSnapDescription"/>'+'</div>'+'</div>'+'</div>');lib.permissionsForSelectedSnap=function(){if(lib.editPermissions()){$('#deleteSnap').show();$('#editSnap').show();}else{$('#deleteSnap').hide();$('#editSnap').hide();}}
lib.selectedSnapDiv.data("resizer",function(){if(lib.selectedSnap){lib.positionSelectedSnapElements(lib.selectedSnap);}});lib.selectedSnapDiv.data("initializer",function(){lib.permissionsForSelectedSnap();if(lib.snaps.length==0){$('#noSnaps').show(); $('#yesSnaps').hide();return;}else{$('#noSnaps').hide();$('#yesSnaps').show();}
if(lib.selectedSnap){lib.positionSelectedSnapElements(lib.selectedSnap);return;}
if(lib.snaps.length==0){}else{lib.showSelectedSnap(lib.snaps[0].snapD);}});lib.addSelectedSnapDiv=function(container){container.append(lib.selectedSnapDiv);$("#selectedSnapNext").css({"cursor":"pointer"});$("#selectedSnapPrev").css({"cursor":"pointer"});lib.setPanelPanel("selectedSnap",lib.selectedSnapDiv);$('#selectedSnapPrev').click(lib.toPrevSnap);$('#selectedSnapPrev').mousedown(function(event){event.preventDefault();});lib.selectedSnapNext=$('#selectedSnapNext');$('#selectedSnapNext').click(lib.toNextSnap);$('#selectedSnapNext').mousedown(function(event){event.preventDefault();});$('#editSnap').click(lib.editSnap);lib.setClickMethod($('#zoomToSnap'),lib.zoomToSelectedSnap);$('#selectedSnap').click(lib.zoomToSelectedSnap);$('#deleteSnap').click(function(){util.myConfirm("Delete","Are you sure you wish to delete this snap? There is no undo.",function(){util.closeDialog();lib.serverDeleteSnap();},function(){util.closeDialog();});});lib.selectedSnapDiv.css({width:"100%"});$('#loadingMsg').hide();}})();

(function(){var lib=page;var geom=exports.GEOM2D;var imlib=exports.IMAGE;var com=idv.common;var util=idv.util;lib.startDefArea=function(){lib.vp.clearOverlays("both");lib.vp.defAreaMode=true;lib.vp.setDisplayParamsForZoom();lib.vp.areaDefinedCallback=lib.finishDefArea;$('#cropInstructions').show();}
lib.finishDefArea=function(area,screenArea){var sxt=screenArea.extent;if((sxt.x<20)||(sxt.y<20)){lib.startDefArea(); util.myAlert("Alert","Dragged area is too small. Try zooming in, and dragging again");return;}
lib.coverageModified=true;util.log("area",area.tostring());lib.vp.defAreaMode=false;lib.vp.selectedArea=area;lib.vp.areaEditorActive=true;lib.vp.drawEdRect(area,"image","red",false);$('#cropInstructions').hide();$('#selectSnapArea').show();$('#snapFields').show();$('#submitSnap').show();$('#selectSnapArea').hide();$('#areaSelected').show();}
lib.createSnapDiv=$('<div class="createSnapDiv">'+'<div class="createSnapStep"><span>Creating New Annotation</span></div>'+'<div class="createSnapStep">Step 1: <span id="areaSelected"><i>Take snapshot: done</i></span><span id="selectSnapArea">Take snapshot</span>'+'<span id="cropInstructions">drag box over the desired region</span></div>'+'<div class="createSnapStep">Step 2: Enter caption, tags, description</div>'+'<table id="snapFields">'+'<tr><td></td><td colspan="2" id="creoleNote"><i>To include links or formatting, use <a href="http://en.wikipedia.org/wiki/Creole_(markup)">creole wikitext</a></i></td></tr>'+'<tr><td class="inputsTD">Caption</td><td><input size="60" id="snapCaption" type="text"/></td></tr>'+'<tr><td class="inputsTD">Description</td><td><textarea rows="8" cols="60" id="snapDescription"/></td></tr>'+'</table>'+'<div class="createSnapStep">3. Submit</div>'+'<div id="createSnapButtons" class="createSnapLine">'+'<span id="submitSnap" class="clickableElement">Create Snapshot</span>'+'<span id="cancelSnap" class="clickableElement">Cancel</span>'+'</div>'+'</div>');lib.creatingSnapDiv=$('<div class="creatingSnapDiv" id="creatingSnapDiv">One moment ... creating the snapshot</div>');lib.createSnapDiv.data("initializer",function(selsnap){$("#areaSelected").hide();$("#selectSnapArea").show();util.activateAnchors($('#creoleNote'));lib.preCreateSnapShowSnapsMode=lib.showSnapsMode;lib.showSnapsButton.hide();if(lib.publishButton)lib.publishButton.hide();lib.showSnapsMode=0;if(selsnap){$("#submitSnap").html("Update Snapshot");$('#snapFields').show();$("#submitSnap").show();$('.createSnapStep').hide();var snapD=selsnap.snapD;util.log("editSnap",snapD);lib.immediateZoomToSnap(snapD,2);var vp=lib.vp;vp.clearOverlays("both");var r=snapD.coverage;vp.selectedArea=r;vp.areaEditorActive=true;vp.selectedAreaModified=false;vp.drawEdRect(r,"image","red",false);
lib.editingSnap=snapD;lib.coverageModified=false;lib.setSnapFieldValues(snapD);lib.vp.addOverlay(new imlib.Overlay("editingSnap",snapD.coverage));}else{$("#submitSnap").html("Save");$('#selectSnapArea').html("Take Snapshot");$('.createSnapStep').show();lib.editingSnap=undefined;$('#snapFields').hide();$('#submitSnap').hide();$('#snapCaption').attr('value',"");$('#snapDescription').attr('value',"");lib.startDefArea();}});lib.createSnapFieldValues=function(){var rs={};rs.caption=$('#snapCaption').attr("value");rs.description=$('#snapDescription').attr("value");return rs;}
lib.setSnapFieldValues=function(vls){$('#snapCaption').attr("value",vls.caption);$('#snapDescription').attr("value",vls.description);}
lib.grabTheSnap=function(){lib.vp.clearOverlays("both");lib.selectPanel("creatingSnap");var sdata=lib.createSnapFieldValues();var data={album:lib.albumTopic,caption:sdata.caption,description:sdata.description};data.image=lib.imD.topic;if(lib.editingSnap){var url="/api/editSnap";var snapD=lib.editingSnap;data.topic=snapD.topic;data.cropid=snapD.cropid;if(lib.vp.selectedAreaModified){data.newCrop=1
var newCoverage=lib.vp.selectedArea;data.coverage=newCoverage.externalize();snapD.coverage=newCoverage;}else{data.coverage=snapD.coverage.externalize();data.newCrop=0}}else{var url="/api/addSnap";data.coverage=lib.vp.selectedArea.externalize();data.newCrop=0}
lib.vp.deactivateAreaEditor();util.log("api","coverage ",data.coverage);var cb=lib.snapCallback;util.post(url,data,function(rs){util.log("api","data returned",rs);lib.exitCreateSnap();if(rs.status!="ok"){util.logout();location.href="/timeout"
return;}
cb(rs);},"json");util.log("api","uuuuu");}
lib.exitCreateSnap=function(){lib.showSnapsButton.show();if(lib.publishButton)lib.publishButton.show();lib.vp.defAreaMode=false;lib.vp.deactivateAreaEditor();lib.vp.selectedArea=undefined;lib.showSnapsMode=lib.preCreateSnapShowSnapsMode;if(lib.showSnapsMode){lib.redisplaySnaps();}}
lib.cancelTheSnap=function(){lib.exitCreateSnap();lib.selectPanel(lib.lastPanel);}
lib.deleteSnap=function(snap){var nsnaps=util.removeFromArray(lib.snaps,snap);snap.container.remove();var ln=nsnaps.length;lib.snapsActive=ln;var nsnapDs=[];for(var i=0;i<ln;i++){var cs=nsnaps[i].snapD;cs.myIndex=i;nsnapDs.push(cs);}
lib.snapDs=nsnapDs;lib.snaps=nsnaps;lib.selectPanel("snapArray");lib.clearSelectedSnaps();if(lib.showSnapsMode)lib.redisplaySnaps();}
lib.serverDeleteSnap=function(){var url="/api/deleteSnap";var snap=lib.selectedSnap.snapD.topic;var data={"topic":snap};util.post(url,data,function(rs){util.log("api","data returned",rs);if(rs.status!="ok"){util.logout();location.href="/timeout"
return;}
lib.deleteSnap(lib.selectedSnap.snap);},"json");}
lib.addCreateSnapDiv=function(container){container.append(lib.createSnapDiv);container.append(lib.creatingSnapDiv);lib.setPanelPanel("createSnap",lib.createSnapDiv);lib.setPanelPanel("creatingSnap",lib.creatingSnapDiv);lib.createSnapDiv.hide();lib.selectSnapArea=$('#selectSnapArea');lib.setClickMethod($('#submitSnap'),lib.grabTheSnap);lib.setClickMethod($('#submitAlbum'),lib.createTheAlbum);lib.setClickMethod($('#cancelSnap'),lib.cancelTheSnap);}})();
(function(){var lib=page;var geom=exports.GEOM2D;var imlib=exports.IMAGE;var com=idv.common;var util=idv.util;lib.imageDetailsWd=400;lib.imageDetailsDiv=$('<div class="imageDetailsDiv">'+'<div id="title"></div>'+'<div id="description"></div>'+'<table id="imageFields">'+'<tr id="authorRow"><td  class="rowTitle">Artist/Photographer:</td><td class="rowValue"><span style="width:'+lib.imageDetailsWd+'px" id="author"/></td></tr>'+'<tr  id="yearRow"><td  class="rowTitle">Year:</td><td class="rowValue"><span style="width:'+lib.imageDetailsWd+'px" id="year"/></td></tr>'+'<tr  id="tagsRow"><td  class="rowTitle">Tags:</td><td class="rowValue"><span style="width:'+lib.imageDetailsWd+'px" id="tags"/></td></tr>'+'<tr id="externalLinkRow" ><td class="rowTitle">External Link:</td><td class="rowValue"><span style="width:'+lib.imageDetailsWd+'px" id="externalLink"/></td></tr>'+'<tr id="contributorRow" ><td class="rowTitle">Contributed by:</td><td class="rowValue"><span style="width:'+lib.imageDetailsWd+'px" id="contributor"/></td></tr>'+'<tr class="dimensionRow"><td class="rowTitle">Dimensions:</td><td class="rowValue"><span style="width:'+lib.imageDetailsWd+'px" id="dimensions"/></td></tr>'+'<tr><td class="rowTitle">Source</td><td><div style="width:'+lib.imageDetailsWd+'px;;word-wrap:break-word" id="imageSource"></div></td></tr>'+'<tr id="licenseRow" ><td class="rowTitle">License:</td><td class="rowValue"><span style="width:'+lib.imageDetailsWd+'px" id="license"/></td></tr>'+'<tr class="albumTitleRow"><td class="rowTitle">Album title:</td><td class="rowValue"><span style="width:'+lib.imageDetailsWd+'px" id="albumTitle"/></td></tr>'+'<tr class="albumDescriptionRow"><td class="rowTitle">Album Description:</td></tr>'+
'</table>'+'<div id="albumDescription"></div>'+'<div id="buttons"><span id="editButton" class="clickableElement">Edit</span></div>'+'</div>');lib.computeAboutText=function(){var imD=lib.imD;var imd=""
if(imD.title){imd+="{{{"+imD.title+"}}}";}
if(imD.author){imd+=" by "+imD.author}
imd+="\n\n"
var ds=imD.description;if(ds){imd+=ds}
return imd;}
lib.popImageDetails=function(){lib.lightbox.pop();lib.lightbox.element.empty();lib.lightbox.addClose();function adjustLightBoxHeight(){var ht=lib.imageDetailsDiv.height();var lbh=lib.lightbox.element.height();lib.lightbox.element.css({"height":(ht+40)+"px"});}
lib.imageDeleteable=function(){ var aln=lib.allAlbumDs.length;if(aln==0)return true;var imowner=lib.imD.owner;for(var i=0;i<aln;i++){var calb=lib.allAlbumDs[i];if(calb.owner!=imowner){return false;}}
return true;}
lib.lightbox.element.append(lib.imageDetailsDiv);if($.trim(lib.imD.description)){var dst=$("#description",lib.imageDetailsDiv);dst.empty();dst.css({"word-wrap":"break-word","margin-left":"20px","margin-bottom":"10px","margin-top":"10px"});dst.html(util.processMarkdown(lib.imD.description));}else{$("#descriptionRow",lib.imageDetailsDiv).hide();}
$("#title",lib.imageDetailsDiv).css({"font-weight":"bold","margin-left":"10px","margin-right":"10px","margin-top":"10px","text-align":"center"});$("#imageFields",lib.imageDetailsDiv).css({"margin-left":"10px","margin-right":"10px","margin-top":"10px"});$(".rowTitle",lib.imageDetailsDiv).css({"padding-left":"10px","padding-right":"20px"});$("tr",lib.imageDetailsDiv).css({"padding-top":"10px"});$("#albumDescription",lib.imageDetailsDiv).css({"margin-left":"50px"});$("#buttons",lib.imageDetailsDiv).css({"margin-top":"30px","margin-left":"30px"});var ttl=$.trim(lib.imD.title);if(!ttl){ttl=util.pathLast(lib.imD.topic);}
$("#titleRow",lib.imageDetailsDiv).show();$("#title",lib.imageDetailsDiv).html(util.sanitize(ttl));var ownm=lib.imD.ownerName;var cdiv=$("#contributor",lib.imageDetailsDiv);if(ownm){cdiv.show()
cdiv.html(util.sanitize(lib.imD.ownerName));}else{$('#contributorRow').hide();}
if($.trim(lib.imD.author)){$("#authorRow",lib.imageDetailsDiv).show();
$("#author",lib.imageDetailsDiv).html(util.sanitize(lib.imD.author));}else{$("#authorRow",lib.imageDetailsDiv).hide();}
if($.trim(lib.imD.year)){$("#yearRow",lib.imageDetailsDiv).show();$("#year",lib.imageDetailsDiv).html(util.sanitize(lib.imD.year));}else{$("#yearRow",lib.imageDetailsDiv).hide();}
var tags=lib.imD.tags;var tagel=$("#tags",lib.imageDetailsDiv)
if(tags&&(tags.length>0)){var tagst=tags.join(", ");tagel.html(tagst);}
var lnk=$.trim(lib.imD.externalLink);if(lnk){$("#externalLinkRow",lib.imageDetailsDiv).show();var edv=$("#externalLink",lib.imageDetailsDiv);var a=$('<a>');var sanlnk=util.sanitize(lnk);a.attr("href",lnk);a.attr("target","imagediverTarget");edv.empty();edv.append(a);a.html(sanlnk);}else{$("#externalLinkRow",lib.imageDetailsDiv).hide();}
var dim=lib.imD.dimensions;var dims=dim.x+" pixels wide by "+dim.y+" pixels high";$('#dimensions',lib.imageDetailsDiv).html(dims);var src=lib.imD.source;var srcel=$('#imageSource');srcel.css({'text-decoration':'underline','cursor':'pointer'});if(src){srcel.show();srcel.html(src);srcel.click(function(){window.open(src)});}else{srcel.hide();}
$('#imageSource').html((lib.imD.source)?(lib.imD.source):'');$('#albumTitle').html(lib.albumD.caption);var ads=lib.albumD.description;var adsel=$('#albumDescription');if(ads){adsel.show();adsel.empty();adsel.css({"word-wrap":"break-word"});adsel.html(util.processMarkdown(ads));}else{adsel.hide();}
$('p',lib.imageDetailsDiv).css({"margin":"0px"});var lic=lib.imD.license;if((!lic)||(lic=="none")){$('#licenseRow').hide();}else{$('#license').html(lib.licenseText[lic]);}
if(idv.loggedInUser&&(lib.imD.owner==idv.loggedInUser)&&(!idv.atS3)){$("#buttons",lib.imageDetailsDiv).show();$("#editButton",lib.imageDetailsDiv).click(function(){lib.popEditImageLightbox();}); $("#buttonMsg").hide();}else{$("#buttons",lib.imageDetailsDiv).hide();}
}})();

(function(){var lib=page;var geom=exports.GEOM2D;var imlib=exports.IMAGE;var com=idv.common;var util=idv.util;lib.licenseOptions=["PD-old: Public Domain where the author died more thn 100 years ago","PD-self: A statement intended to release your own work into public domain","PD-author: A statement that the work is released into the public domain by its author","cc-by-3.0: Creative Commons Attribution 3.0","cc-by-sa-3.0:Creative Commons Attribution-ShareAlike 3.0","Copyright &lt;author(above)&gt; &lt;year(above)&gt;","Other"]
lib.copyrightIndex=4;lib.licenseOptions=["No License Asserted (retain all rights)","PD-old: Public Domain where the author died more thn 100 years ago","PD-self: A statement intended to release your own work into public domain","PD-author: A statement that the work is released into the public domain by its author","cc-by-3.0: Creative Commons Attribution 3.0","cc-by-sa-3.0:Creative Commons Attribution-ShareAlike 3.0",]
lib.licenseCode=function(opt){if(!opt)return"none";var sp=opt.split(":");if(sp.length==1){return"none"}else{return sp[0];}}
lib.licenseIdx=function(cd){}
lib.genLicenseOption=function(n){return"<option style='width:200px' id='option"+n+"' value = '"+n+"'>"+lib.licenseOptions[n]+"</option>";}
lib.genLicenseOptions=function(){var rs="";var ln=lib.licenseOptions.length;lib.licenseIndices={};for(var i=0;i<ln;i++){var opt=lib.licenseOptions[i];var cd=lib.licenseCode(opt);lib.licenseIndices[cd]=i;rs+=lib.genLicenseOption(i);}
return rs;}
lib.editImageWd=450;lib.editImageDiv=$('<div class="editImageDiv">'+"<div id='editNote'>This is a shared image, imported by another user, so you can't edit its properties. Only the album title and description are available for editing.</div>"+'<table id="imageFields">'+'<tr class="forImage"><td class="inputsTD">Identifier</td><td><span id="imageID"></span></td></tr>'+'<tr class="forImage"><td class="inputsTD">Title</td><td><input style="width:'+lib.editImageWd+'px" id="imageTitle" type="text"/></td></tr>'+'<tr class="forImage"><td class="inputsTD"></td><td>To include links or other formatting in the description, use <a target="_blank" href="http://en.wikipedia.org/wiki/Creole_(markup)">creole wikitext</a></td></tr>'+'<tr class="forImage"><td class="inputsTD">Description</td><td><textarea style="width:'+lib.editImageWd+'px" rows="5"  id="imageDescription"/></td></tr>'+'<tr class="forImage"><td class="inputsTD">Artist/<br/>Photographer</td><td><input style="width:'+lib.editImageWd+'px" id="imageAuthor" type="text"/></td></tr>'+'<tr class="forImage"><td class="inputsTD">Year Created</td><td><input style="width:'+lib.editImageWd+'px" id="imageYear" type="text"/></td></tr>'+'<tr class="forImage"><td class="inputsTD">Tags</td><td><input style="width:'+lib.editImageWd+'px" id="imageTags" type="text"/></td></tr>'+'<tr class="forImage"><td class="inputsTD" id="externalLinkLabel">External Link</td><td><input style="width:'+lib.editImageWd+'px" id="imageExternalLink" type="text"/></td></tr>'+
'<tr class="forImage"><td class="inputsTD">Dimensions</td><td id="imageDimensions"></td></tr>'+
'<tr id="imageErrorRow"><td class="inputsTD">Error</td><td style="color:red" id="imageErrorMessage">restrict</td></tr>'+'</table>'+'<div class="forImage">License. (<a href="/license">About licensing</a>) </div>'+'<div class="forImage" id="licenseDiv"><select id="licenseSelect">'+lib.genLicenseOptions()+'</select></div>'+'<hr/>'+'<div id="albumNote">Properties of this album of annotations, as opposed to the image itself (optional)</div>'+'<table id="albumFields">'+'<tr><td class="inputsTD" id="albumTitleLabel">Title</td><td><input style="width:'+lib.editImageWd+'px" id="albumTitle" type="text"/></td></tr>'+'<tr><td class="inputsTD">Description</td><td><textarea style="width:'+lib.editImageWd+'px" rows="3"  id="albumDescription"/></td></tr>'+'</table>'+'<div id="editImageButtons" class="editImageLine">'+'<span id="submitImageEdit" class="clickableElement">Save</span>'+'<span id="cancelImageEdit" class="clickableElement">Cancel</span>'+'</div>'+'</div>');lib.editImageInitializer=function(){lib.canEdit=lib.imD.owner==lib.albumD.owner;
var erow=$('#imageErrorRow');erow.hide();var imD=page.imD;if(0&&lib.imageDeleteable()){ $('#publicOnlyRow').hide();var imPublic=imD.isPublic;if(imPublic){$('#publicImage').attr('checked','checked');}else{$('#privateImage').attr('checked','checked');}}else{$('#publicToggleRow').hide();}
if(lib.canEdit){var tp=imD.topic;var id=util.lastPathElement(tp);$('#imageID').html(id);var ttl=imD.title;if(imD.description)ds=imD.description;else ds="";$('#imageTitle').val(ttl);$('#albumTitle',lib.editImageDiv).val(lib.albumD.caption);$('#albumDescription',lib.editImageDiv).val(lib.albumD.description);$('#imageDescription',lib.editImageDiv).val(ds);$('#imageAuthor').val((imD.author)?(imD.author):'');$('#imageYear').val((imD.year)?(imD.year):'');$('#imageTags').val((imD.tags)?imD.tags.join(", "):'');$('#imageExternalLink').val((imD.externalLink)?(imD.externalLink):'');var dim=imD.dimensions;var dims=dim.x+" pixels wide by "+dim.y+" pixels high";$('#imageDimensions').html(dims);var lic=imD.license;var lidx=lib.licenseIndices[lic];$('#licenseSelect').attr('value',lidx);$('#editNote').hide();util.addToolTip($('#externalLinkLabel',lib.editImageDiv),"An external URL (eg a wikipedia page) associated with the album. Leave blank if not applicable");}else{$('#albumTitle',lib.editImageDiv).val(lib.albumD.caption);$('#albumDescription',lib.editImageDiv).val(lib.albumD.description);$('#editNote').css({'margin':'10px'});$('.forImage').hide();}}
lib.editImageFieldValues=function(){var rs={};rs.title=util.htmlRemove($('#imageTitle').attr("value"));rs.author=util.htmlRemove($('#imageAuthor').attr("value"));rs.description=$('#imageDescription').attr("value");rs.albumTitle=util.htmlRemove($('#albumTitle').attr("value"));
rs.albumDescription=$('#albumDescription').attr("value");rs.externalLink=$('#imageExternalLink').attr("value");rs.isPublic=(0&&lib.imageDeleteable())?(($('#publicImage').attr('checked')=='checked')?1:0):1;var slo=$('#licenseSelect').attr("value");var lo=lib.licenseOptions[slo];var lc=lib.licenseCode(lo);rs.license=lc;var yr=$('#imageYear').attr("value");if($.trim(yr)){rs.year=yr;}else{rs.year="";}
var tags=$.trim($('#imageTags').attr("value"));if(tags==""){var tagsf=[];}else{var tagsp=tags.split(",");var isErr=false;var re=/^[\w\ ]*$/;var tagsf=idv.util.arrayMap(tagsp,function(tag){var tr=$.trim(tag);if(!re.test(tr)){isErr=true;}
return tr;});if(isErr){return{"error":"Tags may include only alpha-numeric characters, digits, and spaces"};}}
rs.tags=tagsf;return rs;}
lib.editImageCallback=function(rs){var vl=rs.value;page.imD.description=vl.description;page.imD.title=vl.title;var imd=lib.computeAboutText();page.updateTopbarOptions(page.topbar.options);page.topbar.render()
lib.popImageDetails();}
lib.editTheImage=function(){if(lib.canEdit){var imD=page.imD;var sdata=lib.editImageFieldValues();var erow=$('#imageErrorRow');erow.show();if(sdata.error){var msg=$('#imageErrorMessage');msg.html(sdata.error);return;}
erow.hide();var data={image:imD.topic,albumTopic:lib.albumD.topic}
util.setProperties(data,sdata,["title","description","author","externalLink","year","isPublic","license","albumTitle","albumDescription","tags"]);util.setProperties(imD,sdata,["title","description","author","externalLink","year","license","tags"]);lib.albumD.caption=sdata.albumTitle;lib.albumD.description=sdata.albumDescription;var url="/api/editImage";var cb=lib.editImageCallback;util.post(url,data,function(rs){util.log("api","data returned",rs);if(rs.status!="ok"){util.logout();location.href="/timeout";return;}
cb(rs);},"json");util.log("api","uuuuu");}else{var sdata=lib.editImageFieldValues();var data={caption:sdata.albumTitle,description:sdata.albumDescription};data.image=lib.imD.topic;data.topic=lib.albumD.topic;var url="/api/editAlbum";util.post(url,data,function(rs){if(rs.status=="ok"){lib.albumD.caption=data.caption;lib.albumD.description=data.description;lib.updateTopbarOptions(lib.topbar.options);lib.topbar.render()
lib.popImageDetails();}else{util.logout();location.href="/timeout"
return;}});}}
lib.cancelEditImage=function(){lib.popImageDetails();}
lib.popEditImageLightbox=function(){lib.lightbox.pop();lib.lightbox.element.empty();lib.lightbox.addClose();lib.lightbox.element.append(lib.editImageDiv);$('#editImageButtons',lib.editImageDiv).css({"margin-top":"10px"});lib.editImageDiv.css({"margin-left":"10px"});var sie=$('#submitImageEdit');var cie=$('#cancelImageEdit')
sie.click(lib.editTheImage);cie.click(function(){lib.popImageDetails();});lib.editImageInitializer();}
lib.addEditImageDiv=function(container){}})();

(function(){var lib=page;var geom=exports.GEOM2D;var imlib=exports.IMAGE;var com=idv.common;var util=idv.util;lib.createAlbumWd=450;lib.createAlbumDiv=$('<div class="createlbumDiv" style="margin:20px">'+'<div id="createAlbumExplanation" style="text-align:center;margin-bottom:10px"></div>'+'<table id="albumFields">'+'<tr><td class="inputsTD">Album Title<td><td><input style="width:'+lib.createAlbumWd+'px" id="albumCaption" type="text"/></td></tr>'+'<tr><td class="inputsTD"></td><td></td><td>To include links or other formatting in the description, use <a target="_blank" href="http://en.wikipedia.org/wiki/Creole_(markup)">creole wikitext</a></td></tr>'+'<tr><td class="inputsTD">Description<td><td><textarea style="width:'+lib.createAlbumWd+'px"  rows="10" id="albumDescription"/></td></tr>'+
'</table>'+'<div id="createAlbumButtons" class="buttonLine">'+'<span id="submitAlbum" class="clickableElement">Create Album</span>'+'<span id="cancelAlbum" class="clickableElement">Cancel</span>'+'</div>'+'</div>');lib.albumDivInitializer=function(){lib.editingAlbum=false;$('#createAlbumExplanation').html('Creating a New Album');$('#albumCaption').attr("value","");$('#albumDescription').attr("value","");$('#submitAlbum').html("Create Album (and go there)");};lib.albumsDiv=$('<div class="albumsDiv">'+'<div class="albumLine" id="aboutOtherAlbums"><span id="aboutOtherAlbumsExplanation"></span><span id="otherAlbums"></span></div>'+'<div class="albumLine" id="albumExplanation">An album is a group of snapshots from an image.</div>'+'</div>'); lib.albumsHtml=function(dst,albums,thisAlbumTopic){dst.empty();var ln=albums.length;for(var i=0;i<ln;i++){var ca=albums[i];if(ca.topic==thisAlbumTopic)continue;var cc=ca.caption;var uname=ca.ownerName;if(i<ln-1)comma=",";else comma="";if(uname){var bywho=" by "+uname;}else{bywho=""}
var aline=$('<span class="albumLink"><span>'+cc+'</span> '+bywho+comma+' </span>');dst.append(aline);(function(tp){ aline.click(function(){util.navigateToPage(util.publishedUrl(tp));});})(ca.topic);}}
lib.albumsDiv.data("initializer",function(){var albums=lib.albumDs;var ln=albums.length;var album=lib.albumD;if(album){$('#albumOwner').html("The owner of this album is: "+lib.pathLast(album.owner));var atp=album.topic;if(ln==1){$('#aboutOtherAlbumsExplantion').html('Published Album:');}else{$('#aboutOtherAlbumsExplanation').html('Other published albums for this image:');}}else{atp="";if(ln==0){$('#aboutOtherAlbumsExplanation').html('There are no public albums associated with this image.');}else{$('#aboutOtherAlbumsExplanation').html('Published albums:');}}
var oae=$('#otherAlbums');oae.empty();lib.albumsHtml(oae,albums,atp);});lib.deleteAlbumDiv=$('<div id="deleteAlbum">'+'<div class="areYouSure">Are you sure you wish to delete this album, and its snapshots? There is no undo.</div>'+'<div>'+'<span  style="margin-left:20px" id="yesDeleteAlbum" class="clickableElement">Yes, Delete</span>'+'<span   id="noDontDeleteAlbum" style="margin-left:30px"  class="clickableElement">Cancel</span>'+'</div>'+'</div>');lib.createAlbumFieldValues=function(){var rs={};rs.caption=$('#albumCaption').attr("value");var ds=$('#albumDescription').attr("value");rs.description=ds;return rs;}
lib.createOrEditAlbum=function(edit,imTopic){if(!imTopic)imTopic=lib.imD.topic;var sdata=lib.createAlbumFieldValues();var data={caption:sdata.caption,description:sdata.description};data.image=imTopic;if(edit){var url="/api/editAlbum";data.topic=lib.albumD.topic;}else{var url="/api/addAlbum";}
var cb=lib.createAlbumCallback;var a=lib.albumD;util.post(url,data,function(rs){util.log("api","data returned",rs);if(rs.status!="ok"){util.logout();location.href="/timeout"
return;}
if(edit){var vl=rs.value;util.setProperties(a,vl,["description","caption"]);lib.updateTopbarOptions(lib.topbar.options);lib.topbar.render();lib.popAlbumDetails();}else{location.href="/topic"+rs.value.topic;}
},"json");util.log("api","uuuuu");} 
lib.deleteTheAlbum=function(){var data={topic:lib.albumD.topic};var url="/api/deleteAlbum";var imtp=lib.albumD.image.topic;util.post(url,data,function(rs){if(rs.status!="ok"){util.logout();location.href="/timeout";return;}
location.href="/mywork";},"json");util.log("api","uuuuu");}
lib.createTheAlbum=function(imTopic){lib.createOrEditAlbum(false,imTopic);}
lib.editTheAlbum=function(){lib.createOrEditAlbum(true);}
lib.popCreateAlbumLightbox=function(imTopic){lib.lightbox.pop(false,350);lib.lightbox.element.empty();lib.lightbox.addClose();lib.lightbox.element.append(lib.createAlbumDiv);lib.editingAlbum=true;$('#submitAlbum').click(function(){lib.createTheAlbum(imTopic);});$('#cancelAlbum').click(function(){lib.lightbox.dismiss();});return;}
lib.addAlbumsDiv=function(container){container.append(lib.albumsDiv);lib.setPanelPanel("albums",lib.albumsDiv);return;}
lib.popEditAlbumLightbox=function(){lib.lightbox.pop();lib.lightbox.element.empty();lib.lightbox.addClose();lib.lightbox.element.append(lib.editAlbumDiv);$('#submitAlbum',lib.editAlbumDiv).click(function(){lib.editTheAlbum();});$('#cancelAlbum',lib.editAlbumDiv).click(function(){lib.popAlbumDetails();});lib.editAlbumInitializer(false);return;}})();
(function(){var lib=page;var geom=exports.GEOM2D;var imlib=exports.IMAGE;var com=idv.common;var util=idv.util;lib.aboutImageDiv=$('<div id="aboutImage"></div>');lib.aboutImageDiv.data("initializer",function(){var albumD=lib.albumD;if(albumD){var d=albumD.description;}else{var imD=lib.imD;d=imD.description;}
if(!d){if(albumD){imD=lib.imD;d=imD.description;}}
if(!d){d="No description yet";}
$('#aboutImage').html(d);var ht=$("#aboutImage").height();var dht=lib.defaultPanelHeight();var aht=Math.max(ht,dht);});lib.addAboutImageDiv=function(container){container.append(lib.aboutImageDiv);var pn=lib.setPanelPanel("aboutImage",lib.aboutImageDiv);pn.selfScaling=true;}})();
(function(){var lib=page;var geom=exports.GEOM2D;var imlib=exports.IMAGE;var util=idv.util;idv.css.link={"text-decoration":"underline","cursor":"pointer"}
idv.pageKind="album";lib.includeShare=false;lib.Markdown;lib.albumDetailsWd=200;lib.albumDetailsDiv=$('<div class="albumDetailsDiv">'+'<div id="title"></div>'+'<div id="description" style="word-wrap:break-word"></div>'+'<table id="albumFields">'+'<tr  id="authorRow"><td  class="rowTitle">Image By:</td><td class="rowValue"><span style="width:'+lib.albumDetailsWd+'px" id="author"/></td></tr>'+'<tr  id="yearRow" ><td class="rowTitle">Year:</td><td class="rowValue"><span style="width:'+lib.albumDetailsWd+'px" id="year"/></td></tr>'+'<tr id="externalLinkRow"><td  class="rowTitle">External Link:</td><td class="rowValue"><span style="width:'+lib.imageDetailsWd+'px" id="externalLink"/></td></tr>'+'<tr id="contributorRow"><td  class="rowTitle">Album created by:</td><td class="rowValue"><span style="width:'+lib.imageDetailsWd+'px" id="contributor"/></td></tr>'+'</table>'+
'<div id="jsonRow"><a target="_blank" id="json">JSON</a></div>'+'<div id="docs"><span id="albumsWhat">about albums</span><span id="jsonWhat">about JSON</span></div>'+"<div id='aboutJSON'>"+idv.common.closeX+"<p>The JSON link above resolves to a machine-readable encoding of the contents of this album, in the "+'<a target="_blank" href="http://json.org">JSON format</a>. The form of the data should be '+"should be self-explanatory to those familiar with JSON, except for one detail. The encoding of the area covered by  a snap looks like this: </p> "+'<table id="jsonTable"><tr><td>{"coverage": </td><td>{"corner": {"x": 0.25, "y": 0.5},</td><tr><tr><td></td><td>"extent": {"x": 0.01, "y": 0.02}}</td></tr></table></p> '+'<p>The x and y values are normalized to the '+'width of the image. So, in this example, if the image is 1000 pixels wide,  the upper left corner of the snap is at pixel coordinates (250,500), its width '+' is 10 pixels, and its height is 20 pixels.</p>'+'</div>'+"<div id='aboutAlbums'>"+idv.common.closeX+"<p>Each image may have many albums associated with it, each with  a different set of snap shots, and a different author. There is "+"an ImageDiver page for each album (this is one such page).  Each image also has its own page, linked to from the top bar.</p>"+"</div>"+'<div id="buttons"><span id="editButton" class="clickableElement">Edit Album Properties</span><span id="deleteButton" class="clickableElement">Delete the Album</span></div>'+'</div>');lib.albumsHtml=function(dst,albums,thisAlbumTopic){dst.empty();var ln=albums.length;for(var i=0;i<ln;i++){var ca=albums[i];if(ca.topic==thisAlbumTopic)continue;var cc=ca.caption;var uname=lib.pathLast(lib.pathLast(ca.owner));if(i<ln-1)comma=",";else comma="";var aline=$('<span class="albumLink"><span>'+cc+'</span> by '+uname+comma+' </span>');dst.append(aline);(function(tp){ aline.click(function(){util.navigateToPage("/topic"+tp+"/index.html");});})(ca.topic);}}
lib.lightboxMessage=function(msg){lib.lightbox.pop();lib.lightbox.element.empty();lib.lightbox.addClose();msgdiv=$('<div/>');msgdiv.css({'text-align':'center','margin-top':'30px'})
msgdiv.html(msg);lib.lightbox.element.append(msgdiv);}
lib.popAlbumDetails=function(){obsolete(); lib.lightbox.pop();lib.lightbox.element.empty();lib.lightbox.addClose();lib.lightbox.element.append(lib.albumDetailsDiv);if($.trim(lib.imD.description)){var dst=$("#description",lib.albumDetailsDiv);dst.empty();dst.html(util.processMarkdown(lib.imD.description));}else{$("#descriptionRow",lib.albumDetailsDiv).hide();}
$("#title",lib.albumDetailsDiv).css({"font-weight":"bold","margin-left":"10px","margin-right":"10px","margin-top":"10px","text-align":"center"});$("#albumFields",lib.albumDetailsDiv).css({"margin-left":"10px","margin-right":"10px","margin-top":"10px"});$(".rowTitle",lib.albumDetailsDiv).css({"padding-left":"10px","padding-right":"20px"});$("td",lib.albumDetailsDiv).css({"padding-top":"10px"});$("#jsonRow",lib.albumDetailsDiv).css({"padding":"20px"});$("#aboutJSON",lib.albumDetailsDiv).css({"display":"none","border":"solid thin white","margin":"20px"});$("#aboutAlbums",lib.albumDetailsDiv).css({"display":"none","border":"solid thin white","margin":"20px"});$("#jsonTable",lib.albumDetailsDiv).css({"padding-left":"30px"});$("#docs",lib.albumDetailsDiv).css({"cursor":"pointer","text-decoration":"underline","font-size":"8pt","padding-left":"20px"});$("#jsonWhat",lib.albumDetailsDiv).css({"margin-left":"30px"});$("#buttons",lib.albumDetailsDiv).css({"margin":"30px"});var ttl=lib.genFullTitle();$("#titleRow",lib.albumDetailsDiv).show();$("#title",lib.albumDetailsDiv).html(util.sanitize(ttl)); 
var desc=$.trim(lib.albumD.description);if(!desc){var desc=$.trim(lib.imD.description);}
if(desc){$("#descriptionRow",lib.albumDetailsDiv).show();var dst=$("#description",lib.albumDetailsDiv);dst.empty();dst.html(util.processMarkdown(desc));}else{$("#descriptionRow",lib.albumDetailsDiv).hide();}
if($.trim(lib.imD.author)){$("#authorRow",lib.albumDetailsDiv).show();$("#author",lib.albumDetailsDiv).html(util.sanitize(lib.imD.author));}else{$("#authorRow",lib.albumDetailsDiv).hide();}
if($.trim(lib.imD.year)){$("#yearRow",lib.albumDetailsDiv).show();$("#year",lib.albumDetailsDiv).html(util.sanitize(lib.imD.year));}else{$("#yearRow",lib.albumDetailsDiv).hide();}
var lnk=$.trim(lib.albumD.externalLink);if(!lnk){var lnk=$.trim(lib.imD.externalLink);}
if(lnk){$("#externalLinkRow",lib.albumDetailsDiv).show();var edv=$("#externalLink",lib.albumDetailsDiv);var a=$('<a>');var sanlnk=util.sanitize(lnk);a.attr("href",lnk);a.attr("target","imagediverTarget");a.html(sanlnk);edv.empty();edv.append(a);}else{$("#externalLinkRow",lib.albumDetailsDiv).hide();}
var ownm=lib.albumD.ownerName;var cdiv=$("#contributor",lib.albumDetailsDiv);if(ownm){cdiv.show()
cdiv.html(util.sanitize(lib.albumD.ownerName));}else{cdiv.hide();}
var json=util.jsonUrl(lib.albumD.topic);$('#json').attr('href',json);function adjustLightBoxHeight(){return; var ht=lib.albumDetailsDiv.height();var lbh=lib.lightbox.element.height();lib.lightbox.element.css({"height":(ht+40)+"px"});}
$("#jsonWhat",lib.albumDetailsDiv).click(function(){$("#aboutAlbums").hide();$("#aboutJSON").show();adjustLightBoxHeight();});$("#albumsWhat",lib.albumDetailsDiv).click(function(){$("#aboutJSON").hide();$("#aboutAlbums").show();adjustLightBoxHeight();});$(".closeX",lib.albumDetailsDiv).click(function(){$("#aboutJSON").hide();$("#aboutAlbums").hide();;adjustLightBoxHeight();});if(lib.published){$('#editButton').hide();$('#deleteButton').hide();}else{$("#editButton",lib.albumDetailsDiv).click(function(){lib.popEditAlbumLightbox();});$("#deleteButton",lib.albumDetailsDiv).click(function(){lib.lightbox.tempDismiss();util.myConfirm("Delete Album","Are you sure you wish to delete this album, and all of its snaps?",function(){lib.deleteTheAlbum();},function(){util.closeDialog();lib.lightbox.bringBack();});});}
if(idv.loggedInUser&&(lib.albumD.owner==idv.loggedInUser)){$("#buttons",lib.albumDetailsDiv).show();}else{$("#buttons",lib.albumDetailsDiv).hide();}
adjustLightBoxHeight();}
lib.facebookLikeButton=function(topic,width,height){ var url="http://s3.imagediver.org/topic"+topic+"/index.html";var qs="href="+encodeURI(url)+"&send=false&layout=button_count&width="+width+"&height="+height+"&action=like&colorscheme=light&appId=252341458175463"
var rs='<iframe src="//www.facebook.com/plugins/like.php?'+qs+'" scrolling="no" frameborder="0" style="padding-left:15px;display:inline-block;border:none;overflow:hidden;width:'+width+'px;height:'+height+'px"'+' allowTransparency="true"></iframe>';return rs;}
lib.setSelectedSnapCallbacks.push(function(){return;if(lib.selectedSnap){lib.zoomToSnap.show();}else{lib.zoomToSnap.hide();}});lib.stdSnapAdvice=function(){if(lib.showSnapsMode){return"click within outline for detail, doubleclick to zoom there";}else{if(lib.selectedSnap){return"double click to zoom to the selected snap";}else{return"";}}}
lib.renderZoomControl=function(container){var cnt=container;var setZoom=function(z){lib.vp.setZoom(z);};var getZoom=function(){return lib.vp.zoom;};var zmropts={container:cnt,maxZoom:lib.vp.maxZoom,setZoom:setZoom,getZoom:getZoom,zoomIncrement:1.05,zoomFactor:2,zoomDelay:50};var zmr=new idv.zoomSlider(zmropts);lib.zSlider=zmr;lib.vp.zoomCallbacks.push(function(z){lib.zSlider.positionSliderFromZoom(z);});var otherButtons=$('<span></span>');otherButtons.css({left:lib.zSlider.totalWidth+20,top:15,position:"absolute"});cnt.append(otherButtons);var viewAll=$('<span class="clickableElement">view all</span>');viewAll.css({"margin-right":"10px"});otherButtons.append(viewAll);viewAll.click(function(){if(lib.vp.zoom==1){lib.computeSnapVisibility();}else{lib.vp.setZoom(1);}
if(lib.currentPanel.name=="snapArray"){lib.selectClickable(lib.snapArrayButton);}});var showSnaps=$('<span class="clickableElement">show outlines</span>');showSnaps.css("font-size","9pt");lib.showSnapsButton=showSnaps;otherButtons.append(showSnaps);showSnaps.click(function(){if(lib.showSnapsMode){lib.exitShowSnapsMode();}else{lib.enterShowSnapsMode();}});var snapAdvice=$('<span></span>');snapAdvice.html(lib.stdSnapAdvice());snapAdvice.css({left:lib.zSlider.totalWidth,top:45,position:"absolute"})
lib.snapAdvice=snapAdvice;cnt.append(snapAdvice);var gap=$('<div class="gap"></div>');container.append(gap);}
lib.embedText=function(wd){var topic=lib.albumD.topic;var url=" http://s3.imagediver.org/widget.js?album="; if(wd>=700){var ht=Math.round(wd*0.666);var url="http://s3.imagediver.org/topic"+topic+"/index.html?embed=true";var rs='<iframe src = "'+url+'" width="'+wd+'" height="'+ht+'"></iframe>';}else{var tps=topic.split("/");url+=tps[2]+"."+tps[3]+"."+tps[4]+"&width="+wd;var rs='<script type="text/javascript" src="'+url+'"></script>'}
var ers=util.htmlEscape(rs);return ers;}
lib.tweetButtonText='<a href="https://twitter.com/share" class="twitter-share-button" data-via="imagediver">Tweet</a>'+'<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>';lib.editPermissions=function(){return(idv.loggedInUser==lib.albumD.owner)&&(!lib.published)&&(!idv.embed);}
lib.renderButtons=function(container,floatRight){var testingEmbed=0; var cnt=container;var elements={};var loggedInUser=idv.loggedInUser;if(!lib.custom){if(lib.editPermissions()){var createSnapActivator=$('<span class="clickableElement">new snap</span>');pn=lib.setPanelActivator("createSnap",createSnapActivator);pn.scalable=false;pn.height=null;pn.scalable=false;pn.height=null;if(!testingEmbed){var publishButton=$('<span class="clickableElement">publish</span>');lib.publishButton=publishButton;publishButton.click(function(){var ttl=page.albumD.title;if(!ttl)ttl="...";util.myAlert("notice","Publishing "+ttl);var data={topic:page.albumD.topic};util.post("/api/publishAlbum",data,function(rs){util.dialogDiv.html("Done");lib.beenPublished=1;publishedButton.show();});})
var publishedButton=$('<span class="clickableElement">published version</span>');publishedButton.click(function(){var url=util.publishedUrl(lib.albumD.topic);location.href=url;});if(!lib.beenPublished){publishedButton.hide();}}}
var selectedSnapActivator=$('<span class="clickableElement">1 by 1</span>');pn=lib.setPanelActivator("selectedSnap",selectedSnapActivator);pn.selfScaling=true;lib.setPanelNominalHeight("selectedSnap",400);var snapArrayActivator=$('<span class="clickableElement">all snaps</span>');lib.snapArrayButton=snapArrayActivator;snapArrayActivator.click(function(){if(lib.hideLinks)lib.hideLinks();lib.computeSnapVisibility();});pn=lib.setPanelActivator("snapArray",snapArrayActivator);pn.selfScaling=true;}
if(floatRight){if(!lib.custom){if(loggedInUser){createSnapActivator.css("float","right");cnt.append(createSnapActivator);cnt.append(publishButton);cnt.append(publishedButton);}
selectedSnapActivator.css("float","right");cnt.append(selectedSnapActivator);snapArrayActivator.css("float","right");cnt.append(snapArrayActivator);}}else{if(!lib.custom){cnt.append(snapArrayActivator);cnt.append(selectedSnapActivator);if(loggedInUser){cnt.append(createSnapActivator);cnt.append(publishButton);cnt.append(publishedButton);}}
if(idv.embed)return;if(!loggedInUser||lib.published||testingEmbed){var shareButton;if(lib.includeShare){shareButton=$('<span class="clickableElement">share</span>');lib.shareButton=shareButton;cnt.append(shareButton);}
var embedButton=$('<span style="vertical-align:top" class="clickableElement">embed</span>');cnt.append(embedButton);var linkButton=$('<span style="vertical-align:top" class="clickableElement">links</span>');cnt.append(linkButton);
var tumblrButton=$('<span style="vertical-align:top" class="clickableElement">post to tumblr</span>');cnt.append(tumblrButton);tumblrButton.click(function(){var ssn=lib.selectedSnap;var url="http://"+idv.apiHost+"/post_to_tumblr";if(ssn){var sd=ssn.snapD;var data=util.setProperties(null,sd,["caption","cropid","description","topic"]);}else{var data=util.setProperties(null,lib.albumD,["caption","description","topic"]);if(lib.imD.description)data.imageDescription=lib.imD.description;}
if(lib.imD.title)data.imageTitle=lib.imD.title;if(lib.imD.author)data.imageAuthor=lib.imD.author;var dataj=JSON.stringify(data);sessionStorage.signingInWithTumblr="";sessionStorage.post_to_tumblr_args=dataj; var url="http://"+idv.apiHost+"/post_to_tumblr";var inp;var frm=$('<form enctype = "text/plain" action="'+url+'" method="POST">').append(inp=$('<input type="hidden" name="data"/>'));inp.attr("value",dataj);frm.submit();return;});var annotateButton=$('<span style="vertical-align:top" class="clickableElement">annotate</span>');cnt.append(annotateButton);var albumDs=lib.albumDs;var otherAlbumsButton=undefined;if(lib.includeShare){var shareDiv=$('<div class = "shareDiv"></div>');cnt.append(shareDiv);var fbl=$(lib.facebookLikeButton(lib.albumD.topic,120,30));shareDiv.append(fbl);var tweetButton=$(lib.tweetButtonText);shareDiv.append(tweetButton);shareDiv.hide();shareButton.click(function(){if(shareDiv.css("display")=="none"){shareButton.html("hide share");shareDiv.show();embedButton.hide();linkButton.hide();var tweetIframe=$(".twitter-share-button");tweetIframe.css({"position":"relative","top":"-8px"});if(otherAlbumsButton){otherAlbumsButton.hide();}}else{shareButton.html("share");shareDiv.hide();embedButton.show();linkButton.show();lib.theLayout.additionalHeight=lib.originalAdditionalHeight;if(otherAlbumsButton){otherAlbumsButton.show();}}});}}
if(!loggedInUser||lib.published||testingEmbed){var embedDiv=$('<div class="embedDiv"></div>');cnt.append(embedDiv);embedDiv.css({'border':'solid thin green'});embedDiv.hide();var embedTextarea=$('<textarea rows="4" wrap="on" cols="50" readonly="readonly" onclick="this.focus();this.select()"></textarea>');embedDiv.append("<p >Copy and paste the script or iframe tag below into your webpage or blog after setting the width. If less than 700, an image is embedded, which, when clicked, displays the album in a lightbox. If greater than 700 the album itself will be embedded.</p>")
var widin=$('<input type="text" size = "6" value="200"/>');widin.blur(function(){vl=widin.attr('value');var pint=parseInt(vl);if(isNaN(pint)||(pint<=0)){util.myAlert("Error","Width should be a positive integer");}else{embedTextarea.html(lib.embedText(pint));}});var widdiv=$('<div/>');embedDiv.append(widdiv);widdiv.html("Width in pixels of the embed: ")
widdiv.append(widin);embedDiv.append(embedTextarea);var eht=150;embedButton.click(function(){if(embedDiv.css("display")=="none"){embedButton.html("hide embed");embedDiv.show();if(shareButton)shareButton.hide();linkButton.hide();$(document).scrollTop(embedDiv.offset().top);}else{embedButton.html("embed");embedDiv.hide();if(shareButton)shareButton.show();linkButton.show();lib.theLayout.additionalHeight=lib.originalAdditionalHeight;}
lib.placeDivs();});embedTextarea.html(lib.embedText(200));embedDiv.hide();}
if(!loggedInUser||lib.published||testingEmbed){
var linkDiv=$('<div class="embedDiv"></div>');cnt.append(linkDiv);linkDiv.css({'border':'solid thin green'});var linkstart="http://s3.imagediver.org/";function addLine(caption,link){var lnk=$('<input type="text" onclick="this.focus();this.select()"/>');var line=$('<div><span id="caption"></span></div>').append(lnk);$('#caption',line).html(caption).css({"margin-right":"10px"})
lnk.css({width:"85%","font-size":"8pt"});lnk.attr("value",link);linkDiv.append(line);}
function addLines(){addLine("This page:",linkstart+"topic"+lib.albumTopic+"/index.html");if(lib.selectedSnap){var snapNum=page.selectedSnap.snapD.topicId;var cropNum=page.selectedSnap.snapD.cropid;addLine("This snap:",linkstart+"topic"+lib.albumTopic+'/index.html#snap='+snapNum);} 
var imagestart="http://static.imagediver.org/images/";var imtps=page.imD.topic.split("/");var imu=imtps[2];var imt=imtps[3];linkDiv.append('<hr/>');linkDiv.append($('<span>Images:</span>')); addLine("Full image:",imagestart+imu+"/"+imt+"/resized/area_250000.jpg");addLine($("<span>smaller:</span>").css({'margin-left':'10px'}),imagestart+imu+"/"+imt+"/resized/area_50000.jpg");addLine($("<span>larger:</span>").css({'margin-left':'10px'}),imagestart+imu+"/"+imt+"/resized/area_1000000.jpg");if(lib.selectedSnap){addLine("Snap:",imagestart+imu+"/"+imt+"/snap/"+cropNum+".jpg");addLine($("<span>smaller:</span>").css({'margin-left':'10px'}),imagestart+imu+"/"+imt+"/snapthumb/"+cropNum+".jpg");}}
var eht=150;lib.hideLinks=function(){linkButton.html("links");linkDiv.hide();linkButton.show();if(shareButton)shareButton.show();embedButton.show();}
lib.updateLinks=function(){if(linkDiv.css("display")!="none"){linkDiv.empty();addLines();}}
linkButton.click(function(){if(linkDiv.css("display")=="none"){linkButton.html("hide links");linkDiv.show();if(shareButton)shareButton.hide();embedButton.hide();linkDiv.empty();addLines();$(document).scrollTop(linkDiv.offset().top);}else{lib.hideLinks();}
lib.placeDivs();});linkDiv.hide();}
if(annotateButton){annotateButton.click(function(){var im=lib.imD.topic;var host=idv.devVersion?"dev.imagediver.org":"imagediver.org";var url="http://"+host+"/annotate?image="+im;location.href=url;});}}}
lib.setParams=function(imD){if(page.twoColumns){lib.aspectRatio=1;}else{lib.aspectRatio=2;}
var imTopic=imD.topic
var imTopicS=imTopic.split("/");lib.imOwner=imTopicS[2];lib.imName=imTopicS[3]; lib.snapThumbMinWidth=250; lib.snapArrayMinThumbWidth=180; lib.prevNextWidth=100; lib.snapThumbMargin=20;lib.snapThumbHeight=150;lib.snapThumbBottomMargin=40;lib.snapThumbCaptionHeight=90;lib.snapGapX=10;lib.snapGapY=10;lib.snapHeight=550; lib.snapTop=120; lib.thumbTop=180;lib.zoomDelay=50;lib.zoomIncrement=1.05;lib.maxZoom=256; lib.initialZoom=1;lib.imD=imD; lib.image=new imlib.Image(imD);lib.tiling=new imlib.Tiling(lib.image,256,1,imD.tilingDepthBump);lib.maxDepth=lib.tiling.depth;}
lib.scaleRect=function(rect,corner,scale){var nex=rect.extent.times(scale);var rs=new geom.Rect(corner,nex);return rs;}
lib.defaultPanelHeight=function(){return lib.standardPanelHeight*lib.theLibrary.scale;}
lib.placeDivs=function(){lib.theLayout.placeDivs();lib.vp.scale=lib.theLayout.scale;lib.vp.refresh(true);}
lib.genFullTitle=function(){if(document.location.pathname=="/"){var fullTitle="the depths of high-resolution images, annotated";}else{var author=lib.imD.author;if(author){author=", "+author;}else{author="";}
var imt=lib.imD.title;if(!imt)imt=lib.imD.name;var caption=lib.albumD.caption;if(caption){caption=": "+$.trim(caption);}else{caption="";}
fullTitle=imt+author+caption;}
return fullTitle;}
lib.updateTopbarOptions=function(options){var title=lib.genFullTitle();options.title=util.sanitize(title);var dp=[];}
lib.genDivs=function(){var b=$('body');fullTitle=lib.genFullTitle();var twoC=page.twoColumns;twoC=1;if(page.fullsizeOption){var fullsize="/topic"+lib.albumD.image+"/index.html";}else{fullsize=false;}
var pqs=util.parseQS();var embed=idv.embed;var title=lib.genFullTitle();var imlink="/topic"+lib.imD.topic+"/index.html";var imdomain="http://imagediver.org";var fimlink=imdomain+imlink;var topbarOptions={title:util.sanitize(title),embed:embed,imagePage:fimlink,detailsLink:{text:"image details",action:lib.popImageDetails},includeGallery:1};if(twoC){ var outerDiv=$('.outerDiv');if(outerDiv.length==0){outerDiv=$("<div class='outerDiv'/>");b.append(outerDiv);}
lib.outerDiv=outerDiv;lib.topbar=imlib.genTopbar(outerDiv,topbarOptions);var colsDiv=$("<div class='columns'/>")
outerDiv.append(colsDiv);var c0Div=$("<div class='leftColumnDiv'/>");lib.c0Div=c0Div;colsDiv.append(c0Div);var c1Div=$("<div class='columnDiv'/>");lib.c1Div=c1Div;colsDiv.append(c1Div);}else{var c1Div=$("<div class='columnDiv'/>");lib.c1Div=c1Div;b.append(c1Div);if(!idv.embed)lib.topDiv=imlib.genTopbar(c1Div,topbarOptions);}
if(false){lib.noteDiv=$('<div class="noteDiv"><p> See the <span id="galleryLink">gallery</span> for a few more images</p>'+'<p style="line-height:10px;top:0px;width:100%;text-align:center">Astoria in 1923</p></div>');b.append(lib.noteDiv);$('#galleryLink').click(function(){location.href="/gallery";});lib.noteSdiv.element=lib.noteDiv;}
lib.vpDiv=$('<div class="viewport" id="viewport0" style="z-index:0"/>');c1Div.append(lib.vpDiv); var evDiv=$('<div id="evDiv"></div>');evDiv.css({"position":"absolute","background-color":"transparent"});lib.evDiv=evDiv;lib.vpDiv.append(evDiv); lib.vpCapDiv=$('<div class="vpCap" id="viewport0" style="position:absolute;background-color:black;border:solid thin white;padding:3px;font-size:8pt;z-index:1000">TEST</div>');lib.vpDiv.append(lib.vpCapDiv);lib.vpCapDiv.hide();lib.vpSelectDiv=$('<div class="vpSelect" id="vpSelect" style="margin:0px;padding:0px;position:absolute;background-color:transparent;font-size:8pt;z-index:2000;border:solid yellow;border-width:2px;"></div>');lib.vpDiv.append(lib.vpSelectDiv);lib.vpSelectDiv.hide();lib.zoomDiv=$('<div class="controls"/>');c1Div.append(lib.zoomDiv);if(!lib.custom){lib.panels={};lib.panelDiv=$('<div class="panel_container" />'); if(!idv.loggedInUser){lib.panelDiv.mousedown(function(e){ e.preventDefault();});}}
lib.bottomDiv=$('<div class="bottomDiv"></div>');if(twoC){if(!lib.custom){lib.panelDiv.css("overflow","auto");c0Div.append(lib.panelDiv);}
lib.buttonsDiv=$('<div class="controls"/>');c0Div.append(lib.buttonsDiv);lib.renderButtons(lib.buttonsDiv,false);if(idv.embed){var margin=10;}else{margin=20;}
var aheight=idv.embed?110:140;lib.theLayout=new lib.LayoutTwo({outerDiv:lib.outerDiv,colsDiv:colsDiv,leftDiv:lib.c0Div,rightDiv:lib.c1Div,panelDiv:lib.panelDiv,vpDiv:lib.vpDiv,evDiv:lib.evDiv,margin:margin,aspectRatio:lib.aspectRatio,minScale:0.33, additionalHeight:aheight, includeLightbox:(!idv.embed)});}else{c1Div.append(lib.panelDiv);lib.renderButtons(lib.zoomDiv,true);c1Div.append(lib.bottomDiv);lib.theLayout=new lib.LayoutOne({centerDiv:lib.c1Div,vpDiv:lib.vpDiv,margin:20,aspectRatio:lib.aspectRatio,minScale:0.6,additionalHeight:165});}
lib.originalAdditionalHeight=lib.theLayout.additionalHeight;lib.theLayout.placeDivs();lib.topbar.lightbox=lib.theLayout.lightbox;lib.lightbox=lib.theLayout.lightbox;
var vpExtent=lib.theLayout.vpExtent;lib.vpCanvas=imlib.genCanvas({whichCanvas:"vp",extent:vpExtent,container:lib.vpDiv,zIndex:-1,backgroundColor:"#000000"});lib.ovCanvas=imlib.genCanvas({whichCanvas:"ov",extent:vpExtent,container:lib.vpDiv,zIndex:200,backgroundColor:"transparent"}); if(!idv.useFlash){lib.selCanvas=imlib.genCanvas({whichCanvas:"sel",extent:vpExtent,container:lib.vpDiv,zIndex:300,backgroundColor:"transparent"}); lib.hiliCanvas=imlib.genCanvas({whichCanvas:"hili",extent:vpExtent,container:lib.vpDiv,zIndex:400,backgroundColor:"transparent"});}
lib.bottomDiv=$('<div class="bottomDiv"></div>');if(!lib.custom){lib.addSnapArrayDiv(lib.panelDiv);lib.addSelectedSnapDiv(lib.panelDiv);lib.addCreateSnapDiv(lib.panelDiv);}
lib.theLayout.placeDivs();lib.theLayout.afterPlacement=function(){if(lib.vp){var layout=lib.theLayout;lib.vp.scale=layout.scale;var vpCss=layout.vpCss;lib.vpCanvas.attr({width:layout.vpExtent.x,height:layout.vpExtent.y});if(lib.ovCanvas)lib.ovCanvas.attr({width:layout.vpExtent.x,height:layout.vpExtent.y})
if(lib.selCanvas)lib.selCanvas.attr({width:layout.vpExtent.x,height:layout.vpExtent.y})
if(lib.hiliCanvas)lib.hiliCanvas.attr({width:layout.vpExtent.x,height:layout.vpExtent.y})
lib.vp.refresh(true);}}}
lib.genViewports=function(){lib.tiling.createTiles();var vpExtent=lib.theLayout.vpExtent;var vp=new imlib.Viewport(lib.vpDiv,lib.vpCanvas,lib.tiling,vpExtent,[lib.ovCanvas,lib.selCanvas,lib.hiliCanvas]);lib.vp=vp;vp.zoom=lib.initialZoom;lib.vp=vp;imlib.mainVP=vp;vp.maxZoom=lib.maxZoom;vp.maxDepth=lib.maxDepth;vp.depthBump=lib.imD.zoomDepthBump;lib.vp.panControl=new imlib.PanControl(lib.vpDiv,vp);lib.renderZoomControl(lib.zoomDiv);}
lib.test=function(){var ov=new imlib.Overlay("test",new geom.Rect(new geom.Point(12000,2000),new geom.Point(5000,1000)));lib.vp.addOverlay(ov);}
lib.initialize=function(options){var mt=document.location.hash.match(/snap=(\d*)/);if(mt){lib.urlSnap=parseInt(mt[1]);}
lib.useMarkdown=true;var loading=$('<div style="margin:40px"><center>LOADING...  <img src="/ajax-loader.gif"/></center></dir>');page.loadingDiv=loading;$('body').append(loading);lib.forS3Dev=1;var published=options.published;lib.published=published;lib.beenPublished=options.beenPublished;lib.hasAlbums=options.hasAlbums; lib.options=options;idv.util.commonInit();lib.albumTopic=options.albumTopic;if(!idv.loggedInUser)idv.util.loggedInUserFromCookie(); var jsonUrl=idv.util.jsonUrl(options.albumTopic,published);idv.util.get(jsonUrl,initialize2);}
function initialize2(rs){var snaps=rs.value.snaps; var ln=snaps.length;var snapDs=Array(ln);for(var i=0;i<ln;i++){var sn=snaps[i];var ord=sn.ordinal;snapDs[ord-1]=sn;}
snapDs=util.arrayFilter(snapDs,function(v){return v!=undefined;});ln=snapDs.length;for(var i=0;i<ln;i++){snp=snapDs[i];snp.myIndex=i;}
lib.snapDs=snapDs;lib.imD=rs.value.image;lib.albumD=rs.value;lib.albumD.ownerName=lib.options.albumOwnerName;$('document').ready(initialize3);}
function initialize3(){lib.custom=false; util.tlog("initialize");var albumD=lib.albumD;var imD=lib.imD;var imdim=imD.dimensions;var imx=imdim.x;var tps=albumD.topic.split("/");var aid=tps[4];var owner=tps[2];lib.albumOwner=owner;lib.albumNum=aid;lib.albumString=owner+"."+aid; util.commonInit();idv.pageKind="album";var snapDs=lib.snapDs;lib.snapDsByTopicNum={};util.arrayForEach(snapDs,function(snapD){return lib.internalizeSnapD(snapD,imx);});util.arrayForEach(snapDs,function(snapD){var topicId=util.lastPathElement(snapD.topic);snapD.topicId=topicId; lib.snapDsByTopicNum[topicId]=snapD;});util.arrayForEach(snapDs,lib.fixSnapCoverage);if(!albumD){imlib.genTitleBar("No Such Album");return;};var imdim=imD.dimensions;var imx=imdim.x;var imy=imdim.y;var imar=imx/imy;page.twoColums=true; page.fullsizeOption=(imar>1.6);lib.setParams(imD);var albumTopic=albumD.topic;var sp=albumTopic.split("/");var spln=sp.length;lib.albumId=sp[spln-1];lib.genDivs();lib.genViewports();$(window).resize(function(){util.log("resize",$(window).width());lib.placeDivs();lib.resizeCurrentPanel();});util.tlog("pre add snaps");lib.addSnaps(snapDs,0);util.tlog("after add snaps");lib.hookupPanelActivators();lib.selectPanel("snapArray");util.tlog("pre place divs");lib.placeDivs();util.tlog("after place divs");lib.resizeCurrentPanel();lib.loadingDiv.hide();lib.vp.refresh(true);util.slog("REFRESH");util.addDialogDiv($('.columns'));
setTimeout(function(){lib.addSnaps(snapDs,500000);lib.enterShowSnapsMode();lib.checkNoSnaps();lib.showSnapByTopic()},100);util.tlog("initialize done");}
lib.defaultPanelHeight=function(){return lib.theLayout.scale*lib.theLayout.panelCss.height;}
lib.testUpdate=3;})();
(function(){var lib=page;var geom=exports.GEOM2D;var imlib=exports.IMAGE;var com=idv.common;var util=idv.util;lib.clearOverlayState=function(){var dfs=lib.showSnapsMode?"outlined":"noOverlay";util.arrayForEach(lib.snaps,function(snap){snap.snapD.overlayState=dfs});}
lib.updateOverlays=function(which){var vp=lib.vp;if(which=="selected"){vp.clearOverlays(1);}else if(which=="outlined"){vp.clearOverlays(0);}else{vp.clearOverlays("both");}
util.arrayForEach(lib.snaps,function(snap){var snapD=snap.snapD;var st=snapD.overlayState;if((st=="selected")&&((which=="selected")||(which=="both"))||((st=="outlined")&&((which=="outlined")||(which=="both")))){var cv=snapD.coverage;var nm=snapD.topicId;var ov=new imlib.Overlay(nm,cv);ov.color=(st=="selected")?"yellow":"red" 
vp.addOverlay(ov);if(st=="selected"){vp.addOverlay(ov,1);}}});if(which=="selected"){vp.drawOverlays(1);}else if(which=="outlined"){vp.drawOverlays(0);}else{vp.drawOverlays("both");}}
imlib.mouseMoveCallback=function(ps){} 
lib.drawOneRect=function(r,color,sel){var vp=lib.vp;vp.clearOverlay(sel);vp.drawRect(r,"image",color,sel);} 
lib.computeSnapRelevance=function(ps){return lib.snapHit(ps);var cnt=0;var theSnap;util.arrayForEach(lib.snaps,function(snap){var snapD=snap.snapD;var cv=snapD.coverage;var rl=cv.contains(ps);snapD.relevant=rl;snapD.clickSelected=rl;if(rl){theSnap=snapD;cnt++;}});if(cnt==1)return theSnap;else return cnt;}
lib.clickSelectedSnaps=function(){var rs=[];util.arrayForEach(lib.snaps,function(snap){if(snap.snapD.clickSelected){rs.push(snap);}});return rs;}
lib.snapsHit=function(ps){var snaps=lib.snaps;var ln=snaps.length;var rs=[];for(var i=0;i<ln;i++){var snapD=snaps[i].snapD;var cv=snapD.coverage;if(cv.contains(ps)){rs.push(snapD);}};return rs;}
lib.closestSnap=function(sns,ps){var mind=1000000000.0;var rs=undefined;util.arrayForEach(sns,function(sn){var cv=sn.coverage;var d=cv.distToCenter(ps);if(d<mind){rs=sn;mind=d;}});return rs;}
lib.snapHit=function(ps){var snaps=lib.snapsHit(ps);return lib.closestSnap(snaps,ps);}
imlib.mouseMoveCallback=function(ps,vps){if(!lib.showSnapsMode)return;var snhit=lib.snapHit(ps);var dv=lib.vpCapDiv;var vp=lib.vp;if(snhit){if(vp.cHili!=snhit){var cv=snhit.coverage.expand(imlib.selectStrokeWidth);vp.clearOverlay(2);if(idv.useFlash){vp.drawImRect(cv,"white",2,false,imlib.selectStrokeWidth*0.5);}else{vp.drawRect(cv,"image","white",2);}
vp.cHili=snhit;} 
var cpt=snhit.caption;if(cpt){dv.show();dv.html(util.removeWikiSymbols(snhit.caption));dv.css({left:vps.x+13,top:vps.y-13});}else{dv.hide();}}else{dv.hide();vp.cHili=null;vp.clearOverlay(2);}}
imlib.mouseOutCallback=function(){lib.vpCapDiv.hide();} 
lib.DclickTimeoutId=undefined;
lib.snapContains=function(snp,p){var snapD=snp.snapD;if(snapD==undefined){snapD=snp;}
var cv=snapD.coverage;return cv.contains(p);} 
imlib.clickCallback=function(ps,vps,dclick){ if(!lib.showSnapsMode)return;if(dclick){if(lib.preClickSelSnap){ if(lib.snapContains(lib.preClickSelSnap,ps)){lib.setSelectedSnap(lib.preClickSelSnap);lib.preClickSelSnap=undefined;}}
if(lib.selectedSnap){if(lib.snapContains(lib.selectedSnap,ps)){if(lib.DclickTimeoutId){ clearTimeout(lib.DclickTimeoutId);lib.DclickTimeoutId=undefined;}
lib.vp.setZoom(1);lib.animatedZoomToSnap(lib.selectedSnap.snapD,1.1);}}
return;}
if(!lib.showSnapsMode){var sls=lib.selectedSnap;if(!sls){lib.snapAdvice.html("no snap to select");return;}
var cv=sls.snapD.coverage;var rl=cv.contains(ps);if(!rl){lib.snapAdvice.html("no snap selected");return;}
lib.snapAdvice.html("double click to zoom to the selected snap");}
var csr=lib.computeSnapRelevance(ps);function selectMultipleSnaps(){ lib.leaveSnapVisibilityAlone=true;lib.selectPanel("snapArray");lib.leaveSnapVisibilityAlone=false;lib.positionSnaps(undefined,true,false); lib.enableClickable(lib.snapArrayButton);lib.DclickTimeoutId=undefined;lib.preClickSelSnap=undefined;lib.snapAdvice.html("multiple snaps selected. choose one from left panel");}
if(typeof csr=="number"){ lib.preClickSelSnap=lib.selectedSnap;var csls=lib.clickSelectedSnaps();lib.setSelectedSnaps(csls,"nochange");lib.DclickTimeoutId=setTimeout(selectMultipleSnaps,imlib.dclickInterval+50);return;}else{lib.preClickSelSnap=undefined;lib.selectPanel("selectedSnap");lib.showSelectedSnap(csr);}
lib.showSnapsMode=true;} 
lib.snapRelevant=function(snapD,rect){var cv=snapD.coverage;if(!cv.intersects(rect))return false;var ri=cv.intersect(rect);var ria=ri.area();var cva=cv.area();return ria/cva>0.4;}
lib.computeSnapVisibility=function(){if(lib.leaveSnapVisibilityAlone)return 0;if(lib.zooming)return 0; var vp=lib.vp;var vw=vp.computeCoverage();var cnt=0;var ns=lib.snapsActive;for(var i=0;i<ns;i++){var snapD=lib.snaps[i].snapD;snapD.visible=vw.intersects(snapD.coverage);if(snapD.visible)cnt++;snapD.relevant=lib.snapRelevant(snapD,vw);};if(idv.pageKind=="album")lib.positionSnaps(undefined,true);return cnt;}
lib.redisplaySnaps=function(){lib.computeSnapVisibility();lib.snapAdvice.show();lib.clearOverlayState(0);lib.updateOverlays("outlined");}
lib.enterShowSnapsMode=function(){if(lib.showSnapsMode)return;lib.showSnapsMode=true;lib.redisplaySnaps();lib.snapAdvice.html(lib.stdSnapAdvice());lib.showSnapsButton.html('hide outlines');}
lib.exitShowSnapsMode=function(){if(!lib.showSnapsMode)return;lib.vpCapDiv.hide();lib.vpSelectDiv.hide(); lib.showSnapsMode=false;var vp=lib.vp;lib.showSnapsButton.html('show outlines');lib.snapAdvice.html("");util.arrayForEach(lib.snaps,function(snap){snap.snapD.clickSelected=false;});lib.clearOverlayState();lib.updateOverlays("outlined");lib.snapAdvice.html(lib.stdSnapAdvice());}
lib.ss=function(){lib.enterShowSnapsMode();}
})();
