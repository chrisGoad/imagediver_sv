(function(){var common=idv.common;var util=idv.util;var theUser={}
var lib=page;function callResend(uname,pw,cb){var url="/api/resend"
var data={"password":pw,"user":uname};var dataj=JSON.stringify(data);$.ajax({url:url,data:dataj,cache:false,contentType:"application/json",type:"POST",dataType:"json",success:cb});}
function signIn(){var url="/api/login";var email=$('#loginEmail').attr('value');var errel=$('#loginError');if($.trim(email)==""){errel.html("No email entered");return;}
var pw=$('#loginPassword').attr('value');var data={"password":pw,"email":email};var dataj=JSON.stringify(data);$.ajax({url:url,data:dataj,cache:false,contentType:"application/json",type:"POST",dataType:"json",success:function(rs){if(rs.status=="ok"){errel.html("");var vl=rs.value;document.cookie="sessionId="+vl.sessionId+"; Domain=.imagediver.org; path=/;";document.cookie="userId="+vl.userId+"; Domain=.imagediver.org; path=/;";location.href="/";}else{var rsn=rs.msg;if(rsn=="badUserOrPassword")
errel.html("Incorrect email or password.");else{errel.html("The email associated with this account has not yet been verified. Please check your email. Click ");var rsnd=$('<span style="color:blue;cursor:pointer">here</span>');errel.append(rsnd);errel.append(' to resend the verification message.');function popResendDialog(){idv.util.myConfirm("Resend","<p>Resend Verification Message</p>",function(){callResend(uname,pw,function(rs){if(rs.status=="ok"){errel.html("Verification email resent");idv.util.closeDialog();}else{errel.html("Unexpected condition: bad password. Please reload this page and try again.");idv.util.closeDialog();}})},function(){idv.util.closeDialog();});}
rsnd.click(popResendDialog);}}}});}
function forgotPassword(){var url="/api/forgotPassword";var errel=$('#loginError');var email=$('#loginEmail').attr('value');if($.trim(email)==""){errel.html("No email entered");return;}
var pw=$('#loginPassword').attr('value');var data={"email":email};var dataj=JSON.stringify(data);$.ajax({url:url,data:dataj,cache:false,contentType:"application/json",type:"POST",dataType:"json",success:function(rs){if(rs.status=="ok"){errel.html("An email has been sent with a link enabling password reset");}else{errel.html("There is no ImageDiver user with this email.");}}});}
function showMessage(msg){var rmsg=$('#errMsg');rmsg.show();rmsg.html(msg);}
function register(cn){$("#errMsg").html(" ");function checkPassword(pw){var ln=pw.length;if(ln<6)return false;var mt=pw.match(/^\w*$/);if(!mt)return false;return true;}
function checkName(pw){var mt=pw.match(/^(\w|\s)*$/);if(!mt)return false;return true;}
function checkEmail(pw){var mt=pw.match(/^[^\s]*$/);if(!mt)return false;return true;}
var pw=$('#newPassword').attr('value');var rpw=$('#repeatPassword').attr('value');var name=$('#name').attr('value');var email=$('#email').attr('value');theUser.password=pw;theUser.name=name;theUser.email=email;if(!checkName(name)){showMessage("Your username must consist only of letters, digits, and spaces");return;}
if(!checkEmail(email)){showMessage("This does not look like an email address");return;}
if(pw!=rpw){showMessage("Repeated password does not match");return;}
if(!checkPassword(pw)){showMessage("Your password must consist of six or more letters and digits");return;}
if(lib.tosAgree.attr('checked')!="checked"){showMessage("You must agree to the Terms of Service in order to register");return;}
var data={email:email};var dataj=JSON.stringify(data);$.ajax({url:"/api/checkUser",data:dataj,cache:false,contentType:"application/json",type:"POST",dataType:"json",success:function(rs){var st=rs.status;if(st=="failed"){showMessage("There is already an account associated with this email");return;}
var userj=JSON.stringify(theUser);$.ajax({url:"/api/register",data:userj,cache:false,contentType:"application/json",type:"POST",dataType:"json",success:function(rs){if(rs.status=="ok"){var idv=$('.infoDiv');idv.html("An email has been sent to "+email+" - clicking on a link  in that email will complete your registration. Thanks!");}else{showMessage("Failed to send email to "+email);}}});}});}
lib.signInWithTumblr=function(){var url="http://"+idv.apiHost+"/api/tumblrRequestToken";sessionStorage.signingInWithTumblr="yes";util.get(url,function(rs){var vl=rs.value;var vlj=JSON.stringify(vl);sessionStorage.tumblrToken=vlj;var rtk=vl.oauth_token;var url='http://tumblr.com/oauth/authorize?oauth_token='+rtk;location.href=url;});}
lib.initialize=function(){util.commonInit()
var cn=$('.infoDiv');var br=$.browser;if(br.msie&&(parseFloat(br.version)<8)){cn.append("<p>Versions of Internet Explorer prior to version 8 are not suitable for creating ImageDiver content "+", although Internet Explorer 7.0 is adequate for viewing existing content. Please come back with "+" a newer version of Internet Explorer, or Chrome, Firefox, or Safari.</p> <p> -- Thanks. </p>");return;}
var sit;cn.append($('<div/>').css({"margin-left":"10px"}).append(sit=$('<span id="signIn" class="clickableElement">Sign in with Tumblr</span> (No registration required)')));cn.append($('<div>The only access that ImageDiver will perform to your Tumblr account: retrieving your Tumblr name, and posting ImageDiver content as drafts when you request this.</div>').css({"margin":"10px"}));sit.click(lib.signInWithTumblr);sit.css({'cursor':'pointer'});cn.append('<hr/>');cn.append('<div>Or if you have registered:</div>');var tb=$(common.genTable("login",[['Email','<input id="loginEmail" size="30" type="text"/>'],['Password','<input id="loginPassword" type="password"/>']]));cn.append(tb);var errel=$('<div id="loginError" class="errorMessage"/>');cn.append(errel);var signinDiv=$('<div/>');cn.append(signinDiv);tb.css({'margin-top':"10px","margin-left":"10px","margin-bottom":"20px"});var signin=$('<span id="signIn" class="clickableElement">sign in</span>');signinDiv.append(signin);signin.click(signIn);var forgot=$('<span id="forgot" class="clickableElement">forgot password</span>').css({"margin-left":"40px"});signinDiv.append(forgot);forgot.click(forgotPassword);signinDiv.css({"margin-left":"20px","margin-top":"20px","margin-bottom":"20px"})
cn.append('<hr/>');var rgtop=$("<div>Or Register</div>");rgtop.css({"margin-top":"20px"});cn.append(rgtop);var rtb=$(common.genTable("signin",[['Username','<input id="name" size="30" type="text"/>'],['Email','<input id="email"  size="30" type="text"/>'],['Password','<input id="newPassword" type="password"/>'],['Repeat Password','<input id="repeatPassword" type="password"/>']]));rtb.css({'margin-top':"10px","margin-left":"10px","margin-bottom":"20px"});cn.append(rtb);lib.tosAgree=$('<input type="checkbox" />I agree to the ImageDiver <a style="color:black" href="/tos" target="_blank">Terms of Service</a></input>');var tosDiv=$('<div/>');tosDiv.append(lib.tosAgree)
cn.append(tosDiv);var rmsg=$('<div id="errMsg"></div>');rmsg.css({color:util.errorColor,"margin-bottom":"20px"});cn.append(rmsg);var registerbut=$('<span id="signIn" class="clickableElement">Register</span>');cn.append(registerbut);registerbut.click(function(){register(cn);});idv.util.addDialogDiv($(".infoDiv"));}})();
