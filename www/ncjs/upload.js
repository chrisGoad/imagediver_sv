(function(){var common=idv.common;var lib=page;var util=idv.util;lib.progressBar=function(options){this.options=options;this.status="not_started";}
lib.progressBar.prototype.cancel=function(){u=this.options.job;this.canceled=1;this.jobc.canceled=1;if(!u)return;var url="/topic"+u.topic+"/cancel()";var thisHere=this;idv.util.post(url,null,function(rs){thisHere.jobc.cancel();});}
lib.progressBar.prototype.render=function(){var o=this.options;var c=o.container;var u=o.job;var err=u.error;if(err){c.empty();c.append('<div id="errorMsg">');$("#errorMsg").html(err);this.beenRendered=false; return;}
var ttl=o.mainTitle;var brnd=this.beenRendered;var sttl=o.stageTitle;var w=o.width;var h=o.height;var wd=o.whenDone;if(!brnd){c.empty();var mainDiv=$('<div id="mainDiv">'+'<div id="mainTitle"/>'+'<div id="stageTitle"/>'+'<div id="jobProgressBar">'+'<div id = "innerBar"/>'+'</div>'+
'</div>');c.append(mainDiv);$(" div",mainDiv).css({"margin-top":"20px","margin-bottom":"20px"});this.beenRendered=true;}
$('#jobProgressBar').css({width:w,height:h,"background-color":"white"});$('#innerBar').css({left:0,top:0,width:0,height:h,"background-color":"green"});if(ttl)$('#mainTitle').html(ttl);$('#stageTitle').html(sttl);this.initTime=new Date().getTime();this.monitorCount=0;if(!brnd){c.append('<div id = "jobText"></div>');}
var textDiv=$('#jobText');textDiv.css({"margin-top":20,top:h+10,left:0,width:w});textDiv.html("Not started");this.textDiv=textDiv;if(!brnd){var cancelContainer=$('<div></div>').css("margin-top",20);c.append(cancelContainer);var cancelButton=$('<span class="clickableElement">Cancel</span>');cancelContainer.append(cancelButton);var thisHere=this;this.cancelButton=cancelButton;cancelButton.click(function(){thisHere.cancel();});}}
lib.progressBar.prototype.allDone=function(area){ if(area){$('#mainDiv').hide();this.cancelButton.hide();var o=this.options;var u=o.job;var sb=u.subject;if(sb.indexOf("{")>=0){var imnm=$.parseJSON(sb).image_name;}else{imnm=sb;}
var knd=lib.isRetrieval?"retrieval":"upload";$('#jobText').css({"width":"700px"});var msg="The "+knd+" of "+imnm+" is complete. Now the image needs to be prepared for zooming. "+"For an  image of this size ("+idv.util.bytesstring(area,1)+"), this will take a little while. ";if(idv.hasEmail){msg+="An email notification will be sent when the image is ready for use."}else{msg+="Please check your content page for completion (we would send an email, but don't have your address)."}
$('#jobText').html(msg);}else{var uid=idv.util.pathLast(idv.loggedInUser);var imn=idv.imageName;var dst=idv.topicDir+"/album/"+uid+"/"+imn+"/-/index.html";location.href=dst;}}
lib.progressBar.prototype.update=function(u){this.job=u;var o=this.options;var units=o.units;var size=u.total;if(u.status=="not_started")return;if(u.status=="done"){return;this.status="done";this.textDiv.html("done");var wd=o.whenDone;if(wd){wd();}
return;}
if((u.status=="error")||(u.status=="canceled"))return;if(u.status=="error"){this.status="error";$("#jobProgressBar").hide();this.textDiv.html("ERROR "+u.error);return;}
if(u.status=="canceled"){$('#mainDiv').hide();this.cancelButton.hide();this.textDiv.html("canceled import of "+u.subject);return;}
var sofar=u.so_far;var fr=sofar/size;var prc=Math.ceil(fr*100);var idw=Math.ceil(fr*o.width)
$('#innerBar').css({width:idw});if(units==" MB"){sofarst=util.bytesstring(sofar);sizest=util.bytesstring(size);}else{sofarst=sofar;sizest=size;}
this.sizeString=sizest;this.textDiv.html("completed: "+prc+"% -- "+sofarst+" out of "+sizest);}
lib.progressBar.prototype.updateTime=function(){$('#jobTime').html("Elapsed time: ",Math.floor(((new Date().getTime())-this.initTime)/1000));}
})();
(function(){var lib=page;var geom=idv.geom;var imlib=idv.image;var util=idv.util;idv.css.link={"text-decoration":"underline","cursor":"pointer"}
idv.pageKind="album";lib.monitorUpload=function(upload){ lib.theProgressBar.monitor(upload);}
lib.hideRetrieveOptions=function(){$('#orIfUpload').hide();$('#rt_row_1').hide();$('#retrieveButton').hide();$('#fromWhichUrl').hide();}
lib.onError=function(job){var isUpload=lib.jobC.theJobs[0].kind=="upload";$('#init').show();$('#uploadProgress').hide();if(isUpload){$("#uploadIframe").attr("src","/upload_iframe");$("#uploadIframe").show();lib.hideRetrieveOptions();}
util.myAlert('Error',job.error);}
lib.onCancel=function(job){$('#init').show();$('#uploadProgress').hide();var isUpload=lib.jobC.theJobs[0].kind=="upload";if(isUpload){$("#uploadIframe").attr("src","/upload_iframe");$("#uploadIframe").show();$('#orIfUpload').hide();$('#retrieveButton').hide();$('#fromWhichUrl').hide();$('#initDivMsg').html("Canceled");}else{$('#retrieveButton').attr("value","Try again");$('#initDivMsg').html("Canceled");}}
lib.initProgressBar=function(jobc,job,wd){var pbc=$('#uploadProgress');pbc.show();$('#init').hide();if(job.noMonitoring)return; var o={units:"",container:pbc,width:400,height:5,job:job,whenDone:wd}
if(job.kind=="upload"){var sbo=JSON.parse(job.subject);var imn=sbo.image_name;idv.util.extend(o,{units:" MB",stageTitle:"Uploading",mainTitle:"Importing "+imn});}else if(job.kind=="retrieve"){sbo=JSON.parse(job.subject);imn=sbo.image_name;var src=sbo.source;idv.util.extend(o,{units:" MB",stageTitle:"Retrieving",mainTitle:"Importing "+imn+" from "+src});}else if(job.kind=="build_tiling"){idv.util.extend(o,{stageTitle:"Creating tiles"});}else if(job.kind=="to_s3"){idv.util.extend(o,{stageTitle:"Copying to S3"});}else if(job.kind=="resize_image"){idv.util.extend(o,{stageTitle:"Resizing"});}else{alert("UNKNOWN KIND "+job.kind);return;}
if(lib.theProgressBar){var pb=lib.theProgressBar;pb.options=o;}else{var pb=new page.progressBar(o);lib.theProgressBar=pb;}
lib.theProgressBar=pb;lib.theProgressBar.jobc=jobc;jobc.progressBar=lib.theProgressBar;pb.render();$("#uploadIframe").hide();}
function firstCharIsLetter(c){var cc=c.charCodeAt(0);return((65<=cc)&&(cc<=90))||((97<=cc)&&(cc<=122));}
lib.checkImageName=function(pw){var ln=pw.length;if(ln==0)return false;var mt=pw.match(/^\w*$/);if(!mt)return false;return firstCharIsLetter(pw);}
lib.fixImageName=function(pw){ var ln=pw.length;if(ln==0)return false;if(!firstCharIsLetter(pw)){pw="im_"+pw;}
var rs=pw.replace(/\W/g,"_");return rs;}
function initialize2(){var cn=$('.infoDiv');idv.topbar.genTopbar(cn,{});util.addDialogDiv(cn);var dialogDiv=$('<div id="dialog">Ho Ho</div>');cn.append(dialogDiv);dialogDiv.dialog({height:140,modal:true,autoOpen:false,title:"Error"});lib.storageDiv=$('<div id = "storage">You have '+util.bytesstring(lib.availableStorage)+' of available storage. The storage needed for '+'the zoomable representation of an image is typically 2 or 3 times its compressed (jpg or png) size. </div>');lib.storageDiv.css({"margin-bottom":"30px","font-size":"8pt"});cn.append(lib.storageDiv);lib.initDiv=$('<div id="init">'+
idv.common.genTable("rt",[['<span>Name for the image at ImageDiver:</span>','<input size=50 id="imname" type="text"/>'],['<span id="fromWhichUrl">Url from which to retrieve the file:</span>','<input size=50 id="imurl" type="text"/>']])+
'<div style="margin-top:10px;margin-bottom:10px"><span id="retrieveButton" class="clickableElement">Retrieve</span></div>'+'<div id="orIfUpload">Or, if the image is on your computer, choose and upload it: </div>'+'<div id="initDivMsg"></div>'+'</div>');cn.append(lib.initDiv);var imnf=$("#imname",window.parent.document);imnf.change(function(){lib.imageNameFromFileName=false;});cn.append('<div id="uploadProgress" style="width:100%"></div>');cn.append('<iframe id="uploadIframe" seamless="1"></iframe>');theIframe=$("#uploadIframe");theIframe.attr("src","/upload_iframe");lib.jobC.initProgressBar=lib.initProgressBar;lib.jobC.onError=lib.onError;lib.jobC.onCancel=lib.onCancel;var rb=$('#retrieveButton')
rb.click(function(){lib.isRetrieval=1;$('#storage').hide();$("#initDivMsg").html('');$('#orIfUpload').hide();$("#uploadIframe").hide();var usp=idv.loggedInUser.split("/")[2]
var imn=$('#imname').attr("value");var ck=lib.checkImageName(imn);if(!ck){util.myAlert('Error',"The image name may contain only numbers, letters, and the underbar, and must start with a letter");return;}
idv.imageName=imn;var src=$('#imurl').attr("value");var sbj=JSON.stringify({"image_name":imn,"source":src});var data=[{"subject":sbj,"kind":"retrieve","owner":usp},{"subject":imn,"kind":"resize_image","owner":usp},{"subject":imn,"kind":"build_tiling","owner":usp},{"subject":imn,"kind":"to_s3","owner":usp}];url="/api/allocateJob";lib.jobC.canceled=0;lib.jobC.cjob=0;idv.util.post(url,data,function(rs){if(rs.msg=="sessionTimedOut"){util.logout();location.href="/timeout";return;}
if(rs.value=="exists"){util.myAlert("","An image with that name is already present. Delete it first if you wish to replace it");return false;}
var jobs=rs.value;lib.jobC.theJobs=jobs;var j=jobs[0]
var exists=j.retries;if(exists){var ifyes=function(){lib.jobC.startJob();};var ifno=function(){util.closeDialog();};util.myConfirm("","A file by that name exists. Overwrite?",ifyes,ifno);return;}
lib.jobC.startJob();return false;});});}
lib.initialize=function(options){util.commonInit(options);lib.availableStorage=options.allocation-options.utilization;lib.jobC=new jobController();$(document).ready(initialize2);$(window).unload(function(){if(lib.theProgressBar){var u=lib.theProgressBar.upload;if(u&&u.status=="uploading"){lib.theProgressBar.cancelUpload();$('#dialog').html("By leaving this page, you are canceling the import");$('#dialog').dialog('open');}}});}})();
var jobController=function(){this.cjob=0;this.monitorInterval=3000;this.monitorMaxCount=1000000000;this.backendThreshold=60*1000*1000;}
jobController.prototype.nextJob=function(){var ln=this.theJobs.length;this.cjob=this.cjob+1;if(this.cjob>=ln){this.progressBar.allDone();return;}
this.startJob();}
jobController.prototype.monitor=function(job){function mylog(){if(0)console.log(idv.util.elapsedTime(),"monitor",idv.util.argsToString(arguments));}
mylog("starting monitor",this.canceled,job.kind,job.status);if(this.canceled){return;}
var thisHere=this;var topic=job.topic;url="/topic"+topic+"/get()";mylog("getting ",url);idv.util.post(url,null,function(rs){thisHere.monitorCount=thisHere.monitorCount+1;if(rs){var job=rs.value;mylog("got",job.kind,job.status,job.so_far,job.total);if(job.status=="error"){thisHere.onError(job);return;}
thisHere.progressBar.update(job);if(job.status=="done"){mylog("next job"); if((job.kind=="retrieve")||(job.kind=="upload")){var sb=job.subject;var sbo=JSON.parse(sb);var dims=sbo.dimensions;var area=dims.x*dims.y;if(area>thisHere.backendThreshold){thisHere.progressBar.allDone(area); var abc=122;}else{thisHere.nextJob();}}else{thisHere.nextJob();}
return;}}
if(thisHere.monitorCount>thisHere.monitorMaxCount)return;if((job.status=="active")||(job.status=="not_started")){setTimeout(function(){thisHere.monitor(job);},thisHere.monitorInterval);}});}
jobController.prototype.cancel=function(){this.canceled=1;var j=this.theJobs[this.cjob];this.onCancel(j);}
jobController.prototype.startFirstJob=function(){this.cjob=0;this.startJob();}
var testing=66;jobController.prototype.startJob=function(){function mylog(){if(0)console.log(idv.util.elapsedTime(),"startJob",idv.util.argsToString(arguments));}
if(this.canceled){return;}
var j=this.theJobs[this.cjob];var topic=j.topic;var topics=topic.split("/");var jId=topics[topics.length-1];var jurl="/api/runJob?id="+jId;var thisHere=this;if(j.kind=="upload"){thisHere.monitorCount=0;thisHere.monitor(j);this.initProgressBar(this,j,function(){thisHere.nextJob();});var f=this.uploadForm;f.attr("action",jurl);f.submit();}else{mylog("starting job",j.kind);idv.util.get(jurl,function(rs){mylog("job started",rs.status,j.kind,j.noMonitoring);if(rs.status=="ok"){thisHere.initProgressBar(thisHere,j);if(j.noMonitoring){thisHere.nextJob();}else{thisHere.monitorCount=0;thisHere.monitor(j);}}else{if(rs.msg=="sessionTimedOut"){util.logout();location.href="/timeout";return;}
j.error=rs.msg;j.msg=rs.msg;thisHere.onError(j);}});}}
function forMinimizer(){alert(22);}
