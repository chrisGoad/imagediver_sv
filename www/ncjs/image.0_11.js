(function(){var lib=page;var geom=exports.GEOM2D;var imlib=exports.IMAGE;var com=idv.common;var util=idv.util;lib.interpolateCoverage=function(startCov,destCov,v){if(v>=1)v=1;lib.animationUnderway=true;var covNow=startCov.interpolate(destCov,v);var covRect=geom.internalizeRect(covNow);lib.vp.setCoverage(covRect);lib.zSlider.positionSliderFromZoom(lib.vp.zoom);if(v<1){setTimeout(function(){lib.interpolateCoverage(startCov,destCov,v+0.1);},50);}else{page.zooming=false;lib.vp.refreshOverlays();lib.zSlider.setZoom(lib.zSlider.getZoom());}}
lib.immediateZoomToSnap=function(snapD,scale){if(!scale)scale=1.1;var cov=snapD.coverage;var scov=cov.scale(scale);var covRect=geom.internalizeRect(scov);lib.vp.setCoverage(covRect);lib.zSlider.positionSliderFromZoom(lib.vp.zoom);}
lib.animatedZoomToSnap=function(snapD,scale){page.zooming=true;var startCov=lib.vp.coverage();if(!scale)scale=1.1;var destCov=snapD.coverage.scale(scale);lib.interpolateCoverage(startCov,destCov,0);}
lib.zoomToSelectedSnap=function(){lib.vp.setZoom(1);lib.animatedZoomToSnap(lib.selectedSnap.snapD,1.1);}})();
(function(){var lib=page;var geom=exports.GEOM2D;var imlib=exports.IMAGE;var com=idv.common;var util=idv.util;lib.scaleDivForPanel=function(panel){return;util.log("scale",panel.name);if(panel.selfScaling)return;var scalable=panel.scalable;var iht=panel.height;if(iht){if(scalable){var ht=lib.scale*iht;}else{ht=iht;}}else{ht=null;}
lib.panelDiv.css("height",ht);}
lib.resizeCurrentPanel=function(){if(!lib.currentPanel)return;var pn=lib.currentPanel.panel;var resizer=pn.data("resizer");if(resizer){resizer();}} 
lib.selectPanel=function(panelName,initData,dontCallInitializer){if(lib.currentPanel){lib.lastPanel=lib.currentPanel;}
if(typeof(panelName)!="string"){panelName=panelName.name;}
var selPanel=lib.panels[panelName];
var selActv=selPanel.activator;for(var nm in lib.panels){var cpan=lib.panels[nm];var cpn=cpan.panel;var actv=cpan.activator;if(!cpn)continue;if(nm==panelName){if(lib.currentPanel==cpan)continue;if(actv){lib.selectClickable(actv);}
if(lib.vp){if(!lib.showSnapsMode)lib.vp.clearOverlays();}
cpn.show();lib.scaleDivForPanel(cpan);lib.currentPanel=cpan;var initializer=cpn.data("initializer");if(initializer&&!dontCallInitializer){if(initData){initializer(initData);}else{initializer();}}}else{if(actv&&selActv){ lib.enableClickable(actv);}
cpn.hide();}}}
lib.setPanelPanel=function(name,panel){var pn=lib.panels[name];if(!pn){pn={panel:panel,name:name};lib.panels[name]=pn;return pn;}
pn.panel=panel;return pn;}
lib.setPanelNominalHeight=function(name,ht){var pn=lib.panels[name];pn.nominalHeight=ht;}
lib.setPanelActivator=function(name,activator){var pn=lib.panels[name];if(!pn){pn={activator:activator,name:name};lib.panels[name]=pn;return pn;}
pn.activator=activator;return pn;}
lib.hookupPanelActivator=function(name){var pnd=lib.panels[name];var actv=pnd.activator;if(pnd&&actv){lib.setClickMethod(actv,function(){lib.selectPanel(name);})
actv.mousedown(function(e){e.preventDefault();});}}
lib.hookupPanelActivators=function(){for(nm in lib.panels){lib.hookupPanelActivator(nm);}}
lib.pathLast=function(p){var sp=p.split("/");var ln=sp.length;return sp[ln-1];}
lib.setPanelDivHeight=function(ht){lib.panelDiv.css("height",ht);var ofs=lib.panelDiv.offset();}})();

(function(){var lib=page;var geom=exports.GEOM2D;var imlib=exports.IMAGE;var com=idv.common;var util=idv.util;lib.createAlbumWd=450;lib.createAlbumDiv=$('<div class="createlbumDiv" style="margin:20px">'+'<div id="createAlbumExplanation" style="text-align:center;margin-bottom:10px"></div>'+'<table id="albumFields">'+'<tr><td class="inputsTD">Album Title<td><td><input style="width:'+lib.createAlbumWd+'px" id="albumCaption" type="text"/></td></tr>'+'<tr><td class="inputsTD"></td><td></td><td>To include links or other formatting in the description, use <a target="_blank" href="http://en.wikipedia.org/wiki/Creole_(markup)">creole wikitext</a></td></tr>'+'<tr><td class="inputsTD">Description<td><td><textarea style="width:'+lib.createAlbumWd+'px"  rows="10" id="albumDescription"/></td></tr>'+
'</table>'+'<div id="createAlbumButtons" class="buttonLine">'+'<span id="submitAlbum" class="clickableElement">Create Album</span>'+'<span id="cancelAlbum" class="clickableElement">Cancel</span>'+'</div>'+'</div>');lib.albumDivInitializer=function(){lib.editingAlbum=false;$('#createAlbumExplanation').html('Creating a New Album');$('#albumCaption').attr("value","");$('#albumDescription').attr("value","");$('#submitAlbum').html("Create Album (and go there)");};lib.albumsDiv=$('<div class="albumsDiv">'+'<div class="albumLine" id="aboutOtherAlbums"><span id="aboutOtherAlbumsExplanation"></span><span id="otherAlbums"></span></div>'+'<div class="albumLine" id="albumExplanation">An album is a group of snapshots from an image.</div>'+'</div>'); lib.albumsHtml=function(dst,albums,thisAlbumTopic){dst.empty();var ln=albums.length;for(var i=0;i<ln;i++){var ca=albums[i];if(ca.topic==thisAlbumTopic)continue;var cc=ca.caption;var uname=ca.ownerName;if(i<ln-1)comma=",";else comma="";if(uname){var bywho=" by "+uname;}else{bywho=""}
var aline=$('<span class="albumLink"><span>'+cc+'</span> '+bywho+comma+' </span>');dst.append(aline);(function(tp){ aline.click(function(){util.navigateToPage(util.publishedUrl(tp));});})(ca.topic);}}
lib.albumsDiv.data("initializer",function(){var albums=lib.albumDs;var ln=albums.length;var album=lib.albumD;if(album){$('#albumOwner').html("The owner of this album is: "+lib.pathLast(album.owner));var atp=album.topic;if(ln==1){$('#aboutOtherAlbumsExplantion').html('Published Album:');}else{$('#aboutOtherAlbumsExplanation').html('Other published albums for this image:');}}else{atp="";if(ln==0){$('#aboutOtherAlbumsExplanation').html('There are no public albums associated with this image.');}else{$('#aboutOtherAlbumsExplanation').html('Published albums:');}}
var oae=$('#otherAlbums');oae.empty();lib.albumsHtml(oae,albums,atp);});lib.deleteAlbumDiv=$('<div id="deleteAlbum">'+'<div class="areYouSure">Are you sure you wish to delete this album, and its snapshots? There is no undo.</div>'+'<div>'+'<span  style="margin-left:20px" id="yesDeleteAlbum" class="clickableElement">Yes, Delete</span>'+'<span   id="noDontDeleteAlbum" style="margin-left:30px"  class="clickableElement">Cancel</span>'+'</div>'+'</div>');lib.createAlbumFieldValues=function(){var rs={};rs.caption=$('#albumCaption').attr("value");var ds=$('#albumDescription').attr("value");rs.description=ds;return rs;}
lib.createOrEditAlbum=function(edit,imTopic){if(!imTopic)imTopic=lib.imD.topic;var sdata=lib.createAlbumFieldValues();var data={caption:sdata.caption,description:sdata.description};data.image=imTopic;if(edit){var url="/api/editAlbum";data.topic=lib.albumD.topic;}else{var url="/api/addAlbum";}
var cb=lib.createAlbumCallback;var a=lib.albumD;util.post(url,data,function(rs){util.log("api","data returned",rs);if(rs.status!="ok"){util.logout();location.href="/timeout"
return;}
if(edit){var vl=rs.value;util.setProperties(a,vl,["description","caption"]);lib.updateTopbarOptions(lib.topbar.options);lib.topbar.render();lib.popAlbumDetails();}else{location.href="/topic"+rs.value.topic;}
},"json");util.log("api","uuuuu");} 
lib.deleteTheAlbum=function(){var data={topic:lib.albumD.topic};var url="/api/deleteAlbum";var imtp=lib.albumD.image.topic;util.post(url,data,function(rs){if(rs.status!="ok"){util.logout();location.href="/timeout";return;}
location.href="/mywork";},"json");util.log("api","uuuuu");}
lib.createTheAlbum=function(imTopic){lib.createOrEditAlbum(false,imTopic);}
lib.editTheAlbum=function(){lib.createOrEditAlbum(true);}
lib.popCreateAlbumLightbox=function(imTopic){lib.lightbox.pop(false,350);lib.lightbox.element.empty();lib.lightbox.addClose();lib.lightbox.element.append(lib.createAlbumDiv);lib.editingAlbum=true;$('#submitAlbum').click(function(){lib.createTheAlbum(imTopic);});$('#cancelAlbum').click(function(){lib.lightbox.dismiss();});return;}
lib.addAlbumsDiv=function(container){container.append(lib.albumsDiv);lib.setPanelPanel("albums",lib.albumsDiv);return;}
lib.popEditAlbumLightbox=function(){lib.lightbox.pop();lib.lightbox.element.empty();lib.lightbox.addClose();lib.lightbox.element.append(lib.editAlbumDiv);$('#submitAlbum',lib.editAlbumDiv).click(function(){lib.editTheAlbum();});$('#cancelAlbum',lib.editAlbumDiv).click(function(){lib.popAlbumDetails();});lib.editAlbumInitializer(false);return;}})();

(function(){var lib=page;var geom=exports.GEOM2D;var imlib=exports.IMAGE;var com=idv.common;var util=idv.util;lib.licenseOptions=["PD-old: Public Domain where the author died more thn 100 years ago","PD-self: A statement intended to release your own work into public domain","PD-author: A statement that the work is released into the public domain by its author","cc-by-3.0: Creative Commons Attribution 3.0","cc-by-sa-3.0:Creative Commons Attribution-ShareAlike 3.0","Copyright &lt;author(above)&gt; &lt;year(above)&gt;","Other"]
lib.copyrightIndex=4;lib.licenseOptions=["No License Asserted (retain all rights)","PD-old: Public Domain where the author died more thn 100 years ago","PD-self: A statement intended to release your own work into public domain","PD-author: A statement that the work is released into the public domain by its author","cc-by-3.0: Creative Commons Attribution 3.0","cc-by-sa-3.0:Creative Commons Attribution-ShareAlike 3.0",]
lib.licenseCode=function(opt){if(!opt)return"none";var sp=opt.split(":");if(sp.length==1){return"none"}else{return sp[0];}}
lib.licenseIdx=function(cd){}
lib.genLicenseOption=function(n){return"<option style='width:200px' id='option"+n+"' value = '"+n+"'>"+lib.licenseOptions[n]+"</option>";}
lib.genLicenseOptions=function(){var rs="";var ln=lib.licenseOptions.length;lib.licenseIndices={};for(var i=0;i<ln;i++){var opt=lib.licenseOptions[i];var cd=lib.licenseCode(opt);lib.licenseIndices[cd]=i;rs+=lib.genLicenseOption(i);}
return rs;}
lib.editImageWd=450;lib.editImageDiv=$('<div class="editImageDiv">'+"<div id='editNote'>This is a shared image, imported by another user, so you can't edit its properties. Only the album title and description are available for editing.</div>"+'<table id="imageFields">'+'<tr class="forImage"><td class="inputsTD">Identifier</td><td><span id="imageID"></span></td></tr>'+'<tr class="forImage"><td class="inputsTD">Title</td><td><input style="width:'+lib.editImageWd+'px" id="imageTitle" type="text"/></td></tr>'+'<tr class="forImage"><td class="inputsTD"></td><td>To include links or other formatting in the description, use <a target="_blank" href="http://en.wikipedia.org/wiki/Creole_(markup)">creole wikitext</a></td></tr>'+'<tr class="forImage"><td class="inputsTD">Description</td><td><textarea style="width:'+lib.editImageWd+'px" rows="5"  id="imageDescription"/></td></tr>'+'<tr class="forImage"><td class="inputsTD">Artist/<br/>Photographer</td><td><input style="width:'+lib.editImageWd+'px" id="imageAuthor" type="text"/></td></tr>'+'<tr class="forImage"><td class="inputsTD">Year Created</td><td><input style="width:'+lib.editImageWd+'px" id="imageYear" type="text"/></td></tr>'+'<tr class="forImage"><td class="inputsTD">Tags</td><td><input style="width:'+lib.editImageWd+'px" id="imageTags" type="text"/></td></tr>'+'<tr class="forImage"><td class="inputsTD" id="externalLinkLabel">External Link</td><td><input style="width:'+lib.editImageWd+'px" id="imageExternalLink" type="text"/></td></tr>'+
'<tr class="forImage"><td class="inputsTD">Dimensions</td><td id="imageDimensions"></td></tr>'+
'<tr id="imageErrorRow"><td class="inputsTD">Error</td><td style="color:red" id="imageErrorMessage">restrict</td></tr>'+'</table>'+'<div class="forImage">License. (<a href="/license">About licensing</a>) </div>'+'<div class="forImage" id="licenseDiv"><select id="licenseSelect">'+lib.genLicenseOptions()+'</select></div>'+'<hr/>'+'<div id="albumNote">Properties of this album of annotations, as opposed to the image itself (optional)</div>'+'<table id="albumFields">'+'<tr><td class="inputsTD" id="albumTitleLabel">Title</td><td><input style="width:'+lib.editImageWd+'px" id="albumTitle" type="text"/></td></tr>'+'<tr><td class="inputsTD">Description</td><td><textarea style="width:'+lib.editImageWd+'px" rows="3"  id="albumDescription"/></td></tr>'+'</table>'+'<div id="editImageButtons" class="editImageLine">'+'<span id="submitImageEdit" class="clickableElement">Save</span>'+'<span id="cancelImageEdit" class="clickableElement">Cancel</span>'+'</div>'+'</div>');lib.editImageInitializer=function(){lib.canEdit=lib.imD.owner==lib.albumD.owner;
var erow=$('#imageErrorRow');erow.hide();var imD=page.imD;if(0&&lib.imageDeleteable()){ $('#publicOnlyRow').hide();var imPublic=imD.isPublic;if(imPublic){$('#publicImage').attr('checked','checked');}else{$('#privateImage').attr('checked','checked');}}else{$('#publicToggleRow').hide();}
if(lib.canEdit){var tp=imD.topic;var id=util.lastPathElement(tp);$('#imageID').html(id);var ttl=imD.title;if(imD.description)ds=imD.description;else ds="";$('#imageTitle').val(ttl);$('#albumTitle',lib.editImageDiv).val(lib.albumD.caption);$('#albumDescription',lib.editImageDiv).val(lib.albumD.description);$('#imageDescription',lib.editImageDiv).val(ds);$('#imageAuthor').val((imD.author)?(imD.author):'');$('#imageYear').val((imD.year)?(imD.year):'');$('#imageTags').val((imD.tags)?imD.tags.join(", "):'');$('#imageExternalLink').val((imD.externalLink)?(imD.externalLink):'');var dim=imD.dimensions;var dims=dim.x+" pixels wide by "+dim.y+" pixels high";$('#imageDimensions').html(dims);var lic=imD.license;var lidx=lib.licenseIndices[lic];$('#licenseSelect').attr('value',lidx);$('#editNote').hide();util.addToolTip($('#externalLinkLabel',lib.editImageDiv),"An external URL (eg a wikipedia page) associated with the album. Leave blank if not applicable");}else{$('#albumTitle',lib.editImageDiv).val(lib.albumD.caption);$('#albumDescription',lib.editImageDiv).val(lib.albumD.description);$('#editNote').css({'margin':'10px'});$('.forImage').hide();}}
lib.editImageFieldValues=function(){var rs={};rs.title=util.htmlRemove($('#imageTitle').attr("value"));rs.author=util.htmlRemove($('#imageAuthor').attr("value"));rs.description=$('#imageDescription').attr("value");rs.albumTitle=util.htmlRemove($('#albumTitle').attr("value"));
rs.albumDescription=$('#albumDescription').attr("value");rs.externalLink=$('#imageExternalLink').attr("value");rs.isPublic=(0&&lib.imageDeleteable())?(($('#publicImage').attr('checked')=='checked')?1:0):1;var slo=$('#licenseSelect').attr("value");var lo=lib.licenseOptions[slo];var lc=lib.licenseCode(lo);rs.license=lc;var yr=$('#imageYear').attr("value");if($.trim(yr)){rs.year=yr;}else{rs.year="";}
var tags=$.trim($('#imageTags').attr("value"));if(tags==""){var tagsf=[];}else{var tagsp=tags.split(",");var isErr=false;var re=/^[\w\ ]*$/;var tagsf=idv.util.arrayMap(tagsp,function(tag){var tr=$.trim(tag);if(!re.test(tr)){isErr=true;}
return tr;});if(isErr){return{"error":"Tags may include only alpha-numeric characters, digits, and spaces"};}}
rs.tags=tagsf;return rs;}
lib.editImageCallback=function(rs){var vl=rs.value;page.imD.description=vl.description;page.imD.title=vl.title;var imd=lib.computeAboutText();page.updateTopbarOptions(page.topbar.options);page.topbar.render()
lib.popImageDetails();}
lib.editTheImage=function(){if(lib.canEdit){var imD=page.imD;var sdata=lib.editImageFieldValues();var erow=$('#imageErrorRow');erow.show();if(sdata.error){var msg=$('#imageErrorMessage');msg.html(sdata.error);return;}
erow.hide();var data={image:imD.topic,albumTopic:lib.albumD.topic}
util.setProperties(data,sdata,["title","description","author","externalLink","year","isPublic","license","albumTitle","albumDescription","tags"]);util.setProperties(imD,sdata,["title","description","author","externalLink","year","license","tags"]);lib.albumD.caption=sdata.albumTitle;lib.albumD.description=sdata.albumDescription;var url="/api/editImage";var cb=lib.editImageCallback;util.post(url,data,function(rs){util.log("api","data returned",rs);if(rs.status!="ok"){util.logout();location.href="/timeout";return;}
cb(rs);},"json");util.log("api","uuuuu");}else{var sdata=lib.editImageFieldValues();var data={caption:sdata.albumTitle,description:sdata.albumDescription};data.image=lib.imD.topic;data.topic=lib.albumD.topic;var url="/api/editAlbum";util.post(url,data,function(rs){if(rs.status=="ok"){lib.albumD.caption=data.caption;lib.albumD.description=data.description;lib.updateTopbarOptions(lib.topbar.options);lib.topbar.render()
lib.popImageDetails();}else{util.logout();location.href="/timeout"
return;}});}}
lib.cancelEditImage=function(){lib.popImageDetails();}
lib.popEditImageLightbox=function(){lib.lightbox.pop();lib.lightbox.element.empty();lib.lightbox.addClose();lib.lightbox.element.append(lib.editImageDiv);$('#editImageButtons',lib.editImageDiv).css({"margin-top":"10px"});lib.editImageDiv.css({"margin-left":"10px"});var sie=$('#submitImageEdit');var cie=$('#cancelImageEdit')
sie.click(lib.editTheImage);cie.click(function(){lib.popImageDetails();});lib.editImageInitializer();}
lib.addEditImageDiv=function(container){}})();
(function(){var lib=page;var geom=exports.GEOM2D;var imlib=exports.IMAGE;var com=idv.common;var util=idv.util;page.wideLayout=false; idv.pageKind=="image";lib.licenseText={"PD-old":'<a href="http://en.wikipedia.org/wiki/Public_domain">Public Domain</a> in the United States, and those countries with a copyright term of life of the author plus 100 years or less',"PD-author":'Released into the <a href="http://en.wikipedia.org/wiki/Public_domain">Public Domain</a> by the author',"PD-self":'Released into the <a href="http://en.wikipedia.org/wiki/Public_domain">Public Domain</a> by the author',"cc-by-sa-3.0":'Creative Commons Attribution-ShareAlike 3.0',"cc-by-3.0":'<a href="http://creativecommons.org/licenses/by/3.0/">Creative Commons Attribution 3.0</a>'}
lib.renderControls=function(container){var cnt=container;var elements={};var albums=lib.albumDs;var ln=albums.length;if((ln>0)||idv.loggedInUser){lib.someAlbums=true;lib.setPanelPanel("albums",lib.albumsDiv);}else{lib.someAlbums=false;}
if(idv.loggedInUser){var createAlbumActivator=$('<span style="float:right" class="clickableElement">Create New Album</span>');createAlbumActivator.click(function(){lib.popCreateAlbumLightbox();});cnt.append(createAlbumActivator);}
var setZoom=function(z){lib.vp.setZoom(z);};var getZoom=function(){return lib.vp.zoom;};var zmropts={container:cnt,maxZoom:lib.vp.maxZoom,setZoom:setZoom,getZoom:getZoom,zoomIncrement:1.05,zoomFactor:2,zoomDelay:50};var zmr=new idv.zoomSlider(zmropts);lib.zSlider=zmr;lib.vp.zoomCallbacks.push(function(z){lib.zSlider.positionSliderFromZoom(z);});var viewAll=$('<span class="clickableElement">view all</span>');viewAll.css({left:lib.zSlider.totalWidth+10,top:5,position:"absolute"});cnt.append(viewAll);viewAll.click(function(){lib.vp.setZoom(1);});var gap=$('<div class="gap"></div>');container.append(gap);if(lib.image_only){lib.stdSnapAdvice="the yellow outline above shows the area of interest";var snapAdvice=$('<span></span>');snapAdvice.html(lib.stdSnapAdvice);snapAdvice.hide();
snapAdvice.css({"font-style":"italic",left:340,top:10,position:"absolute"})
lib.snapAdvice=snapAdvice;cnt.append(snapAdvice);var zoomToSnap=$('<span class="clickableElement">zoom to outline</span>');zoomToSnap.css({left:lib.zSlider.totalWidth+10+70,top:5,position:"absolute"});lib.zoomToSnap=zoomToSnap;cnt.append(zoomToSnap);zoomToSnap.click(function(){lib.vp.setZoom(1);lib.animatedZoomToSnap(lib.selectedSnap,1.1);});}}
lib.setParams=function(imD){var imTopic=imD.topic
lib.imName=imTopic.split("/")[2]
lib.zoomDelay=50;lib.zoomIncrement=1.05;lib.maxZoom=256; lib.initialZoom=1;var dim=imD.dimensions;var x=dim.x;var y=dim.y;var aar=x/y;lib.imageAspectRatio=aar;if(true||aar>1.5){lib.aspectRatio=2; lib.twoColumns=false;}else{lib.aspectRatio=1;lib.twoColumns=true;}
lib.selectedSnapPanelHeight=400;lib.imD=imD; lib.image=new imlib.Image(imD);lib.tiling=new imlib.Tiling(lib.image,256,1,imD.tilingDepthBump);lib.maxDepth=lib.tiling.depth;}
lib.scaleRect=function(rect,corner,scale){var nex=rect.extent.times(scale);var rs=new geom.Rect(corner,nex);return rs;}
lib.defaultPanelHeight=function(){return lib.standardPanelHeight*lib.theLayout.scale;}
lib.placeDivs=function(){lib.theLayout.placeDivs();lib.vp.scale=lib.theLayout.scale;lib.vp.refresh();}
lib.computeAboutText=function(){var imD=lib.imD;var imd=""
if(imD.title){imd+="{{{"+imD.title+"}}}";}
if(imD.author){imd+=" by "+imD.author}
imd+="\n\n"
var ds=imD.description;if(ds){imd+=ds}
return imd;}
lib.updateTopbarOptions=function(options){var imD=lib.imD;var author=imD.author;if(author){author=", "+author;}else{author="";}
if(imD.title){var title=imD.title;}else{title=imD.name;}
options.title=util.sanitize(title+author);}
lib.imageDetailsWd=200;lib.imageDetailsDiv=$('<div class="imageDetailsDiv">'+'<div id="title"></div>'+'<div id="description"></div>'+'<table id="imageFields">'+'<tr id="authorRow"><td  class="rowTitle">Artist/Photographer:</td><td class="rowValue"><span style="width:'+lib.imageDetailsWd+'px" id="author"/></td></tr>'+'<tr  id="yearRow"><td  class="rowTitle">Year:</td><td class="rowValue"><span style="width:'+lib.imageDetailsWd+'px" id="year"/></td></tr>'+'<tr id="externalLinkRow" ><td class="rowTitle">External Link:</td><td class="rowValue"><span style="width:'+lib.imageDetailsWd+'px" id="externalLink"/></td></tr>'+'<tr id="contributorRow" ><td class="rowTitle">Contributed by:</td><td class="rowValue"><span style="width:'+lib.imageDetailsWd+'px" id="contributor"/></td></tr>'+'<tr class="dimensionRow"><td class="rowTitle">Dimensions:</td><td class="rowValue"><span style="width:'+lib.imageDetailsWd+'px" id="dimensions"/></td></tr>'+'<tr class="publicRow"><td id="isPublic" class="rowTitle">Public</td></tr>'+'<tr id="licenseRow" ><td class="rowTitle">License:</td><td class="rowValue"><span style="width:'+lib.imageDetailsWd+'px" id="license"/></td></tr>'+'</table>'+'<div id="buttons"><span id="editButton" class="clickableElement">Edit Image Properties</span><span id="deleteButton" class="clickableElement">Delete the Image</span><span style="margin-left:20px" id="buttonMsg">Not deleteable (public, in use)</span></div>'+'</div>');lib.deleteTheImage=function(){var data={topic:lib.imD.topic};var url="/api/deleteImage";util.post(url,data,function(rs){if(rs.status!="ok"){util.logout();location.href="/timeout";return;}
location.href="/mywork"},"json");util.log("api","uuuuu");}
lib.popImageDetails=function(){lib.lightbox.pop();lib.lightbox.element.empty();lib.lightbox.addClose();function adjustLightBoxHeight(){var ht=lib.imageDetailsDiv.height();var lbh=lib.lightbox.element.height();lib.lightbox.element.css({"height":(ht+40)+"px"});}
lib.imageDeleteable=function(){ var aln=lib.allAlbumDs.length;if(aln==0)return true;var imowner=lib.imD.owner;for(var i=0;i<aln;i++){var calb=lib.allAlbumDs[i];if(calb.owner!=imowner){return false;}}
return true;}
lib.lightbox.element.append(lib.imageDetailsDiv);if($.trim(lib.imD.description)){var dst=$("#description",lib.imageDetailsDiv);dst.empty();dst.css({"word-wrap":"break-word"});util.creole.parse(dst[0],lib.imD.description);}else{$("#descriptionRow",lib.imageDetailsDiv).hide();}
$("#title",lib.imageDetailsDiv).css({"font-weight":"bold","margin-left":"10px","margin-right":"10px","margin-top":"10px","text-align":"center"});$("#imageFields",lib.imageDetailsDiv).css({"margin-left":"10px","margin-right":"10px","margin-top":"10px"});$(".rowTitle",lib.imageDetailsDiv).css({"padding-left":"10px","padding-right":"20px"});$("tr",lib.imageDetailsDiv).css({"padding-top":"10px"});$("#buttons",lib.imageDetailsDiv).css({"margin":"30px"});var ttl=$.trim(lib.imD.title);if(!ttl){ttl="Untitled"}
$("#titleRow",lib.imageDetailsDiv).show();$("#title",lib.imageDetailsDiv).html(util.sanitize(ttl));var ownm=lib.imD.ownerName;var cdiv=$("#contributor",lib.imageDetailsDiv);if(ownm){cdiv.show()
cdiv.html(util.sanitize(lib.imD.ownerName));}else{$('#contributorRow').hide();}
if($.trim(lib.imD.author)){$("#authorRow",lib.imageDetailsDiv).show();
$("#author",lib.imageDetailsDiv).html(util.sanitize(lib.imD.author));}else{$("#authorRow",lib.imageDetailsDiv).hide();}
if($.trim(lib.imD.year)){$("#yearRow",lib.imageDetailsDiv).show();$("#year",lib.imageDetailsDiv).html(util.sanitize(lib.imD.year));}else{$("#yearRow",lib.imageDetailsDiv).hide();}
var lnk=$.trim(lib.imD.externalLink);if(lnk){$("#externalLinkRow",lib.imageDetailsDiv).show();var edv=$("#externalLink",lib.imageDetailsDiv);var a=$('<a>');var sanlnk=util.sanitize(lnk);a.attr("href",lnk);a.attr("target","imagediverTarget");edv.empty();edv.append(a);a.html(sanlnk);}else{$("#externalLinkRow",lib.imageDetailsDiv).hide();}
var dim=lib.imD.dimensions;var dims=dim.x+" pixels wide by "+dim.y+" pixels high";$('#dimensions',lib.imageDetailsDiv).html(dims);if(lib.imD.isPublic){var pubtxt="Public";}else{pubtxt="Private";}
$('#isPublic',lib.imageDetailsDiv).html(pubtxt);var lic=lib.imD.license;if((!lic)||(lic=="none")){$('#licenseRow').hide();}else{$('#license').html(lib.licenseText[lic]);}
if(idv.loggedInUser&&(lib.imD.owner==idv.loggedInUser)){$("#buttons",lib.albumDetailsDiv).show();$("#editButton",lib.imageDetailsDiv).click(function(){lib.popEditImageLightbox();});if(lib.imageDeleteable()){$("#buttonMsg").hide();$("#deleteButton",lib.imageDetailsDiv).click(function(){lib.lightbox.tempDismiss();var aln=lib.allAlbumDs.length;if(aln>1){var msg="Are you sure you wish to delete this image, and all of its "+aln+" albums?"}else if(aln==1){var msg="Are you sure you wish to delete this image, and its album?"}else{msg="Are you sure you wish to delete this image?"}
util.myConfirm("Delete Image",msg,function(){lib.deleteTheImage();},function(){util.closeDialog();lib.lightbox.bringBack();});});}else{$("#deleteButton").hide();$("#buttonMsg").show();}}else{$("#buttons",lib.albumDetailsDiv).hide();}
}
lib.genDivs=function(){var b=$('body');var imD=lib.imD;var topbarOptions={embed:idv.embed,detailsLink:{text:"image details",action:lib.popImageDetails},includeGallery:1};lib.updateTopbarOptions(topbarOptions);var twoC=page.twoColumns;if(lib.image_only)twoC=false;if(twoC){var outerDiv=$("<div class='outerDiv'/>");if(!idv.embed)lib.topbar=imlib.genTopbar(outerDiv,topbarOptions);lib.outerDiv=outerDiv;b.append(outerDiv);var colsDiv=$("<div class='columns'/>")
outerDiv.append(colsDiv);var c0Div=$("<div class='leftColumnDiv'/>");lib.c0Div=c0Div;colsDiv.append(c0Div);var c1Div=$("<div class='columnDiv'/>");lib.c1Div=c1Div;colsDiv.append(c1Div);}else{var c1Div=$("<div class='columnDiv'/>");lib.c1Div=c1Div;b.append(c1Div);if(!idv.embed&&!lib.image_only)lib.topbar=imlib.genTopbar(c1Div,topbarOptions);if(lib.image_only){var titleDiv=$('<div class="titleDiv"/>');titleDiv.css({"text-align":"center","margin":"10px"});c1Div.append(titleDiv);}
}
lib.vpDiv=$('<div class="viewport"/>');lib.panelDiv=$('<div class="snapshots" />'); lib.panelDiv.css("overflow","auto");lib.panels={};lib.bottomDiv=$('<div class="bottomDiv"></div>');c1Div.append(lib.vpDiv);lib.controlDiv=$('<div class="controls"/>');c1Div.append(lib.controlDiv);var evDiv=$('<div id="evDiv"></div>');evDiv.css({"position":"absolute","background-color":"transparent"});lib.evDiv=evDiv;lib.vpDiv.append(evDiv);if(twoC){c0Div.append(lib.panelDiv);lib.theLayout=new lib.LayoutTwo({outerDiv:lib.outerDiv,colsDiv:colsDiv,leftDiv:lib.c0Div,rightDiv:lib.c1Div,panelDiv:lib.panelDiv,vpDiv:lib.vpDiv,evDiv:lib.evDiv,margin:20,aspectRatio:lib.aspectRatio,minScale:0.5,additionalHeight:120,includeLightbox:true});}else{if(!lib.image_only)c1Div.append(lib.panelDiv);lib.theLayout=new lib.LayoutOne({centerDiv:c1Div,margin:20,aspectRatio:lib.aspectRatio,minScale:0.5,vpDiv:lib.vpDiv,evDiv:lib.evDiv,additionalHeight:lib.image_only?100:180,scaleToViewport:true,includeLightbox:!lib.image_only});}
lib.addAlbumsDiv(lib.panelDiv)
if(idv.loggedInUser){lib.addEditImageDiv(lib.panelDiv);}
lib.theLayout.placeDivs();if(lib.topbar){lib.topbar.lightbox=lib.theLayout.lightbox;}
lib.lightbox=lib.theLayout.lightbox;var vpExtent=lib.theLayout.vpExtent;lib.vpCanvas=imlib.genCanvas({whichCanvas:"vp",extent:vpExtent,container:lib.vpDiv,zIndex:100,backgroundColor:"#000000"});lib.ovCanvas=imlib.genCanvas({whichCanvas:"ov",extent:vpExtent,container:lib.vpDiv,zIndex:200,backgroundColor:"transparent"}); if(!idv.useFlash){lib.selCanvas=imlib.genCanvas({whichCanvas:"sel",extent:vpExtent,container:lib.vpDiv,zIndex:300,backgroundColor:"transparent"}); lib.hiliCanvas=imlib.genCanvas({whichCanvas:"hili",extent:vpExtent,container:lib.vpDiv,zIndex:400,backgroundColor:"transparent"});}
lib.theLayout.placeDivs();lib.theLayout.afterPlacement=function(){if(lib.vp){var layout=lib.theLayout;lib.vp.scale=layout.scale;var vpCss=layout.vpCss;lib.vpCanvas.attr({width:layout.vpExtent.x,height:layout.vpExtent.y})
if(lib.ovCanvas)lib.ovCanvas.attr({width:layout.vpExtent.x,height:layout.vpExtent.y});if(lib.selCanvas)lib.selCanvas.attr({width:layout.vpExtent.x,height:layout.vpExtent.y});if(lib.hiliCanvas)lib.hiliCanvas.attr({width:layout.vpExtent.x,height:layout.vpExtent.y});lib.vp.refresh();}}}
lib.genViewports=function(){lib.tiling.createTiles();var vpExtent=lib.theLayout.vpExtent;var vp=new imlib.Viewport(lib.vpDiv,lib.vpCanvas,lib.tiling,vpExtent,[lib.ovCanvas,lib.selCanvas,lib.hiliCanvas]);lib.vp=vp;vp.zoom=lib.initialZoom;lib.vp=vp;imlib.mainVP=vp;vp.maxZoom=lib.maxZoom;vp.maxDepth=lib.maxDepth;vp.depthBump=lib.imD.zoomDepthBump;vp.depthBump=1;lib.renderControls(lib.controlDiv);lib.panControl=new imlib.PanControl(lib.vpDiv,vp);lib.vp.panControl=lib.panControl;}
lib.test=function(){var ov=new imlib.Overlay("test",new geom.Rect(new geom.Point(12000,2000),new geom.Point(5000,1000)));lib.vp.addOverlay(ov);}
lib.snapSelected="none";lib.selectSnap=function(idx){lib.snapSelected=idx;lib.snapAdvice.show();lib.zoomToSnap.show();var vp=lib.vp;lib.vp.setZoom(1);vp.clearOverlays(1);var snap=lib.snapsByIndex[idx];lib.selectedSnap=snap;var cv=snap.coverage;var nm=snap.topicId;var ov=new imlib.Overlay(nm,cv);vp.addOverlay(ov,1);vp.drawOverlays(1);$('.titleDiv').html(snap.caption);}
lib.selectMain=function(){lib.selectedSnap=undefined;lib.vp.clearOverlays("both");lib.snapAdvice.hide();lib.vp.setZoom(1);lib.zoomToSnap.hide();lib.snapAdvice.hide();var imD=lib.imD;var txt=imD.title;if(imD.author)txt+=", "+imD.author;$('.titleDiv').html(txt);}
lib.firstMessage=true;lib.czoom=1;lib.interpretMessage=function(msg){var mt=msg.match(/(\w*)\((\w*)\)/);if(mt){var cmd=mt[1];var arg=mt[2];if(cmd=="selectSnap"){var snapid=parseInt(arg);lib.vp.setZoom(1,false,true);if(lib.firstMessage){ setTimeout(function(){lib.selectSnap(snapid);},10);lib.firstMessage=false;}else{lib.selectSnap(snapid);}}else if(cmd="selectMain"){lib.selectMain();}}}
lib.addListener=function(){function receiveMessage(event){lib.interpretMessage(event.data);}
if(window.addEventListener){window.addEventListener("message",receiveMessage,false);}else{window.attachEvent("onmessage",receiveMessage);}}
lib.postMessageToParent=function(msg){var pr=window.parent;pr.postMessage(msg,"http://"+location.host);
}
lib.internalizeSnapD=function(snapD,sc){var cv=snapD.coverage;var ext=cv.extent;var crn=cv.corner;var nc=geom.internalizeRect({extent:{x:ext.x*sc,y:ext.y*sc},corner:{x:crn.x*sc,y:crn.y*sc}});snapD.coverage=nc;}
lib.finishInitialize=function(){if(lib.snapDs){lib.error("UNEXPECTED");lib.snapsByIndex={};var imx=lib.imD.dimensions.x;util.arrayForEach(lib.snapDs,function(snapD){var tp=snapD.topic;var idx=util.numberAtEnd(tp);lib.snapsByIndex[idx]=snapD;lib.internalizeSnapD(snapD,imx);snapD.topicId=idx;});}
lib.genDivs();lib.genViewports();util.addDialogDiv($('.columns'));lib.vpCapDiv=$('<div class="vpCap" id="viewport0" style="position:absolute;background-color:black;border:solid thin white;padding:3px;font-size:8pt;z-index:1000">TEST</div>');lib.vpDiv.append(lib.vpCapDiv);lib.vpCapDiv.hide();lib.vpSelectDiv=$('<div class="vpSelect" id="vpSelect" style="margin:0px;padding:0px;position:absolute;background-color:transparent;font-size:8pt;z-index:2000;border:solid yellow;border-width:2px;"></div>');lib.vpDiv.append(lib.vpSelectDiv);lib.vpSelectDiv.hide();$(window).resize(function(){util.log("resize",$(window).width());lib.placeDivs();lib.vp.refresh(true);});lib.placeDivs();lib.hookupPanelActivators();if(!lib.image_only){if(lib.someAlbums){lib.selectPanel("albums")}
}
lib.postMessageToParent("ready");}
lib.initialize=function(options){
idv.pageKind="image"; var albumDs=options.albums;var imD=options.imageD;var falbumDs=util.arrayFilter(albumDs,function(ad){return ad.published;});lib.allAlbumDs=albumDs;albumDs=falbumDs;util.commonInit();var ownern=util.lastPathElement(imD.owner)
lib.albumString=ownern+".0"; imlib.selectStrokeWidth=20;var qs=util.parseQS();lib.image_only=qs["image_only"];lib.album=qs["album"];lib.imD=imD;if(lib.image_only){lib.addListener();}
lib.setParams(imD);lib.albumDs=albumDs;var loggedInUser=options.loggedInUser;idv.loggedInUser=loggedInUser;if(lib.album){var jsonUrl=idv.util.jsonUrl(lib.album);idv.util.get(jsonUrl,function(rs){lib.snapDs=rs.value.snaps;lib.finishInitialize();});}else{lib.finishInitialize();}}})();
