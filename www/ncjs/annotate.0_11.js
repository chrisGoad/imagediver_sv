
(function(){var lib=page;var geom=exports.GEOM2D;var imlib=exports.IMAGE;var com=idv.common;var util=idv.util;lib.createAlbumWd=450;lib.createAlbumDiv=$('<div class="createlbumDiv" style="margin:20px">'+'<div id="createAlbumExplanation" style="text-align:center;margin-bottom:10px"></div>'+'<table id="albumFields">'+'<tr><td class="inputsTD">Album Title<td><td><input style="width:'+lib.createAlbumWd+'px" id="albumCaption" type="text"/></td></tr>'+'<tr><td class="inputsTD"></td><td></td><td>To include links or other formatting in the description, use <a target="_blank" href="http://en.wikipedia.org/wiki/Creole_(markup)">creole wikitext</a></td></tr>'+'<tr><td class="inputsTD">Description<td><td><textarea style="width:'+lib.createAlbumWd+'px"  rows="10" id="albumDescription"/></td></tr>'+
'</table>'+'<div id="createAlbumButtons" class="buttonLine">'+'<span id="submitAlbum" class="clickableElement">Create Album</span>'+'<span id="cancelAlbum" class="clickableElement">Cancel</span>'+'</div>'+'</div>');lib.albumDivInitializer=function(){lib.editingAlbum=false;$('#createAlbumExplanation').html('Creating a New Album');$('#albumCaption').attr("value","");$('#albumDescription').attr("value","");$('#submitAlbum').html("Create Album (and go there)");};lib.albumsDiv=$('<div class="albumsDiv">'+'<div class="albumLine" id="aboutOtherAlbums"><span id="aboutOtherAlbumsExplanation"></span><span id="otherAlbums"></span></div>'+'<div class="albumLine" id="albumExplanation">An album is a group of snapshots from an image.</div>'+'</div>'); lib.albumsHtml=function(dst,albums,thisAlbumTopic){dst.empty();var ln=albums.length;for(var i=0;i<ln;i++){var ca=albums[i];if(ca.topic==thisAlbumTopic)continue;var cc=ca.caption;var uname=ca.ownerName;if(i<ln-1)comma=",";else comma="";if(uname){var bywho=" by "+uname;}else{bywho=""}
var aline=$('<span class="albumLink"><span>'+cc+'</span> '+bywho+comma+' </span>');dst.append(aline);(function(tp){ aline.click(function(){util.navigateToPage(util.publishedUrl(tp));});})(ca.topic);}}
lib.albumsDiv.data("initializer",function(){var albums=lib.albumDs;var ln=albums.length;var album=lib.albumD;if(album){$('#albumOwner').html("The owner of this album is: "+lib.pathLast(album.owner));var atp=album.topic;if(ln==1){$('#aboutOtherAlbumsExplantion').html('Published Album:');}else{$('#aboutOtherAlbumsExplanation').html('Other published albums for this image:');}}else{atp="";if(ln==0){$('#aboutOtherAlbumsExplanation').html('There are no public albums associated with this image.');}else{$('#aboutOtherAlbumsExplanation').html('Published albums:');}}
var oae=$('#otherAlbums');oae.empty();lib.albumsHtml(oae,albums,atp);});lib.deleteAlbumDiv=$('<div id="deleteAlbum">'+'<div class="areYouSure">Are you sure you wish to delete this album, and its snapshots? There is no undo.</div>'+'<div>'+'<span  style="margin-left:20px" id="yesDeleteAlbum" class="clickableElement">Yes, Delete</span>'+'<span   id="noDontDeleteAlbum" style="margin-left:30px"  class="clickableElement">Cancel</span>'+'</div>'+'</div>');lib.createAlbumFieldValues=function(){var rs={};rs.caption=$('#albumCaption').attr("value");var ds=$('#albumDescription').attr("value");rs.description=ds;return rs;}
lib.createOrEditAlbum=function(edit,imTopic){if(!imTopic)imTopic=lib.imD.topic;var sdata=lib.createAlbumFieldValues();var data={caption:sdata.caption,description:sdata.description};data.image=imTopic;if(edit){var url="/api/editAlbum";data.topic=lib.albumD.topic;}else{var url="/api/addAlbum";}
var cb=lib.createAlbumCallback;var a=lib.albumD;util.post(url,data,function(rs){util.log("api","data returned",rs);if(rs.status!="ok"){util.logout();location.href="/timeout"
return;}
if(edit){var vl=rs.value;util.setProperties(a,vl,["description","caption"]);lib.updateTopbarOptions(lib.topbar.options);lib.topbar.render();lib.popAlbumDetails();}else{location.href="/topic"+rs.value.topic;}
},"json");util.log("api","uuuuu");} 
lib.deleteTheAlbum=function(){var data={topic:lib.albumD.topic};var url="/api/deleteAlbum";var imtp=lib.albumD.image.topic;util.post(url,data,function(rs){if(rs.status!="ok"){util.logout();location.href="/timeout";return;}
location.href="/mywork";},"json");util.log("api","uuuuu");}
lib.createTheAlbum=function(imTopic){lib.createOrEditAlbum(false,imTopic);}
lib.editTheAlbum=function(){lib.createOrEditAlbum(true);}
lib.popCreateAlbumLightbox=function(imTopic){lib.lightbox.pop(false,350);lib.lightbox.element.empty();lib.lightbox.addClose();lib.lightbox.element.append(lib.createAlbumDiv);lib.editingAlbum=true;$('#submitAlbum').click(function(){lib.createTheAlbum(imTopic);});$('#cancelAlbum').click(function(){lib.lightbox.dismiss();});return;}
lib.addAlbumsDiv=function(container){container.append(lib.albumsDiv);lib.setPanelPanel("albums",lib.albumsDiv);return;}
lib.popEditAlbumLightbox=function(){lib.lightbox.pop();lib.lightbox.element.empty();lib.lightbox.addClose();lib.lightbox.element.append(lib.editAlbumDiv);$('#submitAlbum',lib.editAlbumDiv).click(function(){lib.editTheAlbum();});$('#cancelAlbum',lib.editAlbumDiv).click(function(){lib.popAlbumDetails();});lib.editAlbumInitializer(false);return;}})();
(function(){var lib=page;var geom=exports.GEOM2D;var imlib=exports.IMAGE;var util=idv.util;var common=idv.common;lib.initialize=function(options){idv.util.commonInit();util.loggedInUserFromCookie();var dv=$('.infoDiv');var r=/image=(\/image\/\w*\/\w*)/;var mt=location.href.match(r);if(mt){var image=mt[1];var ims=image.split("/");var imo=ims[2];var imname=ims[3];var imsrc=util.s3imDir(imo,imname)+"resized/area_250000.jpg";}
var imel=$('<img src="'+imsrc+'"/>');dv.append(imel);if(!idv.loggedInUser){dv.append(msg=$('<div/>').html('To annotate images, you need to <a href="/login">log in or register</a> at ImageDiver. It\'s free.'));return;} 
var lbwd=600;var lft=winCenter=0.5*lbwd;var wht=$(window).height();var lbht=200;var lightboxRect=new geom.Rect(new geom.Point(lft,top),new geom.Point(lbwd,lbht));var lb=new common.Lightbox($('body'),lightboxRect);lb.render();lib.lightbox=lb;var url="http://"+idv.apiHost+"/api/albumsForImage";var data={image:image};util.post(url,data,function(rs){var albs=rs.value;if((!albs)||(albs.length==0)){var firstAlbum=$('<div/>').html('Please confirm:do you wish to start annotating this image?');dv.append(firstAlbum);var ok,cancel,buttons;dv.append(buttons=$('<div/>'));buttons.append(ok=$('<span class="clickableElement">Ok</span>'));buttons.append(cancel=$('<span class="clickableElement">Cancel</span>'));buttons.css({'margin-top':'20px'});ok.click(function(){util.createNewAlbum(image);});cancel.click(function(){history.back();});}else{dv.append($('<div/>').html("These are your albums of annotations for this image (click to open):"));util.arrayForEach(albs,function(alb){var adiv=$('<div/>').html(alb.caption);dv.append(adiv);adiv.css({'margin-left':'20px','margin-top':'10px','cursor':'pointer','text-decoration':'underline'});var tp=alb.topic;var url="http://"+idv.apiHost+"/topic"+tp+"/index.html"
adiv.click(function(){location.href=url});});var newAlbum;dv.append($('<div/>').html("Or:").css({'margin-top':'10px'}));dv.append(newAlbumDiv=$('<div/>').append(newAlbum=$('<span class="clickableElement">Create New Album</span>')));newAlbumDiv.css({'margin-top':'20px','font-size':'10pt'})
newAlbum.click(function(){lib.popCreateAlbumLightbox(image);});}});}})();
