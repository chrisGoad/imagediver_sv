(function(){var lib=page;var geom=idv.geom;var imlib=idv.image;var com=idv.common;var util=idv.util;lib.scaleDivForPanel=function(panel){return;util.log("scale",panel.name);if(panel.selfScaling)return;var scalable=panel.scalable;var iht=panel.height;if(iht){if(scalable){var ht=lib.scale*iht;}else{ht=iht;}}else{ht=null;}
lib.panelDiv.css("height",ht);}
lib.resizeCurrentPanel=function(){if(!lib.currentPanel)return;var pn=lib.currentPanel.panel;var resizer=pn.data("resizer");if(resizer){resizer();}} 
lib.selectPanel=function(panelName,initData,dontCallInitializer){if(lib.currentPanel){lib.lastPanel=lib.currentPanel;}
if(typeof(panelName)!="string"){panelName=panelName.name;}
var selPanel=lib.panels[panelName];
var selActv=selPanel.activator;for(var nm in lib.panels){var cpan=lib.panels[nm];var cpn=cpan.panel;var actv=cpan.activator;if(!cpn)continue;if(nm==panelName){if(lib.currentPanel==cpan)continue;if(actv){lib.selectClickable(actv);}
if(lib.vp){if(!lib.showSnapsMode)lib.vp.clearOverlays();}
cpn.show();lib.scaleDivForPanel(cpan);lib.currentPanel=cpan;var initializer=cpn.data("initializer");if(initializer&&!dontCallInitializer){if(initData){initializer(initData);}else{initializer();}}}else{if(actv&&selActv){ lib.enableClickable(actv);}
cpn.hide();}}}
lib.setPanelPanel=function(name,panel){var pn=lib.panels[name];if(!pn){pn={panel:panel,name:name};lib.panels[name]=pn;return pn;}
pn.panel=panel;return pn;}
lib.setPanelNominalHeight=function(name,ht){var pn=lib.panels[name];pn.nominalHeight=ht;}
lib.setPanelActivator=function(name,activator){var pn=lib.panels[name];if(!pn){pn={activator:activator,name:name};lib.panels[name]=pn;return pn;}
pn.activator=activator;return pn;}
lib.hookupPanelActivator=function(name){var pnd=lib.panels[name];var actv=pnd.activator;if(pnd&&actv){lib.setClickMethod(actv,function(){lib.selectPanel(name);})
actv.mousedown(function(e){e.preventDefault();});}}
lib.hookupPanelActivators=function(){for(nm in lib.panels){lib.hookupPanelActivator(nm);}}
lib.pathLast=function(p){var sp=p.split("/");var ln=sp.length;return sp[ln-1];}
lib.setPanelDivHeight=function(ht){lib.panelDiv.css("height",ht);var ofs=lib.panelDiv.offset();}})();
(function(){var lib=page;var geom=idv.geom;var imlib=idv.image;var com=idv.common;var util=idv.util;lib.snapArrayDiv=$('<div id="snapArray">'+'<div id="snapArrayNoSnaps">No snapshots have been added to this album yet</div>'+'<div id="snapArrayIntro">Click on snapshot for detail</div>'+'<div id="snapArraySnaps"></div>'+'</div');lib.checkNoSnaps=function(){if(lib.snaps.length==0){$('#snapArrayNoSnaps').show();$('#snapArrayIntro').hide();}else{$('#snapArrayNoSnaps').hide();$('#snapArrayIntro').show();lib.positionSnaps(undefined,false,true);}}
lib.snapArrayDiv.data("initializer",function(){$('#snapArrayNoSnaps').hide();$('#snapArrayIntro').hide();if(lib.selectedSnaps.length<2){ lib.setSelectedSnap(undefined,lib.showSnapsMode?lib.stdSnapAdvice():" ");}
lib.positionSnaps(undefined,false,true);});lib.minAspectRatio=0.82;lib.snapArrayThumbWidth=function(snapD){var xt=snapD.coverage.extent;var aspectRatio=Math.max(lib.minAspectRatio,xt.y/xt.x);var snapH=lib.snapThumbHeight;return snapH/aspectRatio;}
lib.snapArrayThumbContainerWidth=function(snapD){var tw=lib.snapArrayThumbWidth(snapD);var rs=tw+lib.snapThumbMargin*2;if(rs<lib.snapArrayMinThumbWidth){rs=lib.snapArrayMinThumbWidth;}
return rs;}
lib.fixSnapCoverage=function(snapD){var sc=snapD.shares_coverage;if(sc>0){var sw=lib.snapDsByTopicNum[sc];snapD.coverage=sw.coverage;snapD.cropid=sw.cropid;}}
idv.SnapD.prototype.width=function(){var xt=this.coverage.extent;var aspectRatio=xt.y/xt.x;var snapH=lib.snapHeight;return snapH/aspectRatio;}
idv.Snap.prototype.setThumbCss=function(left,top,sc,useThisCapHeight){var snap=this; if(useThisCapHeight){}
sc=Math.max(sc,lib.minSnapScale);var snapH=lib.snapThumbHeight;var snapBottomMargin=lib.snapThumbBottomMargin;var snapCapHeight=lib.snapThumbCaptionHeight;if(useThisCapHeight){var aaa=22;snapCapHeight=useThisCapHeight/sc+20;}
var snapW=lib.snapArrayThumbWidth(snap.snapD);var snapCW=lib.snapArrayThumbContainerWidth(snap.snapD);idv.util.log("snaparray","snapW",snapW,"snapCW",snapCW);var imleft=(snapCW-snapW)/2;var snapCH=snapH+snapBottomMargin+snapCapHeight; var cnt=snap.container;var css={"border":"solid thin gray",left:sc*left,top:sc*top,width:sc*snapCW,height:sc*snapCH,position:"absolute"};cnt.css(css);var cse=snap.img;cse.css({left:sc*imleft,top:sc*(5+snapCapHeight),width:sc*snapW,height:sc*snapH,position:"absolute"}); var snapD=snap.snapD;snapD.thumbCaptionEl.empty();var cap=util.removeWikiSymbols(snapD.caption);if(useThisCapHeight){var chta=useThisCapHeight;}else{var chta=sc*(snapCH-snapH);}
snapD.thumbCaptionEl.html(cap);var cht=snapD.thumbCaptionEl.height(); if(cht<10)cht=10; var cnt=0;if(lib.shortCaptions)return[cht,snapH]
while((cht>chta)&&(cnt<3)){ var cln=cap.length;var ratio=chta/(cht);var nln=Math.max(Math.floor(cln*ratio)-3,1);var cap=cap.substr(0,nln);snapD.thumbCaptionEl.html(cap);cht=snapD.thumbCaptionEl.height(); cnt++;}
if(cnt>0){snapD.thumbCaptionEl.html("<p>"+cap+"...</p>");}else{snapD.thumbCaptionEl.html("<p>"+cap+"</p>");}
return cht;}
idv.Snap.prototype.mouseenterSnap=function(){var snapD=this.snapD;var cv=snapD.coverage;var vp=lib.vp;lib.setSelectedSnap(this,lib.stdSnapAdvice());var cnt=this.container;cnt.css({"background-color":"#dddddd"});var cap=this.caption;cap.css({"color":"black"});}
idv.Snap.prototype.mouseleaveSnap=function(){var snap=this;var cnt=snap.container;cnt.css({"background-color":"black"});var cap=snap.caption;cap.css({"color":"white"});if(page.currentPanel.name!="snapArray")return;lib.setSelectedSnap(undefined,lib.stdSnapAdvice());}
lib.minSnapScale=0.4;
lib.showAllSnaps=1; lib.positionSnaps=function(rowHeights,force,iShowAll){if(iShowAll==undefined){if(!force)return;var showAll=lib.showAllSnaps;}else{lib.showAllSnaps=iShowAll;showAll=iShowAll;}
if(lib.zooming)return;var firstPass=!rowHeights;var minHt=lib.standardPanelHeight;var sc=lib.scale;if(lib.twoColumns){var uW=950;}else{uW=2000;sc=sc*0.5;}
var mss=lib.minSnapScale;var eWd=(sc<mss)?uW*(sc/mss):uW; var wd=1000;var snaps=lib.snaps;var ln=snaps.length;var gapX=lib.snapGapX;var gapY=lib.snapGapY;var snapH=lib.snapThumbHeight;var snapCapH=lib.snapThumbCaptionHeight;var snapCapBottom=lib.snapThumbBottomMargin;var cx=gapX;var cy=gapY;var cy=40;var noSnaps=true;var ns=lib.snapsActive;var lastSnapTooWide=false; if(firstPass){rowHeights=[];maxCapHt=0;} 
var rowNum=0;for(var i=0;i<ns;i++){var cs=snaps[i];var snapD=cs.snapD;if(snapD.relevant||showAll){cs.container.show();noSnaps=false;}else{cs.container.hide();continue;}
var snapW=lib.snapArrayThumbContainerWidth(cs.snapD); nx=cx+snapW+gapX;if(nx>eWd){ rowNum++;if(firstPass){rowHeights.push(Math.min(100,maxCapHt));maxCapHt=0;}
cy=cy+lastThumbHt+gapY;cx=gapX;nx=cx+snapW+gapX;}
if(firstPass){var cht=cs.setThumbCss(cx,cy,sc,undefined);}else{cs.setThumbCss(cx,cy,sc,rowHeights[rowNum]);}
var lastThumbHt=cs.container.height()/sc;if(cht>maxCapHt)maxCapHt=cht;cx=nx;}
rowHeights.push(Math.min(50,maxCapHt));if(!lib.twoColumns){var sht=cy+snapH+snapCapH+snapCapBottom+gapY+20;lib.setPanelDivHeight(sc*sht);}
if(noSnaps){$("#snapArrayIntro").html("No snapshot selected");lib.hideAllSelectedSnaps();return;}else{$("#snapArrayIntro").html("Click on snapshot for detail")}
if(firstPass)lib.positionSnaps(rowHeights,1);}
lib.snapArrayDiv.data("resizer",function(){lib.positionSnaps(undefined,true);});lib.snaps=[];idv.SnapD.prototype.imUrl=function(thumb){var snapD=this;var cv=snapD.coverage;var xt=cv.extent;var aratio=xt.y/xt.x;var tp=snapD.topic;var tps=tp.split("/");var tpln=tps.length;var uname=tps[2];var imname=tps[3];var imowner=uname;var sc=snapD.cropid;if(sc!=undefined){var snapNum=sc;}else{util.error("NO CROPID");snapNum=tps[tpln-1];}
var cropId=snapD.cropid;if(cropId==undefined){cropId=snapNum;}
if(thumb){var rimd="snapthumb/"+cropId+".jpg";}else{var rimd="snap/"+cropId+".jpg";}
if(idv.atS3){var rs=util.s3imDir(imowner,imname)+rimd+"?album="+lib.albumString;}else{var rs=util.localImDir(imowner,imname)+rimd+"?album="+lib.albumString;}
return rs;}
idv.SnapD.prototype.thumb=function(){return this.imUrl(true);}
idv.SnapD.prototype.fullsize=function(){return this.imUrl(false);}
lib.showSnapsMode=false;lib.snapsByTopic={};lib.displayTopicId=0;
lib.showSnapByTopic=function(n){if(n==undefined){n=lib.urlSnap;}
var snd=page.snapDsByTopicNum[n];if(snd){lib.showSelectedSnap(snd);}}
lib.addSnap=function(isnapD,editingSnap){var snapD=lib.toSnapDObject(isnapD);var topicId=util.lastPathElement(snapD.topic);snapD.topicId=topicId;
if(editingSnap){ var dst=editingSnap;util.setProperties(dst,snapD,["caption","description","cropid"]);}else{dst=snapD;}
dst.coverage=geom.internalizeRect(snapD.coverage);var imsrc=snapD.thumb();if(editingSnap){var imjq=editingSnap.thumbImageEl;}else{var thumbc=$("<div class='thumbc'/>");var caption=$("<div class='thumbCaption'></div>");snapD.thumbCaptionEl=caption;if(lib.displayTopicId){thumbc.append(topicId);}else{thumbc.append(caption);}
var imjq=$("<img class='thumb' />");snapD.thumbImageEl=imjq;thumbc.append(imjq);lib.snapArraySnapsDiv.append(thumbc);thumbc.click(function(){lib.vp.setZoom(1);lib.showSelectedSnap(snapD)});var esd=new idv.Snap();util.setProperties(esd,{snapD:snapD,container:thumbc,img:imjq,caption:caption});thumbc.mouseenter(function(){esd.mouseenterSnap()});thumbc.mouseleave(function(){esd.mouseleaveSnap();});thumbc.mousedown(function(e){e.preventDefault();});lib.snaps.push(esd);var tp=snapD.topic;lib.snapsByTopic[tp]=esd;lib.snapsActive=lib.snaps.length;}
util.log("imsrc",imsrc);imlib.loadImage(imjq,imsrc);}
lib.anyCaptions=function(){var ln=lib.snaps.length;for(var i=0;i<ln;i++){var sd=lib.snaps[i].snapD;if(sd.caption)return true;}
return false;}
lib.longCaptions=function(cln){var ln=lib.snapDs.length;for(var i=0;i<ln;i++){var sd=lib.snapDs[i];if(sd.caption&&sd.caption.length>cln)return true;}
return false;}
lib.snapsReady=false;lib.snapsActive=0; lib.addSnaps=function(snapDs,mxn){var ln=snapDs.length;if(!lib.anyCaptions()){lib.snapThumbCaptionHeight=20;}
if(!lib.longCaptions(12)){lib.shortCaptions=true;lib.snapThumbCaptionHeight=40;}
if(ln>mxn){var ns=mxn;var rs=false;}else{ns=ln;rs=true;}
lib.snapsActive=ns;for(var i=0;i<ns;i++){var sd=snapDs[i]; lib.addSnap(sd);}
lib.positionSnaps(undefined,true,true);if(rs)lib.snapsReady=true;return rs;}
lib.addSnapArrayDiv=function(container){container.append(lib.snapArrayDiv);lib.setPanelPanel("snapArray",lib.snapArrayDiv);lib.snapArrayDiv.css({width:"100%"});lib.snapArraySnapsDiv=$('#snapArraySnaps');if(lib.editPermissions()){$('#snapArrayNoSnaps').html('To add your first annotation, click "new snap"');$('#snapArrayNoSnaps').css({'font-size':'15pt'});}
if(lib.imOnly&&(!idv.loggedInUser)){var txt='If you <a href="http://imagediver.org/login">log in</a>, you will be able to add your own annotations to this image.'+'You can log in with your Tumblr account, and in any case registration is quick and free.';$('#snapArrayNoSnaps').html(txt);$('#snapArrayNoSnaps').css({'font-size':'10pt',"margin":"20pt"});}}
lib.toSnapDObject=function(snd){if(snd instanceof idv.SnapD)return snd;var rs=new idv.SnapD();util.setProperties(rs,snd);return rs;}
idv.SnapD.prototype.internalize=function(sc){var cv=this.coverage;var ext=cv.extent;var crn=cv.corner;var nc={extent:{x:ext.x*sc,y:ext.y*sc},corner:{x:crn.x*sc,y:crn.y*sc}};this.coverage=nc;}})();
(function(){var lib=page;var geom=idv.geom;var imlib=idv.image;var com=idv.common;var util=idv.util;lib.interpolateCoverage=function(startCov,destCov,v){if(v>=1)v=1;lib.animationUnderway=true;var covNow=startCov.interpolate(destCov,v);var covRect=geom.internalizeRect(covNow);lib.vp.setCoverage(covRect);lib.zSlider.positionSliderFromZoom(lib.vp.zoom);if(v<1){setTimeout(function(){lib.interpolateCoverage(startCov,destCov,v+0.1);},50);}else{page.zooming=false;lib.vp.refreshOverlays();lib.zSlider.setZoom(lib.zSlider.getZoom());}}
lib.immediateZoomToSnap=function(snapD,scale){if(!scale)scale=1.1;var cov=snapD.coverage;var scov=cov.scale(scale);var covRect=geom.internalizeRect(scov);lib.vp.setCoverage(covRect);lib.zSlider.positionSliderFromZoom(lib.vp.zoom);}
lib.animatedZoomToSnap=function(snapD,scale){page.zooming=true;var startCov=lib.vp.coverage();if(!scale)scale=1.1;var destCov=snapD.coverage.scale(scale);lib.interpolateCoverage(startCov,destCov,0);}
lib.zoomToSelectedSnap=function(){lib.vp.setZoom(1);lib.animatedZoomToSnap(lib.selectedSnap.snapD,1.1);}})();
(function(){var lib=page;var geom=idv.geom;var imlib=idv.image;var com=idv.common;var util=idv.util;lib.allSelectedSnaps={}; lib.selectedSnaps=[]; lib.selectedSnap=undefined;
lib.setSelectedSnapCallbacks=[];lib.setSelectedSnaps=function(sns,snapAdvice,noBuild){lib.clearOverlayState();var ln=sns.length;var sna=snapAdvice;var ss=[];for(var i=0;i<ln;i++){var sn=sns[i];var snapD=sn.snapD;snapD.overlayState="selected";ss.push(lib.buildSelectedSnap(snapD.topic,true));}
if(ln==1){lib.selectedSnap=ss[0];if(!sna)sna=lib.stdSnapAdvice();}else if(ln==0){lib.selectedSnap=undefined;if(!sna)sna="no snap selected. try again if you like.";}else{ lib.selectedSnap=undefined;if(!sna)sna="multiple snaps selected. choose one from left panel";}
if(sna!="nochange")lib.snapAdvice.html(sna);lib.selectedSnaps=ss;lib.updateOverlays("selected"); util.runCallbacks(lib.setSelectedSnapCallbacks);}
lib.setSelectedSnap=function(s,snapAdvice,noBuild){if(s){lib.setSelectedSnaps([s],snapAdvice,noBuild);}else{lib.setSelectedSnaps([],snapAdvice);}
lib.updateButtonVis();}
lib.maxOrdinal=function(){var mxo=0;util.arrayForEach(lib.snapDs,function(snd){mxo=Math.max(mxo,snd.ordinal);})
return mxo;}
lib.snapCallback=function(data){var snapD=data.value;if(!lib.editingSnap){snapD.ordinal=lib.maxOrdinal()+1;snapD.myIndex=lib.snapDs.length;lib.snapDs.push(snapD);}
lib.addSnap(snapD,lib.editingSnap);if(lib.editingSnap){lib.clearSelectedSnaps();lib.showSelectedSnap(lib.editingSnap);}else{lib.fixNextToLastSelectedSnap();lib.showSelectedSnap(snapD);}
if(lib.showSnapsMode){lib.redisplaySnaps();}
}
lib.editSnap=function(){var selsnap=lib.selectedSnap;lib.selectPanel("createSnap",selsnap);}
lib.hideSelectedSnap=function(selsnap){if(!selsnap){selsnap=lib.selectedSnap;}
if(!selsnap)return;function hideIfNonNull(x){if(x)x.hide();}
hideIfNonNull(selsnap.prevThumb);hideIfNonNull(selsnap.nextThumb);hideIfNonNull(selsnap.element);hideIfNonNull(selsnap.bigImg);}
lib.hideAllSelectedSnaps=function(){util.resetClock();var ss=lib.allSelectedSnaps;for(var k in ss){var cs=ss[k];lib.hideSelectedSnap(cs);}
}
lib.thumbWidth=function(snapD){var xt=snapD.coverage.extent;var aspectRatio=Math.max(lib.minAspectRatio,xt.y/xt.x);var snapH=lib.snapThumbHeight;return snapH/aspectRatio;}
lib.positionsForSelectedSnapElements=function(snapC){
var halveHeight=!lib.twoColumns;var divW=lib.panelDiv.width();if(lib.twoColumns){var uW=950;}else{uW=3000;}
var snaps=lib.snaps;var snapD=snapC.snapD;var o=snapD.myIndex;var prevThumb=snapC.prevThumb;var prevNextWidth=lib.prevNextWidth;if(!lib.twoColumns){prevNextWidth=2*prevNextWidth;var availWidthForSnap=uW-2*prevNextWidth-400;}else{var availWidthForSnap=uW-2*prevNextWidth-200;}
var rs={};var snapW=snapD.width();var snapH=lib.snapHeight;var snapDH=0;if(snapW>availWidthForSnap){var snapH=snapH*availWidthForSnap/snapW;var snapDH=lib.snapHeight-snapH; idv.util.log("snapW",snapW);snapW=availWidthForSnap;}
var snapLeft=(0.5*(uW-snapW));var asnapTop=lib.snapTop+0.5*snapDH;var snapCenterY=asnapTop+0.5*snapH;var snapExtent=new geom.Point(snapW,snapH);var snapCorner=new geom.Point(snapLeft,asnapTop);rs.snap=new geom.Rect(snapCorner,snapExtent);var thumbH=lib.snapThumbHeight;var athumbTop=snapCenterY-0.5*thumbH;if(prevThumb){var prevSnapC=snaps[o-1];var prevSnapD=prevSnapC.snapD;var thumbW=lib.thumbWidth(prevSnapD);if(thumbW<lib.snapThumbMinWidth){thumbH=thumbH*(lib.snapThumbMinWidth/thumbW);thumbW=lib.snapThumbMinWidth;util.log("thumbH",lib.snapThumbMinWidth/thumbW,thumbH);}
if(thumbW>prevNextWidth){thumbH=thumbH*prevNextWidth/thumbW;thumbW=prevNextWidth;}
var prevExtent=new geom.Point(thumbW,thumbH);var prevCorner=new geom.Point(10,athumbTop);rs.prev=new geom.Rect(prevCorner,prevExtent);}
var nextThumb=snapC.nextThumb;var nextAreaWidth=0;if(nextThumb){var nextSnapC=snaps[o+1];var nextSnapD=nextSnapC.snapD;var thumbW=lib.thumbWidth(nextSnapD);var thumbH=lib.snapThumbHeight;var thumbW=lib.thumbWidth(nextSnapD);idv.util.log("snapW","thumbW",thumbW,prevNextWidth)
if(thumbW>prevNextWidth){thumbH=thumbH*prevNextWidth/thumbW;thumbW=prevNextWidth;}
var thumbLeft=uW-thumbW-30;var nextExtent=new geom.Point(thumbW,thumbH);var nextCorner=new geom.Point(thumbLeft,athumbTop);rs.nxt=new geom.Rect(nextCorner,nextExtent);}
return rs;}
lib.rectToCss=function(r,sc){if(!sc)sc=1;var c=r.corner;var xt=r.extent;return{"positions":"absolute","left":sc*c.x,"top":sc*c.y,"width":sc*xt.x,"height":sc*xt.y}}
lib.positionPic=function(picElement,container,rect,sc){if(!sc)sc=1;var c=rect.corner;var xt=rect.extent;picElement.css({width:sc*xt.x,height:sc*xt.y});idv.util.log("snapW","actual",xt.x,sc*xt.x);var css={position:"absolute","top":sc*c.y,left:sc*c.x,width:sc*xt.x};container.css(css);picElement.show();}
lib.mainImage=function(snap){if(snap.bigImageLoaded){return snap.bigImg;}else{return snap.element;}}
lib.showMainImage=function(snap){if(snap.bigImageLoaded){snap.element.hide();snap.bigImg.show();var rs=snap.bigImg;}else{rs=snap.element;snap.element.show();snap.bigImg.hide();}
return rs;}
lib.positionSelectedSnapElements=function(snapC){var sc=lib.scale;if(lib.twoColumns){var uW=950;}else{uW=3000;sc=0.333333*sc;}
var mainImg=lib.showMainImage(snapC);var positions=lib.positionsForSelectedSnapElements(snapC);var divW=lib.panelDiv.width();var snaps=lib.snaps;var snapD=snapC.snapD;var o=snapD.myIndex;var prevp=positions.prev;if(prevp){var prevThumb=snapC.prevThumb;lib.positionPic(prevThumb,$("#selectedSnapPrev"),prevp,sc);}
var nextp=positions.nxt;if(nextp){var nextThumb=snapC.nextThumb;lib.positionPic(nextThumb,$("#selectedSnapNext"),nextp,sc);} 
var snapp=positions.snap;lib.positionPic(mainImg,$('#selectedSnap'),snapp,sc);idv.util.log("snaparray","SNAPP",snapp);var dW=sc*uW*0.6; var dLeft=sc*uW*0.2; var simpos=$('.selectedSnapImages').position();var simtop=simpos.top;util.slog("SIMPos ",simpos,simtop);var dsTop=sc*(snapp.extent.y+snapp.corner.y)+simtop;util.log("snaparray","CORNER",snapp.corner.y);var capht=$("#selectedSnapCaption").height();var capTop=sc*(snapp.corner.y)+simtop-15-capht; util.log("snaparray","DSTOP",dsTop);$('#selectedSnapCaption').css({left:dLeft-10,top:capTop,width:dW,"text-align":"center"});$('#selectedSnapDescription').css({left:dLeft-10,top:dsTop,width:dW,"text-align":"center"});if(snapD.description){var dht=$("#selectedSnapDescription").height();}else{dht=0;}
util.log("dht",dht);if(!lib.twoColumns){var ht=lib.theLayout.panelCss.height;lib.setPanelDivHeight(ht+dht);}}
lib.positionMainImg=function(snapC){var sc=lib.scale;if(lib.twoColumns){var uW=950;}else{uW=3000;sc=0.333333*sc;}
var mainImg=lib.showMainImage(snapC);var positions=lib.positionsForSelectedSnapElements(snapC); var snapp=positions.snap;lib.positionPic(mainImg,$('#selectedSnap'),snapp,sc);} 
lib.interpolateSnapElements=function(snapC,direction,v){var sc=lib.scale;if(!lib.twoColumns)sc=0.5*sc;var snapD=snapC.snapD;var o=snapD.myIndex;var snaps=lib.snaps;if(o>=snaps.length-1)return;var nsnap=snaps[o+1]; var nsnapC=lib.buildSelectedSnap(nsnap.snapD.topic,true);
var p0=lib.positionsForSelectedSnapElements(snapC);var p1=lib.positionsForSelectedSnapElements(nsnapC);var nxtDest=p1.snap; var nxtStart=p0.nxt;var nxtNow=nxtStart.interpolate(nxtDest,v);var nextThumb=snapC.nextThumb;lib.positionPic(nextThumb,$("#selectedSnapNext"),nxtNow,sc);var snapDest=p1.prev;var snapStart=p0.snap;var snapNow=snapStart.interpolate(snapDest,v);lib.positionPic(snapC.element,$('#selectedSnap'),snapNow,sc);}
lib.buildInterpolators=function(snapC,direction){var rs=[];var snapD=snapC.snapD;var o=snapD.myIndex;var snaps=lib.snaps;var numSnaps=snaps.length; if(direction==1){if(o>=numSnaps-1)return;var isFirstSnap=o==0;var nsnap=snaps[o+1]; var nsnapC=lib.buildSelectedSnap(nsnap.snapD.topic,true);
var p0=lib.positionsForSelectedSnapElements(snapC);var p1=lib.positionsForSelectedSnapElements(nsnapC);if(!isFirstSnap){var prevDest=new geom.Rect(p0.prev.center(),new geom.Point(1,1));var prevStart=p0.prev;var prevThumb=snapC.prevThumb;var intr={startRect:prevStart,destRect:prevDest,pic:prevThumb,container:$("#selectedSnapPrev")};rs.push(intr);}
var snapDest=p1.prev;var snapStart=p0.snap;intr={startRect:snapStart,destRect:snapDest,pic:snapC.element,container:$("#selectedSnap")};rs.push(intr);var nxtDest=p1.snap; var nxtStart=p0.nxt;var nextThumb=snapC.nextThumb;var intr={startRect:nxtStart,destRect:nxtDest,pic:nextThumb,container:$("#selectedSnapNext")};rs.push(intr);var cv0=snapD.coverage;var cv1=nsnapC.snapD.coverage;intr={startRect:cv0,destRect:cv1,drawRect:true}
rs.push(intr);return rs;}else{if(o==0)return;var isLastSnap=o==numSnaps-1;var nsnap=snaps[o-1]; var nsnapC=lib.buildSelectedSnap(nsnap.snapD.topic,true);
var p0=lib.positionsForSelectedSnapElements(snapC);var p1=lib.positionsForSelectedSnapElements(nsnapC);if(!isLastSnap){ var nextDest=new geom.Rect(p0.nxt.center(),new geom.Point(1,1));var nextStart=p0.nxt;var nextThumb=snapC.nextThumb;var intr={startRect:nextStart,destRect:nextDest,pic:nextThumb,container:$("#selectedSnapNext")};rs.push(intr);}
var snapCDest=p1.nxt; var snapCStart=p0.snap;intr={startRect:snapCStart,destRect:snapCDest,pic:snapC.element,container:$("#selectedSnap")};rs.push(intr);var nsnapCDest=p1.snap; var nsnapCStart=p0.prev; var prevThumb=snapC.prevThumb;intr={startRect:nsnapCStart,destRect:nsnapCDest,pic:prevThumb,container:$("#selectedSnapPrev")};rs.push(intr);var cv0=snapD.coverage;var cv1=nsnapC.snapD.coverage;intr={startRect:cv0,destRect:cv1,drawRect:true}
rs.push(intr);return rs;}}
lib.evalInterpolators=function(interpolators,v){var sc=lib.scale;if(!lib.twoColumns)sc=0.3333*sc;var ln=interpolators.length;for(var i=0;i<ln;i++){var intr=interpolators[i];var st=intr.startRect;var dst=intr.destRect;var cp=st.interpolate(dst,v);if(intr.drawRect){var vp=lib.vp;lib.drawOneRect(cp,"yellow",1);}else{var pic=intr.pic;var container=intr.container;lib.positionPic(pic,container,cp,sc);}}}
lib.snapAnimateIncrement=0.2;lib.snapAnimateDelay=30;lib.animateSnapTransition=function(interpolators,v,whenDone){if(v>=1){v=1;}
lib.evalInterpolators(interpolators,v);if(v<1){setTimeout(function(){lib.animateSnapTransition(interpolators,v+lib.snapAnimateIncrement,whenDone);util.slog("ANIMATE ",v);},lib.snapAnimateDelay);}else{util.slog("ANIMATE DONE");whenDone();}} 
lib.toNextOrPrevSnap=function(direction){var snaps=lib.snaps;var selsnap=lib.selectedSnap;var snapD=selsnap.snapD;var o=snapD.myIndex;if(direction==1){if(o>=snaps.length-1)return;$('#selectedSnapPrevLabel').css("color","black");}else{if(o==0)return;$('#selectedSnapNextLabel').css("color","black");}
lib.vp.setZoom(1);lib.setSelectedSnaps([],lib.stdSnapAdvice());var ints=lib.buildInterpolators(selsnap,direction); selsnap.bigImg.hide();lib.animateSnapTransition(ints,0,function(){var nsnap=snaps[o+direction].snapD;lib.setSelectedSnap(undefined);lib.hideSelectedSnap(selsnap);lib.showSelectedSnap(nsnap);lib.setSelectedSnap(snaps[o+direction]);$('#selectedSnapPrevLabel').css("color","white");$('#selectedSnapNextLabel').css("color","white");});}
lib.toPrevSnap=function(){lib.toNextOrPrevSnap(-1);return;}
lib.toNextSnap=function(){lib.toNextOrPrevSnap(1);return;}
lib.itest=function(v){var snapC=lib.selectedSnap;var ints=lib.buildInterpolators(snapC,1);lib.animateSnapTransition(ints,0);} 
lib.loadSelectedSnapBigImage=function(ss){var snapD=ss.snapD;var tp=snapD.topic;if(ss.bigImageLoadStarted)return;ss.bigImageLoadStarted=true;var ssbe=ss.bigImg;var imsrc=snapD.fullsize();ssbe.load(function(){ss.bigImageLoaded=true;if(lib.selectedSnap&&(ss.snapD.topic==lib.selectedSnap.snapD.topic)){util.slog("POSITIONED BIG IMAGE");ss.element.hide();lib.positionMainImg(ss);ssbe.show();}else{ssbe.hide();}});ssbe.attr("src",imsrc);}
lib.fixNextToLastSelectedSnap=function(){var ln=lib.snaps.length;if(ln<2)return;var assn=lib.allSelectedSnaps;if(!assn)return;var lastSnapD=lib.snaps[ln-1].snapD;var nextToLastSnapD=lib.snaps[ln-2].snapD;var ntlSelSnap=lib.allSelectedSnaps[nextToLastSnapD.topic];if(!ntlSelSnap)return;if(ntlSelSnap.nextThumb)return; var nextThumb=lib.buildNextThumb(ln-2);ntlSelSnap.nextThumb=nextThumb;}
lib.buildNextThumb=function(idx){var next=$('#selectedSnapNext');var nextSnapC=lib.snaps[idx+1];var nextSnapD=nextSnapC.snapD;var nextThumb=$("<img class='thumb' />");next.append(nextThumb);var imsrc=nextSnapD.thumb();nextThumb.attr("src",imsrc);return nextThumb;} 
lib.clearSelectedSnaps=function(){$('#selectedSnapPrev').empty();$('#selectedSnapNext').empty();$('#selectedSnap').empty();lib.allSelectedSnaps={};}
lib.aTest=33;lib.buildSelectedSnap=function(tp,hide){var sso=lib.allSelectedSnaps[tp];if(sso){if(!hide){lib.loadSelectedSnapBigImage(sso);}
return sso;}
var snap=lib.snapsByTopic[tp];var o=snap.snapD.myIndex;var snapD=snap.snapD;var snaps=lib.snaps;var sln=snaps.length;var prevThumb=null;var nextThumb=null;var prev=$('#selectedSnapPrev');var next=$('#selectedSnapNext');if(o>0){var prevSnapC=snaps[o-1];var prevSnapD=prevSnapC.snapD;var prevThumb=$("<img draggable='false' class='thumb' />");prev.append(prevThumb);var imsrc=prevSnapD.thumb();prevThumb.attr("src",imsrc);if(hide)prevThumb.hide();}
if(o<sln-1){var nextThumb=lib.buildNextThumb(o);if(hide)nextThumb.hide();}
var sse=$('<img id="'+tp+'"/>');var ssbe=$('<img id="/big'+tp+'"/>');
var ssic=$('#selectedSnap');var snapW=snapD.width();ssic.append(sse);ssic.append(ssbe);var imsrc=snapD.thumb(); var sso={topic:tp,element:sse,bigImg:ssbe,snap:snap,snapD:snapD,prevThumb:prevThumb,nextThumb:nextThumb};if(hide){var whenLoaded=function(imel){if(lib.selectedSnap&&(tp==lib.selectedSnap.snapD.topic)){lib.positionMainImg(sso);}else{imel.hide();}};}else{whenLoaded=undefined;}
imlib.loadImage(sse,imsrc,whenLoaded,true);if(!hide){lib.loadSelectedSnapBigImage(sso);}
lib.allSelectedSnaps[tp]=sso;return sso;}
lib.showSelectedSnap=function(snapD){if(lib.isSnaps){if(lib.linkButton)lib.linkButton.show();}
if(lib.hideLinks)lib.hideLinks();lib.hideAllSelectedSnaps(); if(!snapD){lib.setSelectedSnap(undefined);$('.selectedSnapBody').hide();$('#zoomAdvice').html("No snap selected");$('.selectedSnapButtons').hide();return;}
$('.selectedSnapBody').show();$('#zoomAdvice').html("Click on central image to zoom to the snap");lib.permissionsForSelectedSnap();var xt=snapD.coverage.extent;var art=xt.y/xt.x;if(!snapD)return;var snapNum=lib.pathLast(snapD.topic);if(idv.pageKind=="album"){}
$('#selectedSnapPrev').show();var snapCount=lib.snaps.length;var isLastSnap=(snapD.myIndex)==snapCount-1;if(isLastSnap){$('#selectedSnapNext').hide();}else{$('#selectedSnapNext').show();}
if(snapD.myIndex==0){$('#selectedSnapPrev').hide();}else{$('#selectedSnapPrev').show();}
var lastSnap=lib.selectedSnap;if(snapD){lib.nowSelectedSnapD=snapD;}else{snapD=lib.nowSelectedSnapD;}
var caption=snapD.caption;var description=snapD.description;if(!caption){caption="";}
var wtdst=$('#selectedSnapCaption');wtdst.empty();wtdst.html(util.processMarkdown(caption));var ssd=$('#selectedSnapDescription');if(description){ssd.show();wtdst=$('#selectedSnapDescription');wtdst.empty();wtdst.html(util.processMarkdown(description));if(description.length<50){$('p',ssd).css("text-align","center");}else{$('p',ssd).css("text-align","left");}}else{ssd.hide();}
lib.selectPanel("selectedSnap",null,true); lib.permissionsForSelectedSnap();if(lastSnap){ lastSnap.element.hide();lastSnap.bigImg.hide();if(lastSnap.prevThumb)lastSnap.prevThumb.hide();if(lastSnap.nextThumb)lastSnap.nextThumb.hide();}
var sso=lib.buildSelectedSnap(snapD.topic);lib.setSelectedSnap(sso);lib.positionSelectedSnapElements(sso);return;}
lib.selectedSnapDiv=$('<div class="selectedSnap">'+'<div class="selectedSnapHead">'+'<div id="yesSnaps"></div>'+'<div class="selectedSnapControls" >'+'<div id="zoomAdvice"><i>Click on central image to zoom to the snap</i></div>'+'<div class="selectedSnapButtons">'+'<span id="editSnap" class="clickableElement">Edit This Snap</span>'+'<span id="deleteSnap" class="clickableElement">Delete This Snap</span>'+'</div>'+'</div>'+'</div>'+'<div class="selectedSnapBody">'+'<div id="selectedSnapCaption"/>'+'<div class="selectedSnapImages">'+'<div id="selectedSnapPrev">'+'<div  id="selectedSnapPrevLabel" class="prevNextLabel">PREV</div>'+'<div id="prevSnapImageContainer" class="imageContainer"/>'+'</div>'+'<div id="selectedSnap">'+'<div id="loadingMsg"> loading ... <img src="/ajax-loader.gif"/></div>'+'</div>'+'<div id="selectedSnapNext">'+'<div  id="selectedSnapNextLabel" class="prevNextLabel">NEXT</div>'+'<div id="nextSnapImageContainer" class="imageContainer"/>'+'</div>'+'<div id="selectedSnapIncoming"/>'+'<div id="selectedSnapOutgoing"/>'+'</div>'+'<div id="selectedSnapDescription"/>'+'</div>'+'</div>');lib.permissionsForSelectedSnap=function(){if(lib.editPermissions()){$('.selectedSnapButtons').show();}else{$('.selectedSnapButtons').hide();}}
lib.selectedSnapDiv.data("resizer",function(){if(lib.selectedSnap){lib.positionSelectedSnapElements(lib.selectedSnap);}});lib.selectedSnapDiv.data("initializer",function(){lib.permissionsForSelectedSnap();if(idv.pageKind!="album"){$('#selectedSnapPrevLabel').hide();$('#selectedSnapNextLabel').hide();}
if(lib.snaps.length==0){$('#noSnaps').show(); $('#yesSnaps').hide();return;}else{$('#noSnaps').hide();$('#yesSnaps').show();}
if(lib.selectedSnap){lib.positionSelectedSnapElements(lib.selectedSnap);return;}
if(lib.snaps.length==0){}else{lib.showSelectedSnap(lib.snaps[0].snapD);}});lib.addSelectedSnapDiv=function(container){container.append(lib.selectedSnapDiv);$("#selectedSnapNext").css({"cursor":"pointer"});$("#selectedSnapPrev").css({"cursor":"pointer"});lib.setPanelPanel("selectedSnap",lib.selectedSnapDiv);$('#selectedSnapPrev').click(lib.toPrevSnap);$('#selectedSnapPrev').mousedown(function(event){event.preventDefault();});lib.selectedSnapNext=$('#selectedSnapNext');$('#selectedSnapNext').click(lib.toNextSnap);$('#selectedSnapNext').mousedown(function(event){event.preventDefault();});$('#editSnap').click(lib.editSnap);lib.setClickMethod($('#zoomToSnap'),lib.zoomToSelectedSnap);$('#selectedSnap').click(lib.zoomToSelectedSnap);$('#deleteSnap').click(function(){util.myConfirm("Delete","Are you sure you wish to delete this snap? There is no undo.",function(){util.closeDialog();lib.serverDeleteSnap();},function(){util.closeDialog();});});lib.selectedSnapDiv.css({width:"100%"});$('#loadingMsg').hide();}})();

(function(){var lib=page;var geom=idv.geom;var imlib=idv.image;var com=idv.common;var util=idv.util;lib.startDefArea=function(){lib.vp.clearOverlays("both");lib.vp.defAreaMode=true;lib.vp.setDisplayParamsForZoom();lib.vp.areaDefinedCallback=lib.finishDefArea;$('#cropInstructions').show();}
lib.finishDefArea=function(area,screenArea){var sxt=screenArea.extent;if((sxt.x<20)||(sxt.y<20)){lib.startDefArea(); util.myAlert("Alert","Dragged area is too small. Try zooming in, and dragging again");return;}
lib.coverageModified=true;util.log("area",area.tostring());lib.vp.defAreaMode=false;lib.vp.selectedArea=area;lib.vp.areaEditorActive=true;lib.vp.drawEdRect(area,"image","red",false);$('#cropInstructions').hide();$('#selectSnapArea').show();$('#snapDetails').show();$('#selectSnapArea').hide();$('#areaSelected').show();}
lib.createSnapDiv=$('<div class="createSnapDiv">'+'<div class="createSnapStep"><span>Creating New Annotation</span></div>'+'<div class="createSnapStep">Step 1: <span id="areaSelected"><i>Take snapshot: done</i></span><span id="selectSnapArea">Take snapshot</span>'+'<span id="cropInstructions">drag box over the desired region</span></div>'+'<div class="createSnapStep">Step 2: Enter caption, tags, description</div>'+'<div id="snapDetails">'+
'<div><i>To include links or formatting, use <a href="http://daringfireball.net/projects/markdown/basics" target="idvWindow">Markdown</a></i></div>'+'<div class="inputsTD">Caption</div>'+'<div><input  id="snapCaption" type="text"/></div>'+'<div class="inputsTD">Description</div>'+'<div><textarea rows="8"  id="snapDescription"/></div>'+'<div >Step 3. Submit</div>'+'<div id="createSnapButtons" class="createSnapLine">'+'<span id="submitSnap" class="clickableElement">Save</span>'+'<span id="cancelSnap" class="clickableElement">Cancel</span>'+'</div>'+'</div>'+'</div>');lib.creatingSnapDiv=$('<div class="creatingSnapDiv" id="creatingSnapDiv">One moment </div>');lib.createSnapDiv.data("initializer",function(selsnap){$("#areaSelected").hide();$("#selectSnapArea").show();$('#snapDetails').css({"margin-top":"20px","margin-left":"20px"});util.activateAnchors($('#creoleNote'));lib.preCreateSnapShowSnapsMode=lib.showSnapsMode;lib.showSnapsButton.hide();if(lib.publishButton)lib.publishButton.hide();lib.showSnapsMode=0;$('#snapDescription').css({"width":"90%","font-size":"10pt"});$('#snapCaption').css({"width":"90%","font-size":"10pt"});if(selsnap){$("#submitSnap").html("Update Snapshot");$('.createSnapStep').hide();var snapD=selsnap.snapD;util.log("editSnap",snapD);lib.immediateZoomToSnap(snapD,2);var vp=lib.vp;vp.clearOverlays("both");var r=snapD.coverage;vp.selectedArea=r;vp.areaEditorActive=true;vp.selectedAreaModified=false;vp.drawEdRect(r,"image","red",false);
$('#snapDetails').show();lib.editingSnap=snapD;lib.coverageModified=false;lib.setSnapFieldValues(snapD);lib.vp.addOverlay(new imlib.Overlay("editingSnap",snapD.coverage));lib.creatingSnapDiv.html("One moment  ... editing the snapshot")}else{$("#submitSnap").html("Save");$('#selectSnapArea').html("Take Snapshot");$('.createSnapStep').show();lib.editingSnap=undefined; $('#snapDetails').hide();lib.creatingSnapDiv.html("One moment  ... creating the snapshot")
$('#snapCaption').attr('value',"");$('#snapDescription').attr('value',"");lib.startDefArea();}});lib.createSnapFieldValues=function(){var rs={};rs.caption=$('#snapCaption').attr("value");rs.description=$('#snapDescription').attr("value");return rs;}
lib.setSnapFieldValues=function(vls){$('#snapCaption').attr("value",vls.caption);$('#snapDescription').attr("value",vls.description);}
lib.grabTheSnap=function(){lib.vp.clearOverlays("both");lib.selectPanel("creatingSnap");var sdata=lib.createSnapFieldValues();var data={caption:sdata.caption,description:sdata.description};if(lib.albumD)data.album=lib.albumD.topic; data.image=lib.imD.topic;if(lib.editingSnap){var url="/api/editSnap";var snapD=lib.editingSnap;data.topic=snapD.topic;if(lib.vp.selectedAreaModified){data.newCrop=1;var newCoverage=lib.vp.selectedArea;data.coverage=newCoverage.externalize();snapD.coverage=newCoverage;}else{data.coverage=snapD.coverage.externalize();data.newCrop=0;data.cropid=snapD.cropid;}}else{var url="/api/addSnap";data.coverage=lib.vp.selectedArea.externalize();data.newCrop=0}
lib.vp.deactivateAreaEditor();util.log("api","coverage ",data.coverage);var cb=lib.snapCallback;function callSnapOp(){util.post(url,data,function(rs){util.log("api","data returned",rs);lib.exitCreateSnap();if(rs.status!="ok"){if(rs.msg=="testing"){console.log("TESTING ADDSNAP");return;}
util.logout();location.href="/timeout"
return;}
cb(rs);},"json");}
if(lib.imOnly){ nsurl="/api/newAlbum";util.post(nsurl,{image:lib.imD.topic,caption:"Untitled"},function(rs){ var atp=rs.value.topic; var alb={topic:atp,caption:"Untitled",image:lib.topic,owner:idv.loggedInUser};lib.albumD=alb;lib.albumTopic=atp;lib.imOnly=false;lib.updateButtonVis();data.album=atp;callSnapOp();var abc=22;});}else{callSnapOp();}}
lib.exitCreateSnap=function(){lib.showSnapsButton.show();if(lib.publishButton)lib.publishButton.show();lib.vp.defAreaMode=false;lib.vp.deactivateAreaEditor();lib.vp.selectedArea=undefined;lib.showSnapsMode=lib.preCreateSnapShowSnapsMode;if(lib.showSnapsMode){lib.redisplaySnaps();}}
lib.cancelTheSnap=function(){lib.exitCreateSnap();lib.selectPanel(lib.lastPanel);}
lib.deleteSnap=function(snap){var nsnaps=util.removeFromArray(lib.snaps,snap);snap.container.remove();var ln=nsnaps.length;lib.snapsActive=ln;var nsnapDs=[];for(var i=0;i<ln;i++){var cs=nsnaps[i].snapD;cs.myIndex=i;nsnapDs.push(cs);}
lib.snapDs=nsnapDs;lib.snaps=nsnaps;lib.selectPanel("snapArray");lib.clearSelectedSnaps();if(lib.showSnapsMode)lib.redisplaySnaps();}
lib.serverDeleteSnap=function(){var url="/api/deleteSnap";var snap=lib.selectedSnap.snapD.topic;var data={"topic":snap};util.post(url,data,function(rs){util.log("api","data returned",rs);if(rs.status!="ok"){util.logout();location.href="/timeout"
return;}
lib.deleteSnap(lib.selectedSnap.snap);},"json");}
lib.addCreateSnapDiv=function(container){container.append(lib.createSnapDiv);container.append(lib.creatingSnapDiv);lib.setPanelPanel("createSnap",lib.createSnapDiv);lib.setPanelPanel("creatingSnap",lib.creatingSnapDiv);lib.createSnapDiv.hide();lib.selectSnapArea=$('#selectSnapArea');lib.setClickMethod($('#submitSnap'),lib.grabTheSnap);lib.setClickMethod($('#submitAlbum'),lib.createTheAlbum);lib.setClickMethod($('#cancelSnap'),lib.cancelTheSnap);}})();
(function(){var lib=page;var geom=idv.geom;var imlib=idv.image;var com=idv.common;var util=idv.util;lib.imageDetailsWd=400;lib.imageDetailsDiv=$('<div class="imageDetailsDiv">'+'<div id="title"></div>'+'<div id="description"></div>'+'<table id="imageFields">'+'<tr id="authorRow"><td  class="rowTitle">Artist/Photographer:</td><td class="rowValue"><span style="width:'+lib.imageDetailsWd+'px" id="author"/></td></tr>'+'<tr  id="yearRow"><td  class="rowTitle">Year:</td><td class="rowValue"><span style="width:'+lib.imageDetailsWd+'px" id="year"/></td></tr>'+'<tr  id="tagsRow"><td  class="rowTitle">Tags:</td><td class="rowValue"><span style="width:'+lib.imageDetailsWd+'px" id="tags"/></td></tr>'+'<tr id="externalLinkRow" ><td class="rowTitle">External Link:</td><td class="rowValue"><span style="width:'+lib.imageDetailsWd+'px" id="externalLink"/></td></tr>'+'<tr id="contributorRow" ><td class="rowTitle">Contributed by:</td><td class="rowValue"><span style="width:'+lib.imageDetailsWd+'px" id="contributor"/></td></tr>'+'<tr class="dimensionRow"><td class="rowTitle">Dimensions:</td><td class="rowValue"><span style="width:'+lib.imageDetailsWd+'px" id="dimensions"/></td></tr>'+'<tr><td class="rowTitle">Source</td><td><div style="width:'+lib.imageDetailsWd+'px;;word-wrap:break-word" id="imageSource"></div></td></tr>'+'<tr id="licenseRow" ><td class="rowTitle">License:</td><td class="rowValue"><span style="width:'+lib.imageDetailsWd+'px" id="license"/></td></tr>'+'<tr class="publicRow"><td id="isPublic" class="rowTitle">Public</td></tr>'+'<tr class="albumTitleRow"><td class="rowTitle">Album title:</td><td class="rowValue"><span style="width:'+lib.imageDetailsWd+'px" id="albumTitle"/></td></tr>'+'<tr class="albumDescriptionRow"><td class="rowTitle">Album Description:</td></tr>'+'</table>'+'<div id="albumDescription"></div>'+'<div id="buttons"><span id="editButton" class="clickableElement">Edit</span></div>'+'</div>');lib.licenseText={"PD-old":'<a href="http://en.wikipedia.org/wiki/Public_domain">Public Domain</a> in the United States, and those countries with a copyright term of life of the author plus 100 years or less',"PD-author":'Released into the <a href="http://en.wikipedia.org/wiki/Public_domain">Public Domain</a> by the author',"PD-self":'Released into the <a href="http://en.wikipedia.org/wiki/Public_domain">Public Domain</a> by the author',"cc-by-sa-3.0":'Creative Commons Attribution-ShareAlike 3.0',"cc-by-3.0":'<a href="http://creativecommons.org/licenses/by/3.0/">Creative Commons Attribution 3.0</a>'}
lib.computeAboutText=function(){var imD=lib.imD;var imd=""
if(imD.title){imd+="{{{"+imD.title+"}}}";}
if(imD.author){imd+=" by "+imD.author}
imd+="\n\n"
var ds=imD.description;if(ds){imd+=ds}
return imd;}
lib.popImageDetails=function(){lib.lightbox.pop();lib.lightbox.element.empty();lib.lightbox.addClose();function adjustLightBoxHeight(){var ht=lib.imageDetailsDiv.height();var lbh=lib.lightbox.element.height();lib.lightbox.element.css({"height":(ht+40)+"px"});}
lib.imageDeleteable=function(){ var aln=lib.allAlbumDs.length;if(aln==0)return true;var imowner=lib.imD.owner;for(var i=0;i<aln;i++){var calb=lib.allAlbumDs[i];if(calb.owner!=imowner){return false;}}
return true;}
lib.lightbox.element.append(lib.imageDetailsDiv);if($.trim(lib.imD.description)){var dst=$("#description",lib.imageDetailsDiv);dst.empty();dst.css({"word-wrap":"break-word","margin-left":"20px","margin-bottom":"10px","margin-top":"10px"});dst.html(util.processMarkdown(lib.imD.description));}else{$("#descriptionRow",lib.imageDetailsDiv).hide();}
$("#title",lib.imageDetailsDiv).css({"font-weight":"bold","margin-left":"10px","margin-right":"10px","margin-top":"10px","text-align":"center"});$("#imageFields",lib.imageDetailsDiv).css({"margin-left":"10px","margin-right":"10px","margin-top":"10px"});$(".rowTitle",lib.imageDetailsDiv).css({"padding-left":"10px","padding-right":"20px"});$("tr",lib.imageDetailsDiv).css({"padding-top":"10px"});$("#albumDescription",lib.imageDetailsDiv).css({"margin-left":"50px"});$("#buttons",lib.imageDetailsDiv).css({"margin-top":"30px","margin-left":"30px"});var ttl=$.trim(lib.imD.title);if(!ttl){ttl=util.pathLast(lib.imD.topic);}
$("#titleRow",lib.imageDetailsDiv).show();$("#title",lib.imageDetailsDiv).html(util.sanitize(ttl));var ownm=lib.imD.ownerName;var cdiv=$("#contributor",lib.imageDetailsDiv);if(ownm){cdiv.show()
cdiv.html(util.sanitize(lib.imD.ownerName));}else{$('#contributorRow').hide();}
if($.trim(lib.imD.author)){$("#authorRow",lib.imageDetailsDiv).show();
$("#author",lib.imageDetailsDiv).html(util.sanitize(lib.imD.author));}else{$("#authorRow",lib.imageDetailsDiv).hide();}
if($.trim(lib.imD.year)){$("#yearRow",lib.imageDetailsDiv).show();$("#year",lib.imageDetailsDiv).html(util.sanitize(lib.imD.year));}else{$("#yearRow",lib.imageDetailsDiv).hide();}
var tags=lib.imD.tags;var tagel=$("#tags",lib.imageDetailsDiv)
if(tags&&(tags.length>0)){var tagst=tags.join(", ");tagel.html(tagst);}
var lnk=$.trim(lib.imD.externalLink);if(lnk){$("#externalLinkRow",lib.imageDetailsDiv).show();var edv=$("#externalLink",lib.imageDetailsDiv);var a=$('<a>');var sanlnk=util.sanitize(lnk);a.attr("href",lnk);a.attr("target","imagediverTarget");edv.empty();edv.append(a);a.html(sanlnk);}else{$("#externalLinkRow",lib.imageDetailsDiv).hide();}
var dim=lib.imD.dimensions;var dims=dim.x+" pixels wide by "+dim.y+" pixels high";$('#dimensions',lib.imageDetailsDiv).html(dims);var src=lib.imD.source;var srcel=$('#imageSource');srcel.css({'text-decoration':'underline','cursor':'pointer'});if(src){srcel.show();srcel.html(src);srcel.click(function(){window.open(src)});}else{srcel.hide();}
$('#imageSource').html((lib.imD.source)?(lib.imD.source):'');if(!lib.imOnly){var cap=lib.albumD.caption;if(cap&&(cap!="Untitled"))$('#albumTitle').html(cap);else $('.albumTitleRow').hide();var ads=lib.albumD.description;var adsel=$('#albumDescription');if(ads){adsel.show();adsel.empty();adsel.css({"word-wrap":"break-word"});adsel.html(util.processMarkdown(ads));}else{$('.albumDescriptionRow').hide();}}
$('p',lib.imageDetailsDiv).css({"margin":"0px"});if(lib.imD.isPublic){var pubtxt="Public Image";}else{pubtxt="Private Image";}
$('#isPublic',lib.imageDetailsDiv).html(pubtxt);var lic=lib.imD.license;if((!lic)||(lic=="none")){$('#licenseRow').hide();}else{$('#license').html(lib.licenseText[lic]);}
if(lib.isSnaps){$(".albumTitleRow").hide();$(".albumDescriptionRow").hide();}
var canEditImage=lib.imD.owner==idv.loggedInUser;var canEditAlbum=lib.albumD&&(lib.albumD.owner==idv.loggedInUser); if((!idv.atS3)&&((lib.imOnly&&canEditImage)||(!lib.imOnly&&(canEditImage||canEditAlbum)))){$("#buttons",lib.imageDetailsDiv).show();$("#editButton",lib.imageDetailsDiv).click(function(){lib.popEditImageLightbox();}); $("#buttonMsg").hide();}else{$("#buttons",lib.imageDetailsDiv).hide();}
}})();

(function(){var lib=page;var geom=idv.geom;var imlib=idv.image;var com=idv.common;var util=idv.util;lib.licenseOptions=["PD-old: Public Domain where the author died more thn 100 years ago","PD-self: A statement intended to release your own work into public domain","PD-author: A statement that the work is released into the public domain by its author","cc-by-3.0: Creative Commons Attribution 3.0","cc-by-sa-3.0:Creative Commons Attribution-ShareAlike 3.0","Copyright &lt;author(above)&gt; &lt;year(above)&gt;","Other"]
lib.copyrightIndex=4;lib.licenseOptions=["No License Asserted (retain all rights)","PD-old: Public Domain where the author died more thn 100 years ago","PD-self: A statement intended to release your own work into public domain","PD-author: A statement that the work is released into the public domain by its author","cc-by-3.0: Creative Commons Attribution 3.0","cc-by-sa-3.0:Creative Commons Attribution-ShareAlike 3.0",]
lib.licenseCode=function(opt){if(!opt)return"none";var sp=opt.split(":");if(sp.length==1){return"none"}else{return sp[0];}}
lib.licenseIdx=function(cd){}
lib.genLicenseOption=function(n){return"<option style='width:200px' id='option"+n+"' value = '"+n+"'>"+lib.licenseOptions[n]+"</option>";}
lib.genLicenseOptions=function(){var rs="";var ln=lib.licenseOptions.length;lib.licenseIndices={};for(var i=0;i<ln;i++){var opt=lib.licenseOptions[i];var cd=lib.licenseCode(opt);lib.licenseIndices[cd]=i;rs+=lib.genLicenseOption(i);}
return rs;}
lib.editImageWd=450;lib.editImageDiv=$('<div class="editImageDiv">'+'<div id="newNote">Describe your image. </div>'+'<div id="optional">optional, and you can always come back and edit image properties via "image details"</div>'+"<div id='editNote'>This is a shared image, imported by another user, so you can't edit its properties. Only the album title and description are available for editing.</div>"+'<table id="imageFields">'+'<tr class="forImage"><td class="inputsTD">Identifier</td><td><span id="imageID"></span></td></tr>'+'<tr class="forImage"><td class="inputsTD">Title</td><td><input style="width:'+lib.editImageWd+'px" id="imageTitle" type="text"/></td></tr>'+'<tr class="forImage"><td class="inputsTD"></td><td>To include links or other formatting in the description, use <a target="_blank" href="http://daringfireball.net/projects/markdown/basics">Markdown</a></td></tr>'+'<tr class="forImage"><td class="inputsTD">Description</td><td><textarea style="width:'+lib.editImageWd+'px" rows="5"  id="imageDescription"/></td></tr>'+'<tr class="forImage"><td class="inputsTD">Artist/<br/>Photographer</td><td><input style="width:'+lib.editImageWd+'px" id="imageAuthor" type="text"/></td></tr>'+'<tr class="forImage"><td class="inputsTD">Year Created</td><td><input style="width:'+lib.editImageWd+'px" id="imageYear" type="text"/></td></tr>'+'<tr class="forImage"><td class="inputsTD">Tags</td><td><input style="width:'+lib.editImageWd+'px" id="imageTags" type="text"/></td></tr>'+'<tr class="forImage"><td class="inputsTD" id="externalLinkLabel">External Link</td><td><input style="width:'+lib.editImageWd+'px" id="imageExternalLink" type="text"/></td></tr>'+
'<tr class="forImage"  id="publicRow" ><td class="inputsTD"></td><td><input  id="publicImage" type="checkbox"  /> Public  </td></tr>'+
'<tr class="forImage"><td class="inputsTD">Dimensions</td><td id="imageDimensions"></td></tr>'+
'<tr id="imageErrorRow"><td class="inputsTD">Error</td><td style="color:red" id="imageErrorMessage">restrict</td></tr>'+'</table>'+'<div class="forImage">License. (<a href="/license" target="idvWindow">About licensing</a>) </div>'+'<div class="forImage" id="licenseDiv"><select id="licenseSelect">'+lib.genLicenseOptions()+'</select></div>'+'<hr id="ahr"/>'+'<div id="albumNote">Properties of this album of annotations, as opposed to the image itself (optional)</div>'+'<table id="albumFields">'+'<tr><td class="inputsTD" id="albumTitleLabel">Title</td><td><input style="width:'+lib.editImageWd+'px" id="albumTitle" type="text"/></td></tr>'+'<tr><td class="inputsTD">Description</td><td><textarea style="width:'+lib.editImageWd+'px" rows="3"  id="albumDescription"/></td></tr>'+'</table>'+'<div id="editImageButtons" class="editImageLine">'+'<span id="submitImageEdit" class="clickableElement">Save</span>'+'<span id="cancelImageEdit" class="clickableElement">Cancel</span>'+'</div>'+'</div>');lib.editImageInitializer=function(newImage){if(!newImage){$('#newNote').hide();$('#optional').hide();}
if(lib.imOnly){$('#ahr').hide();$("#albumNote").hide();$("#albumFields").hide();}
lib.canEdit=lib.imD.owner==idv.loggedInUser;
var erow=$('#imageErrorRow');erow.hide();var imD=page.imD;var imPublic=imD.isPublic;if(imPublic){$('#publicImage').attr('checked','checked');}else{$('#publicImage').removeAttr('checked','checked');}
if(lib.canEdit){var tp=imD.topic;var id=util.lastPathElement(tp);$('#imageID').html(id);var ttl=imD.title;if(imD.description)ds=imD.description;else ds="";$('#imageTitle').val(ttl);if(!lib.imOnly){$('#albumTitle',lib.editImageDiv).val(lib.albumD.caption);$('#albumDescription',lib.editImageDiv).val(lib.albumD.description);}
$('#imageDescription',lib.editImageDiv).val(ds);$('#imageAuthor').val((imD.author)?(imD.author):'');$('#imageYear').val((imD.year)?(imD.year):'');$('#imageTags').val((imD.tags)?imD.tags.join(", "):'');$('#imageExternalLink').val((imD.externalLink)?(imD.externalLink):'');var dim=imD.dimensions;var dims=dim.x+" pixels wide by "+dim.y+" pixels high";$('#imageDimensions').html(dims);var lic=imD.license;var lidx=lib.licenseIndices[lic];$('#licenseSelect').attr('value',lidx);$('#editNote').hide();util.addToolTip($('#externalLinkLabel',lib.editImageDiv),"An external URL (eg a wikipedia page) associated with the album. Leave blank if not applicable");}else{$('#albumTitle',lib.editImageDiv).val(lib.albumD.caption);$('#albumDescription',lib.editImageDiv).val(lib.albumD.description);$('#editNote').css({'margin':'10px'});$('.forImage').hide();}}
lib.editImageFieldValues=function(){var rs={};rs.title=util.htmlRemove($('#imageTitle').attr("value"));rs.author=util.htmlRemove($('#imageAuthor').attr("value"));rs.description=$('#imageDescription').attr("value");rs.albumTitle=util.htmlRemove($('#albumTitle').attr("value"));
rs.albumDescription=$('#albumDescription').attr("value");rs.externalLink=$('#imageExternalLink').attr("value");rs.isPublic=$('#publicImage').attr('checked')?1:0;var slo=$('#licenseSelect').attr("value");var lo=lib.licenseOptions[slo];var lc=lib.licenseCode(lo);rs.license=lc;var yr=$('#imageYear').attr("value");if($.trim(yr)){rs.year=yr;}else{rs.year="";}
var tags=$.trim($('#imageTags').attr("value"));if(tags==""){var tagsf=[];}else{var tagsp=tags.split(",");var isErr=false;var re=/^[\w\ \-]*$/;var tagsf=idv.util.arrayMap(tagsp,function(tag){var tr=$.trim(tag);if(!re.test(tr)){isErr=true;}
return tr;});if(isErr){return{"error":'Tags may include only alpha-numeric characters, digits, "-","_",and spaces'};}}
rs.tags=tagsf;return rs;}
lib.editImageCallback=function(rs){var vl=rs.value;page.imD.description=vl.description;page.imD.title=vl.title;var imd=lib.computeAboutText();page.updateTopbarOptions(page.topbar.options);page.topbar.render()
lib.popImageDetails();}
lib.editTheImage=function(){if(lib.canEdit){var imD=page.imD;var sdata=lib.editImageFieldValues();var erow=$('#imageErrorRow');erow.show();if(sdata.error){var msg=$('#imageErrorMessage');msg.html(sdata.error);return;}
erow.hide();var data={image:imD.topic};if(!lib.isSnaps){data.albumTopic=lib.albumD.topic;}
util.setProperties(data,sdata,["title","description","author","externalLink","year","isPublic","license","tags"]);if(!lib.imOnly)util.setProperties(data,sdata,["albumTitle","albumDescription"]);util.setProperties(imD,sdata,["title","description","author","externalLink","year","license","tags","isPublic"]);if(!lib.imOnly){lib.albumD.caption=sdata.albumTitle;lib.albumD.description=sdata.albumDescription;}
var url="/api/editImage";var cb=lib.editImageCallback;util.post(url,data,function(rs){util.log("api","data returned",rs);if(rs.status!="ok"){util.logout();location.href="/timeout";return;}
cb(rs);},"json");util.log("api","uuuuu");}else{var sdata=lib.editImageFieldValues();var data={caption:sdata.albumTitle,description:sdata.albumDescription};data.image=lib.imD.topic;data.topic=lib.albumD.topic;var url="/api/editAlbum";util.post(url,data,function(rs){if(rs.status=="ok"){lib.albumD.caption=data.caption;lib.albumD.description=data.description;lib.updateTopbarOptions(lib.topbar.options);lib.topbar.render()
lib.popImageDetails();}else{util.logout();location.href="/timeout"
return;}});}}
lib.cancelEditImage=function(){lib.popImageDetails();}
lib.popEditImageLightbox=function(newImage){lib.lightbox.pop();lib.lightbox.element.empty();lib.lightbox.addClose();lib.lightbox.element.append(lib.editImageDiv);$('#editImageButtons',lib.editImageDiv).css({"margin-top":"10px"});lib.editImageDiv.css({"margin-left":"10px","margin-top":"20px"});$('#newNote',lib.editImageDiv).css({"text-align":"center","width":"100%"});$('div',lib.editImageDiv).css({"margin-bottom":"10px"});$('#optional',lib.editImageDiv).css({"text-align":"center","width":"100%","font-size":"8pt","font-style":"italic"});var sie=$('#submitImageEdit');var cie=$('#cancelImageEdit')
sie.click(lib.editTheImage);cie.click(function(){lib.popImageDetails();});lib.editImageInitializer(newImage);}
lib.addEditImageDiv=function(container){}})();

(function(){var lib=page;var geom=idv.geom;var imlib=idv.image;var com=idv.common;var util=idv.util;lib.createAlbumWd=450;lib.editAlbumDiv=$('<div class="editAlbumDiv">'+'<div id="note">Note: these fields are optional, and can be edited later via "image details/ Edit"  </div>'+'<hr/>'+'<div class="albumFields">'+'<div id="editAlbumExplanation" style="text-align:center;margin-bottom:10px"></div>'+'<table id="albumFields">'+'<tr><td class="inputsTD">Title<td><td><input size="40" id="albumCaption" value="Untitled" type="text"/></td></tr>'+'<tr><td class="inputsTD"></td><td></td><td>To include links or other formatting in the description, use   <a href="http://daringfireball.net/projects/markdown/basics" target="idvWindow">Markdown</a></i></td></tr>'+'<tr><td class="inputsTD">Description<td><td><textarea rows="6" cols="50" id="albumDescription"/></td></tr>'+
'</table>'+'</div>'+'</table>'+'<div id="editAlbumButtons" class="buttonLine">'+'<span id="submitAlbum" class="clickableElement">Save</span>'+'<span id="cancelAlbum" class="clickableElement">Cancel</span>'+'</div>'+'</div>');lib.deleteAlbumDiv=$('<div id="deleteAlbum">'+'<div class="areYouSure">Are you sure you wish to delete this album, and its snapshots? There is no undo.</div>'+'<div>'+'<span  style="margin-left:20px" id="yesDeleteAlbum" class="clickableElement">Yes, Delete</span>'+'<span   id="noDontDeleteAlbum" style="margin-left:30px"  class="clickableElement">Cancel</span>'+'</div>'+'</div>');lib.createAlbumJsonP=function(imTopic,cb){var data={image:imTopic};var url="http://"+idv.apiHost+"/api/newAlbumJsonP";util.getJsonP(url,data,function(rs){cb(rs.value);});}
lib.deleteTheAlbum=function(){var data={topic:lib.albumD.topic};var url="/api/deleteAlbum";var imtp=lib.albumD.image.topic;util.post(url,data,function(rs){if(rs.status!="ok"){util.logout();location.href="/timeout";return;}
location.href="/mywork";},"json");util.log("api","uuuuu");}
lib.editAlbumFields=function(){var caption=$('#albumCaption',lib.editAlbumDiv).attr('value');var ds=$('#albumDescription',lib.editAlbumDiv).attr('value');var data={caption:caption,description:ds,topic:lib.albumD.topic};var url="/api/editAlbum";util.post(url,data,function(rs){lib.albumD.caption=data.caption;lib.albumD.description=data.description;lib.updateTopbarOptions(lib.topbar.options);lib.topbar.render()
lib.lightbox.dismiss();});}
lib.popEditAlbumLightbox=function(){lib.lightbox.pop();lib.lightbox.element.empty();lib.editAlbumDiv.css({"margin":"20px"});lib.lightbox.addClose();lib.albumD.caption='Untitled';lib.lightbox.element.append(lib.editAlbumDiv);$('#submitAlbum',lib.editAlbumDiv).click(function(){lib.editAlbumFields();});$('#cancelAlbum',lib.editAlbumDiv).click(function(){lib.lightbox.dismiss();});return;}
lib.showAlbumChoice=function(albums,im){var tp=im.topic;if(!albums||(albums.length==0)){var tpo=new util.topicOb(tp);tpo.albumId="-";tpo.kind="album";var atp=tpo.topic();var dst="http://"+idv.apiHost+idv.topicDir+atp+"/index.html";location.href=dst;return;}
var msg=$('<div id="lightboxMessage"/>');msg.css({'margin':'30px'});msg.append('<div>These are your albums of annotations of <i>'+util.imTitle(im)+'</i>:</div>');util.arrayForEach(albums,function(a){var abc=22;var ael=$('<div>').html(a.caption).css({'margin-top':'10px','margin-left':'20px','text-decoration':'underline','cursor':'pointer'});var dst="http://"+idv.apiHost+idv.topicDir+(a.topic)+'/index.html';ael.click(function(){location.href=dst;})
msg.append(ael);});util.addButton(msg,"Create New Album",function(){lib.createAlbumJsonP(tp,function(atp){var dst="http://"+idv.apiHost+idv.topicDir+atp+"/index.html?new=1";location.href=dst;});},true).css({"margin-top":"20px"});lib.lightbox.popMessage(msg);}
lib.popAlbumChoice=function(im){var tp=im.topic;if(!idv.loggedInUser){var tpo=new util.topicOb(tp);var url=idv.topicDir+"/album/"+tpo.imageOwner+"/"+tpo.imageName+"/-/index.html";location.href=url;return;}
var url="http://"+idv.apiHost+"/api/albumsForImageJsonP";var data={image:tp};util.getJsonP(url,data,function(rs){var albums=rs.value;lib.showAlbumChoice(albums,im);})}})();
(function(){var lib=page;var geom=idv.geom;var imlib=idv.image;var com=idv.common;var util=idv.util;lib.aboutImageDiv=$('<div id="aboutImage"></div>');lib.aboutImageDiv.data("initializer",function(){var albumD=lib.albumD;if(albumD){var d=albumD.description;}else{var imD=lib.imD;d=imD.description;}
if(!d){if(albumD){imD=lib.imD;d=imD.description;}}
if(!d){d="No description yet";}
$('#aboutImage').html(d);var ht=$("#aboutImage").height();var dht=lib.defaultPanelHeight();var aht=Math.max(ht,dht);});lib.addAboutImageDiv=function(container){container.append(lib.aboutImageDiv);var pn=lib.setPanelPanel("aboutImage",lib.aboutImageDiv);pn.selfScaling=true;}})();
(function(){var common=idv.common;var lib=page;var util=idv.util;lib.progressBar=function(options){this.options=options;this.status="not_started";}
lib.progressBar.prototype.cancel=function(){u=this.options.job;this.canceled=1;this.jobc.canceled=1;if(!u)return;var url="/topic"+u.topic+"/cancel()";var thisHere=this;idv.util.post(url,null,function(rs){thisHere.jobc.cancel();});}
lib.progressBar.prototype.render=function(){var o=this.options;var c=o.container;var u=o.job;var err=u.error;if(err){c.empty();c.append('<div id="errorMsg">');$("#errorMsg").html(err);this.beenRendered=false; return;}
var ttl=o.mainTitle;var brnd=this.beenRendered;var sttl=o.stageTitle;var w=o.width;var h=o.height;var wd=o.whenDone;if(!brnd){c.empty();var mainDiv=$('<div id="mainDiv">'+'<div id="mainTitle"/>'+'<div id="stageTitle"/>'+'<div id="jobProgressBar">'+'<div id = "innerBar"/>'+'</div>'+
'</div>');c.append(mainDiv);$(" div",mainDiv).css({"margin-top":"20px","margin-bottom":"20px"});this.beenRendered=true;}
$('#jobProgressBar').css({width:w,height:h,"background-color":"white"});$('#innerBar').css({left:0,top:0,width:0,height:h,"background-color":"green"});if(ttl)$('#mainTitle').html(ttl);$('#stageTitle').html(sttl);this.initTime=new Date().getTime();this.monitorCount=0;if(!brnd){c.append('<div id = "jobText"></div>');}
var textDiv=$('#jobText');textDiv.css({"margin-top":20,top:h+10,left:0,width:w});textDiv.html("Not started");this.textDiv=textDiv;if(!brnd){var cancelContainer=$('<div></div>').css("margin-top",20);c.append(cancelContainer);var cancelButton=$('<span class="clickableElement">Cancel</span>');cancelContainer.append(cancelButton);var thisHere=this;this.cancelButton=cancelButton;cancelButton.click(function(){thisHere.cancel();});}}
lib.progressBar.prototype.allDone=function(area){ if(area){$('#mainDiv').hide();this.cancelButton.hide();var o=this.options;var u=o.job;var sb=u.subject;if(sb.indexOf("{")>=0){var imnm=$.parseJSON(sb).image_name;}else{imnm=sb;}
var knd=lib.isRetrieval?"retrieval":"upload";$('#jobText').css({"width":"700px"});var msg="The "+knd+" of "+imnm+" is complete. Now the image needs to be prepared for zooming. "+"For an  image of this size ("+idv.util.bytesstring(area,1)+"), this will take a little while. ";if(idv.hasEmail){msg+="An email notification will be sent when the image is ready for use."}else{msg+="Please check your content page for completion (we would send an email, but don't have your address)."}
$('#jobText').html(msg);}else{var uid=idv.util.pathLast(idv.loggedInUser);var imn=idv.imageName;var dst=idv.topicDir+"/album/"+uid+"/"+imn+"/-/index.html";location.href=dst;}}
lib.progressBar.prototype.update=function(u){this.job=u;var o=this.options;var units=o.units;var size=u.total;if(u.status=="not_started")return;if(u.status=="done"){return;this.status="done";this.textDiv.html("done");var wd=o.whenDone;if(wd){wd();}
return;}
if((u.status=="error")||(u.status=="canceled"))return;if(u.status=="error"){this.status="error";$("#jobProgressBar").hide();this.textDiv.html("ERROR "+u.error);return;}
if(u.status=="canceled"){$('#mainDiv').hide();this.cancelButton.hide();this.textDiv.html("canceled import of "+u.subject);return;}
var sofar=u.so_far;var fr=sofar/size;var prc=Math.ceil(fr*100);var idw=Math.ceil(fr*o.width)
$('#innerBar').css({width:idw});if(units==" MB"){sofarst=util.bytesstring(sofar);sizest=util.bytesstring(size);}else{sofarst=sofar;sizest=size;}
this.sizeString=sizest;this.textDiv.html("completed: "+prc+"% -- "+sofarst+" out of "+sizest);}
lib.progressBar.prototype.updateTime=function(){$('#jobTime').html("Elapsed time: ",Math.floor(((new Date().getTime())-this.initTime)/1000));}
})();
var jobController=function(){this.cjob=0;this.monitorInterval=3000;this.monitorMaxCount=1000000000;this.backendThreshold=60*1000*1000;}
jobController.prototype.nextJob=function(){var ln=this.theJobs.length;this.cjob=this.cjob+1;if(this.cjob>=ln){this.progressBar.allDone();return;}
this.startJob();}
jobController.prototype.monitor=function(job){function mylog(){if(0)console.log(idv.util.elapsedTime(),"monitor",idv.util.argsToString(arguments));}
mylog("starting monitor",this.canceled,job.kind,job.status);if(this.canceled){return;}
var thisHere=this;var topic=job.topic;url="/topic"+topic+"/get()";mylog("getting ",url);idv.util.post(url,null,function(rs){thisHere.monitorCount=thisHere.monitorCount+1;if(rs){var job=rs.value;mylog("got",job.kind,job.status,job.so_far,job.total);if(job.status=="error"){thisHere.onError(job);return;}
thisHere.progressBar.update(job);if(job.status=="done"){mylog("next job"); if((job.kind=="retrieve")||(job.kind=="upload")){var sb=job.subject;var sbo=JSON.parse(sb);var dims=sbo.dimensions;var area=dims.x*dims.y;if(area>thisHere.backendThreshold){thisHere.progressBar.allDone(area); var abc=122;}else{thisHere.nextJob();}}else{thisHere.nextJob();}
return;}}
if(thisHere.monitorCount>thisHere.monitorMaxCount)return;if((job.status=="active")||(job.status=="not_started")){setTimeout(function(){thisHere.monitor(job);},thisHere.monitorInterval);}});}
jobController.prototype.cancel=function(){this.canceled=1;var j=this.theJobs[this.cjob];this.onCancel(j);}
jobController.prototype.startFirstJob=function(){this.cjob=0;this.startJob();}
var testing=66;jobController.prototype.startJob=function(){function mylog(){if(0)console.log(idv.util.elapsedTime(),"startJob",idv.util.argsToString(arguments));}
if(this.canceled){return;}
var j=this.theJobs[this.cjob];var topic=j.topic;var topics=topic.split("/");var jId=topics[topics.length-1];var jurl="/api/runJob?id="+jId;var thisHere=this;if(j.kind=="upload"){thisHere.monitorCount=0;thisHere.monitor(j);this.initProgressBar(this,j,function(){thisHere.nextJob();});var f=this.uploadForm;f.attr("action",jurl);f.submit();}else{mylog("starting job",j.kind);idv.util.get(jurl,function(rs){mylog("job started",rs.status,j.kind,j.noMonitoring);if(rs.status=="ok"){thisHere.initProgressBar(thisHere,j);if(j.noMonitoring){thisHere.nextJob();}else{thisHere.monitorCount=0;thisHere.monitor(j);}}else{if(rs.msg=="sessionTimedOut"){util.logout();location.href="/timeout";return;}
j.error=rs.msg;j.msg=rs.msg;thisHere.onError(j);}});}}
function forMinimizer(){alert(22);}
(function(){var lib=page;var geom=idv.geom;var image=idv.image;var com=idv.common;var util=idv.util;lib.clearOverlayState=function(){var dfs=lib.showSnapsMode?"outlined":"noOverlay";util.arrayForEach(lib.snaps,function(snap){snap.snapD.overlayState=dfs;});}
lib.updateOverlays=function(which){var vp=lib.vp;if(which=="selected"){vp.clearOverlays(1);}else if(which=="outlined"){vp.clearOverlays(0);}else{vp.clearOverlays("both");}
util.arrayForEach(lib.snaps,function(snap){var snapD=snap.snapD;var st=snapD.overlayState;if((st=="selected")&&((which=="selected")||(which=="both"))||((st=="outlined")&&((which=="outlined")||(which=="both")))){var cv=snapD.coverage;var nm=snapD.topicId;var ov=new image.Overlay(nm,cv);ov.color=(st=="selected")?"yellow":"red" 
vp.addOverlay(ov);if(st=="selected"){vp.addOverlay(ov,1);}}});if(which=="selected"){vp.drawOverlays(1);}else if(which=="outlined"){vp.drawOverlays(0);}else{vp.drawOverlays("both");}}
image.mouseMoveCallback=function(ps){} 
lib.drawOneRect=function(r,color,sel){var vp=lib.vp;vp.clearOverlay(sel);vp.drawRect(r,"image",color,sel);} 
lib.computeSnapRelevance=function(ps){return lib.snapHit(ps);}
lib.clickSelectedSnaps=function(){var rs=[];util.arrayForEach(lib.snaps,function(snap){if(snap.snapD.clickSelected){rs.push(snap);}});return rs;}
lib.snapsHit=function(ps){var snaps=lib.snaps;var ln=snaps.length;var rs=[];for(var i=0;i<ln;i++){var snapD=snaps[i].snapD;var cv=snapD.coverage;if(cv.contains(ps)){rs.push(snapD);}};return rs;}
lib.closestSnap=function(sns,ps){var mind=1000000000.0;var rs=undefined;util.arrayForEach(sns,function(sn){var cv=sn.coverage;var d=cv.distToCenter(ps);if(d<mind){rs=sn;mind=d;}});return rs;}
lib.snapHit=function(ps){var snaps=lib.snapsHit(ps);return lib.closestSnap(snaps,ps);}
image.mouseMoveCallback=function(ps,vps){if(!lib.showSnapsMode)return;var snhit=lib.snapHit(ps);var dv=lib.vpCapDiv;var vp=lib.vp;if(snhit){if(vp.cHili!=snhit){var cv=snhit.coverage.expand(image.selectStrokeWidth);vp.clearOverlay(2);if(idv.useFlash){vp.drawImRect(cv,"white",2,false,image.selectStrokeWidth*0.5);}else{vp.drawRect(cv,"image","white",2);}
vp.cHili=snhit;} 
var cpt=snhit.caption;if(cpt){dv.show();dv.html(util.removeWikiSymbols(snhit.caption));dv.css({left:vps.x+13,top:vps.y-13});}else{dv.hide();}}else{dv.hide();vp.cHili=null;vp.clearOverlay(2);}}
image.mouseOutCallback=function(){lib.vpCapDiv.hide();} 
lib.DclickTimeoutId=undefined;
lib.snapContains=function(snp,p){var snapD=snp.snapD;if(snapD==undefined){snapD=snp;}
var cv=snapD.coverage;return cv.contains(p);} 
image.clickCallback=function(ps,vps,dclick){ if(!lib.showSnapsMode)return;if(dclick){if(lib.preClickSelSnap){ if(lib.snapContains(lib.preClickSelSnap,ps)){lib.setSelectedSnap(lib.preClickSelSnap);lib.preClickSelSnap=undefined;}}
if(lib.selectedSnap){if(lib.snapContains(lib.selectedSnap,ps)){if(lib.DclickTimeoutId){ clearTimeout(lib.DclickTimeoutId);lib.DclickTimeoutId=undefined;}
lib.vp.setZoom(1);lib.animatedZoomToSnap(lib.selectedSnap.snapD,1.1);}}
return;}
if(!lib.showSnapsMode){var sls=lib.selectedSnap;if(!sls){lib.snapAdvice.html("no snap to select");return;}
var cv=sls.snapD.coverage;var rl=cv.contains(ps);if(!rl){lib.snapAdvice.html("no snap selected");return;}
lib.snapAdvice.html("double click to zoom to the selected snap");}
var csr=lib.computeSnapRelevance(ps);if(typeof csr=="number"){ util.error("OBSOLETE");}
lib.preClickSelSnap=undefined;lib.selectPanel("selectedSnap");lib.showSelectedSnap(csr);lib.showSnapsMode=true;} 
lib.snapRelevant=function(snapD,rect){var cv=snapD.coverage;if(!cv.intersects(rect))return false;var ri=cv.intersect(rect);var ria=ri.area();var cva=cv.area();return ria/cva>0.4;}
lib.computeSnapVisibility=function(){if(lib.leaveSnapVisibilityAlone)return 0;if(lib.zooming)return 0; var vp=lib.vp;var vw=vp.computeCoverage();var cnt=0;var ns=lib.snapsActive;for(var i=0;i<ns;i++){var snapD=lib.snaps[i].snapD;snapD.visible=vw.intersects(snapD.coverage);if(snapD.visible)cnt++;snapD.relevant=lib.snapRelevant(snapD,vw);};if(idv.pageKind=="album")lib.positionSnaps(undefined,true);return cnt;}
lib.redisplaySnaps=function(){lib.computeSnapVisibility();lib.snapAdvice.show();lib.clearOverlayState(0);lib.updateOverlays("outlined");}
lib.enterShowSnapsMode=function(){if(lib.showSnapsMode)return;lib.showSnapsMode=true;lib.redisplaySnaps();lib.snapAdvice.html(lib.stdSnapAdvice());lib.showSnapsButton.html('hide outlines');}
lib.exitShowSnapsMode=function(){if(!lib.showSnapsMode)return;lib.vpCapDiv.hide();lib.vpSelectDiv.hide(); lib.showSnapsMode=false;var vp=lib.vp;lib.showSnapsButton.html('show outlines');lib.snapAdvice.html("");util.arrayForEach(lib.snaps,function(snap){snap.snapD.clickSelected=false;});lib.clearOverlayState();lib.updateOverlays("outlined");lib.snapAdvice.html(lib.stdSnapAdvice());}
lib.ss=function(){lib.enterShowSnapsMode();}})();
(function(){var lib=page;var geom=idv.geom;var imlib=idv.image;var util=idv.util;idv.css.link={"text-decoration":"underline","cursor":"pointer"};lib.setSelectedSnapCallbacks.push(function(){return;});lib.stdSnapAdvice=function(){if(idv.pageKind!="album")return"";if(lib.showSnapsMode){return"click within outline for detail, doubleclick to zoom there";}else{if(lib.selectedSnap){return"double click to zoom to the selected snap";}else{return"";}}}
lib.renderZoomControl=function(container){var cnt=container;var setZoom=function(z){lib.vp.setZoom(z);};var getZoom=function(){return lib.vp.zoom;};var zmropts={container:cnt,maxZoom:lib.vp.maxZoom,setZoom:setZoom,getZoom:getZoom,zoomIncrement:1.05,zoomFactor:2,zoomDelay:50};var zmr=new idv.zoomSlider(zmropts);lib.zSlider=zmr;lib.vp.zoomCallbacks.push(function(z){lib.zSlider.positionSliderFromZoom(z);});var otherButtons=$('<span></span>');otherButtons.css({left:lib.zSlider.totalWidth+20,top:15,position:"absolute"});cnt.append(otherButtons);var viewAll=$('<span class="clickableElement">view all</span>');viewAll.css({"margin-right":"10px"});otherButtons.append(viewAll);viewAll.click(function(){if(lib.vp.zoom==1){lib.computeSnapVisibility();}else{lib.vp.setZoom(1);}
if(lib.currentPanel.name=="snapArray"){lib.selectClickable(lib.snapArrayButton);}});var showSnaps=$('<span class="clickableElement">show outlines</span>');showSnaps.css("font-size","9pt");lib.showSnapsButton=showSnaps;if(idv.pageKind!="album"){showSnaps.hide();}
otherButtons.append(showSnaps);showSnaps.click(function(){if(lib.showSnapsMode){lib.exitShowSnapsMode();}else{lib.enterShowSnapsMode();}});var snapAdvice=$('<span></span>');snapAdvice.html(lib.stdSnapAdvice());snapAdvice.css({left:lib.zSlider.totalWidth,top:45,position:"absolute"})
lib.snapAdvice=snapAdvice;cnt.append(snapAdvice);var gap=$('<div class="gap"></div>');container.append(gap);}
lib.embedText=function(wd){return"";}
lib.renderButtons=function(container){var testingEmbed=0; var cnt=container;var elements={};var loggedInUser=idv.loggedInUser;var canAddSnap=false;if((idv.pageKind=="album")&&lib.editPermissions()){canAddSnap=true;var createSnapActivator=$('<span class="clickableElement">new snap</span>');pn=lib.setPanelActivator("createSnap",createSnapActivator);pn.scalable=false;pn.height=null;pn.scalable=false;pn.height=null;}
var selectedSnapActivator=$('<span class="clickableElement">1 by 1</span>');lib.selectedSnapActivator=selectedSnapActivator;pn=lib.setPanelActivator("selectedSnap",selectedSnapActivator);pn.selfScaling=true;lib.setPanelNominalHeight("selectedSnap",400);if(idv.pageKind=="album"){var snapArrayActivator=$('<span class="clickableElement">all snaps</span>');lib.snapArrayButton=snapArrayActivator;snapArrayActivator.click(function(){lib.computeSnapVisibility();});pn=lib.setPanelActivator("snapArray",snapArrayActivator);pn.selfScaling=true;}
if(1){if(idv.pageKind=="album"){cnt.append(snapArrayActivator);cnt.append(selectedSnapActivator);if(loggedInUser){cnt.append(createSnapActivator);}}
if(idv.embed)return;if(idv.pageKind=="album"){var tumblrButton=$('<span style="vertical-align:top" class="clickableElement">&#x25BA;tumblr</span>');lib.tumblrButton=tumblrButton;cnt.append(tumblrButton);tumblrButton.click(function(){var ssn=lib.selectedSnap;var url="http://"+idv.apiHost+"/post_to_tumblr";if(ssn){var sd=ssn.snapD;var data=util.setProperties(null,sd,["caption","cropid","description","topic"]);}else{var data=util.setProperties(null,lib.albumD,["caption","description","topic"]);if(lib.imD.description)data.imageDescription=lib.imD.description;}
data.linkToSnap=1;if(lib.imD.title)data.imageTitle=lib.imD.title;if(lib.imD.author)data.imageAuthor=lib.imD.author;if(lib.imD.year)data.imageYear=lib.imD.year;var dataj=JSON.stringify(data);sessionStorage.signingInWithTumblr="";sessionStorage.post_to_tumblr_args=dataj; var url="http://"+idv.apiHost+"/post_to_tumblr";var inp;
var frm=$('<form enctype = "text/plain" action="'+url+'" method="POST">').append(inp=$('<input type="hidden" name="data"/>'));
inp.attr("value",dataj);
$(document.body).append(frm);
frm.submit();return;});}
var linkButton=$('<span style="vertical-align:top" class="clickableElement">links</span>');cnt.append(linkButton); if(lib.imOnly)linkButton.hide();lib.linkButton=linkButton;var linkstart="http://s3.imagediver.org/";function addLine(caption,link,includeClose){var lnk=$('<input type="text" onclick="this.focus();this.select()"/>');var line=$('<div><span id="caption"></span></div>').append(lnk);$('#caption',line).html(caption).css({"margin-right":"10px"})
lnk.css({width:"80%","font-size":"8pt"});lnk.attr("value",link);line.css({"margin-right":"10px","margin-left":"10px","margin-top":"10px"})
lnk.css({width:"75%","font-size":"8pt"});lnk.attr("value",link);lib.linkDiv.append(line);}
function addLinkLine(caption,link){var lnk=$('<a href = "'+link+'" target="idvPage">'+link+'</a>');var line=$('<div><span id="caption"></span></div>').append(lnk);lib.linkDiv.append(line);$('#caption',line).html(caption);line.css({"margin-right":"10px","margin-left":"10px","margin-top":"10px"})
lnk.css({width:"75%","font-size":"8pt"});lnk.attr("value",link);}
function addLines(){lib.linkDiv.css({"margin-left":"20px","margin-right":"20px"});var linkstart="http://s3.imagediver.org"+idv.topicDir;var imageJson=linkstart+lib.imD.topic+"/main.json";var imagestart="http://static.imagediver.org/images/";var snapD=page.selectedSnap?page.selectedSnap.snapD:undefined;if(idv.pageKind=="album"){var pageUrl=linkstart+lib.albumD.topic+"/index.html";var pageJson=linkstart+lib.albumD.topic+"/main.json";addLine("Album page:",pageUrl);var albumJson=linkstart+lib.albumD.topic+"/main.json";}
var itpo=new util.topicOb(page.imD.topic);var imu=itpo.imageOwner;var imt=itpo.imageName;if(snapD){var snapNum=snapD.topicId;var cropNum=snapD.cropid;var snapPageUrl=linkstart+snapD.topic+'/index.html';var snapJson=linkstart+snapD.topic+"/main.json";if(idv.pageKind=="snap"){addLine("This page:",snapPageUrl);}else{var snapInAlbum=pageUrl+"#"+snapNum;addLine("Snap in album:",snapInAlbum);addLine("Snap only:",snapPageUrl);addLinkLine("",snapPageUrl);}
var snapImage=imagestart+imu+"/"+imt+"/snap/"+cropNum+".jpg"}
var embedCaption;var embedTextarea=$('<textarea rows="6" wrap="on"  readonly="readonly" onclick="this.focus();this.select()"></textarea>');embedTextarea.css({width:"95%","margin-left":"10px","font-size":"8pt"});var lnm=(idv.pageKind=="album")?"album":"snap";lib.linkDiv.append(embedCaption=$('<div>Paste this into your web page to link to this '+lnm+'</div>').css({"margin-top":"10px"}));lib.linkDiv.append(embedTextarea);if(snapD){embedCaption.css({"margin-right":"10px","margin-left":"10px","margin-top":"10px","font-size":"10pt"})
var eUrl=(idv.pageKind=="album")?snapInAlbum:snapPageUrl;var emtxt='<a href="'+eUrl+'"><img src="'+snapImage+'"/></a>';}else{var fullImage=imagestart+imu+"/"+imt+"/resized/area_250000.jpg";var emtxt='<a href="'+pageUrl+'"><img src="'+fullImage+'"/></a>';}
embedTextarea.html(emtxt);lib.linkDiv.append('<hr/>');lib.linkDiv.append($('<span>Images:</span>'));var fullImage=imagestart+imu+"/"+imt+"/resized/area_250000.jpg";addLine("Full image:",fullImage);var smallerImage=imagestart+imu+"/"+imt+"/resized/area_50000.jpg";addLine($("<span>smaller:</span>").css({'margin-left':'10px'}),smallerImage);addLine($("<span>larger:</span>").css({'margin-left':'10px'}),imagestart+imu+"/"+imt+"/resized/area_1000000.jpg");if(snapD){addLine("Snap image:",snapImage);addLine($("<span>smaller:</span>").css({'margin-left':'20px'}),imagestart+imu+"/"+imt+"/snapthumb/"+cropNum+".jpg");}
lib.linkDiv.append('<hr/>');lib.linkDiv.append($('<span>JSON:</span>'));var qm=$('<span>?</span>').css({"margin-left":"10px","color":"blue","font-size":"8pt","cursor":"pointer"});lib.linkDiv.append(qm);lib.linkDiv.append(explain=$('<div/>'));explain.css({"border":"solid thin black","width":"90%","font-size":"8pt","padding":"5px"});util.addClose(explain);explain.append($('<div>The <a href="http://json.org">JSON</a> files convey complete information about images, albums, and snaps '+'in machine readable form.   The form of the data should be should be self-explanatory to those familiar with JSON, except for one detail. '+' The encoding of the area covered by  a snap looks like this: </div>').css({"margin-right":"30px","margin-bottom":"20px"}));explain.append('<table id="jsonTable">'+'<tr><td>{"coverage": </td><td>{"corner": {"x": 0.25, "y": 0.5},</td></tr>'+'<tr><td></td><td>"extent": {"x": 0.01, "y": 0.02}}</td></tr>'+'</table>');explain.append($('<div>The x and y values are normalized to the width of the image. So, in this example, if the image is 1000 pixels wide,'+'the upper left corner of the snap is at pixel coordinates (250,500), its width is 10 pixels, and its height is 20 pixels.</div>').css({"margin-top":"10px"}));qm.click(function(){explain.show()});explain.hide();addLine("For image:",imageJson);addLinkLine("",imageJson);if(idv.pageKind=="album"){addLine("For album",albumJson);addLinkLine("",albumJson);}
if(snapD){addLine("For snap",snapJson);addLinkLine("",snapJson);}}}
lib.updateLinks=function(){if(linkDiv.css("display")!="none"){linkDiv.empty();addLines();}}
if(linkButton)linkButton.click(function(){lib.lightbox.pop();lib.lightbox.element.empty();lib.lightbox.addClose();lib.linkDiv=$('<div/>').css({"margin-bottom":"10px"});lib.lightbox.element.append(lib.linkDiv);addLines();});if(!canAddSnap&&!(lib.imOnly&&!idv.loggedInUser)){var annotateButton=$('<span style="vertical-align:top" class="clickableElement">annotate</span>');cnt.append(annotateButton); util.addToolTip(annotateButton,"Perform your own annotation of this image");annotateButton.click(function(){if(idv.loggedInUser){lib.popAlbumChoice(lib.imD);}else{lib.lightbox.popMessage("You need to  <a href='"+"http://"+idv.apiHost+"/login'>sign in</a> to add your own annotations to this image. "+"You can sign in with your Tumblr or Twitter account, and in any case registration is quick and free.");}});}
lib.updateButtonVis();}
lib.setParams=function(imD){lib.aspectRatio=1; var imTopic=imD.topic
var imTopicS=imTopic.split("/");lib.imOwner=imTopicS[2];lib.imName=imTopicS[3]; lib.snapThumbMinWidth=250; lib.snapArrayMinThumbWidth=180; lib.prevNextWidth=100; lib.snapThumbMargin=20;lib.snapThumbHeight=150;lib.snapThumbBottomMargin=40;lib.snapThumbCaptionHeight=90;lib.snapGapX=10;lib.snapGapY=10;lib.snapHeight=550; lib.snapTop=120; lib.thumbTop=180;lib.zoomDelay=50;lib.zoomIncrement=1.05;lib.maxZoom=256; lib.initialZoom=1;lib.imD=imD; lib.image=new imlib.Image(imD);lib.tiling=new imlib.Tiling(lib.image,256,1,imD.tilingDepthBump);lib.maxDepth=lib.tiling.depth;}
lib.scaleRect=function(rect,corner,scale){var nex=rect.extent.times(scale);var rs=new geom.Rect(corner,nex);return rs;}
lib.defaultPanelHeight=function(){return lib.standardPanelHeight*lib.theLibrary.scale;}
lib.placeDivs=function(){lib.theLayout.placeDivs();if(lib.vp){lib.vp.scale=lib.theLayout.scale;}
if(lib.vp)lib.vp.refresh(true);}
lib.genFullTitle=function(){if(lib.badUrl){return"Error";}
if(document.location.pathname=="/"){var fullTitle="the depths of high-resolution images, annotated";}else{var author=lib.imD.author;if(author){author=", "+author;}else{author="";}
var imt=lib.imD.title;if(!imt)imt=util.pathLast(lib.imD.topic);var caption=lib.albumD?lib.albumD.caption:"";if(caption){caption=": "+$.trim(caption);}else{caption="";}
fullTitle=imt+author+caption;}
return fullTitle;}
lib.updateTopbarOptions=function(options){var title=lib.genFullTitle();options.title=util.sanitize(title);var dp=[];}
lib.homeTitle="ImageDiver allows you to annotate images in a zoomable context. To see what the results of annotation look like, try "+' clicking on a few of the thumbs on the left below,  over the outlined areas on the right,  and otherwise poking around. (The image is "The Ambassadors" by '+" Hans Holbein the Younger, 1533.) Images can be uploaded from your computer, or grabbed "+" from the web. You can sign in with your Tumblr or Twitter account, and in any case registration is quick and free. ";lib.genDivs=function(){var b=$('body');fullTitle=lib.genFullTitle();fullsize=false;var pqs=util.parseQS();var embed=idv.embed;if(idv.homePage){var title=lib.homeTitle;}else{var title=lib.genFullTitle();}
var topbarOptions={title:util.sanitize(title),embed:embed,detailsLink:{text:"image details",action:lib.popImageDetails},includeGallery:1};var outerDiv=$('.outerDiv');if(outerDiv.length==0){outerDiv=$("<div class='outerDiv'/>");b.append(outerDiv);}
lib.outerDiv=outerDiv;lib.topbar=idv.topbar.genTopbar(outerDiv,topbarOptions);var colsDiv=$("<div class='columns'/>")
outerDiv.append(colsDiv);var c0Div=$("<div class='leftColumnDiv'/>");lib.c0Div=c0Div;colsDiv.append(c0Div);var c1Div=$("<div class='columnDiv'/>");lib.c1Div=c1Div;colsDiv.append(c1Div);if(lib.badUrl){lib.theLayout=new lib.LayoutZero({outerDiv:lib.outerDiv,centerDiv:lib.cDiv,margin:50,minScale:0.6,aspectRatio:1, maxScale:1});return;}
lib.vpDiv=$('<div class="viewport" id="viewport0" style="z-index:0"/>');c1Div.append(lib.vpDiv); var evDiv=$('<div id="evDiv"></div>');evDiv.css({"position":"absolute","background-color":"transparent"});lib.evDiv=evDiv;lib.vpDiv.append(evDiv); lib.vpCapDiv=$('<div class="vpCap" id="viewport0" style="position:absolute;background-color:black;border:solid thin white;padding:3px;font-size:8pt;z-index:1000">TEST</div>');lib.vpDiv.append(lib.vpCapDiv);lib.vpCapDiv.hide();lib.vpSelectDiv=$('<div class="vpSelect" id="vpSelect" style="margin:0px;padding:0px;position:absolute;background-color:transparent;font-size:8pt;z-index:2000;border:solid yellow;border-width:2px;"></div>');lib.vpDiv.append(lib.vpSelectDiv);lib.vpSelectDiv.hide();lib.zoomDiv=$('<div class="controls"/>');c1Div.append(lib.zoomDiv);lib.panels={};lib.panelDiv=$('<div class="panel_container" />'); if(!idv.loggedInUser){lib.panelDiv.mousedown(function(e){ e.preventDefault();});}
lib.bottomDiv=$('<div class="bottomDiv"></div>');var twoC=1;lib.panelDiv.css("overflow","auto");c0Div.append(lib.panelDiv);lib.buttonsDiv=$('<div class="controls"/>');c0Div.append(lib.buttonsDiv);lib.renderButtons(lib.buttonsDiv);lib.updateButtonVis();if(idv.embed){var margin=10;}else{margin=20;}
var aheight=idv.embed?110:(idv.homePage?200:140);lib.theLayout=new lib.LayoutTwo({outerDiv:lib.outerDiv,colsDiv:colsDiv,leftDiv:lib.c0Div,rightDiv:lib.c1Div,panelDiv:lib.panelDiv,vpDiv:lib.vpDiv,evDiv:lib.evDiv,margin:margin,aspectRatio:lib.aspectRatio,minScale:(idv.pageKind=="albums")?0.45:0.33, additionalHeight:aheight, includeLightbox:(!idv.embed)});lib.originalAdditionalHeight=lib.theLayout.additionalHeight;lib.theLayout.placeDivs();lib.topbar.lightbox=lib.theLayout.lightbox;lib.lightbox=lib.theLayout.lightbox;
var vpExtent=lib.theLayout.vpExtent;lib.vpCanvas=imlib.genCanvas({whichCanvas:"vp",extent:vpExtent,container:lib.vpDiv,zIndex:-1,backgroundColor:"#000000"});lib.ovCanvas=imlib.genCanvas({whichCanvas:"ov",extent:vpExtent,container:lib.vpDiv,zIndex:200,backgroundColor:"transparent"}); if(!idv.useFlash){lib.selCanvas=imlib.genCanvas({whichCanvas:"sel",extent:vpExtent,container:lib.vpDiv,zIndex:300,backgroundColor:"transparent"}); lib.hiliCanvas=imlib.genCanvas({whichCanvas:"hili",extent:vpExtent,container:lib.vpDiv,zIndex:400,backgroundColor:"transparent"});}
lib.bottomDiv=$('<div class="bottomDiv"></div>');lib.addSnapArrayDiv(lib.panelDiv);lib.addSelectedSnapDiv(lib.panelDiv);if(idv.pageKind=="album")lib.addCreateSnapDiv(lib.panelDiv);lib.theLayout.placeDivs();lib.theLayout.afterPlacement=function(){if(lib.vp){var layout=lib.theLayout;lib.vp.scale=layout.scale;var vpCss=layout.vpCss;lib.vpCanvas.attr({width:layout.vpExtent.x,height:layout.vpExtent.y});if(lib.ovCanvas)lib.ovCanvas.attr({width:layout.vpExtent.x,height:layout.vpExtent.y})
if(lib.selCanvas)lib.selCanvas.attr({width:layout.vpExtent.x,height:layout.vpExtent.y})
if(lib.hiliCanvas)lib.hiliCanvas.attr({width:layout.vpExtent.x,height:layout.vpExtent.y})
lib.vp.refresh(true);}}}
lib.genViewports=function(){lib.tiling.createTiles();var vpExtent=lib.theLayout.vpExtent;var vp=new imlib.Viewport(lib.vpDiv,lib.vpCanvas,lib.tiling,vpExtent,[lib.ovCanvas,lib.selCanvas,lib.hiliCanvas]);lib.vp=vp;vp.zoom=lib.initialZoom;lib.vp=vp;imlib.mainVP=vp;vp.maxZoom=lib.maxZoom;vp.maxDepth=lib.maxDepth;vp.depthBump=lib.imD.zoomDepthBump;lib.vp.panControl=new imlib.PanControl(lib.vpDiv,vp);lib.renderZoomControl(lib.zoomDiv);}
lib.displayError=function(msg){$('document').ready(function(){if(lib.loadingDiv)lib.loadingDiv.hide();lib.aspectRatio=1;lib.badUrl=1;lib.genDivs();lib.placeDivs();lib.resizeCurrentPanel();var err=$('<div/>').html(msg);err.css({"font-size":"14pt","margin-top":"40px","text-align":"center","margin-left":"auto","margin-right":"auto"});$('.columns').empty();$(".columns").append(err);return;});}})();
(function(){var lib=page;var geom=idv.geom;var image=idv.image;var util=idv.util;idv.css.link={"text-decoration":"underline","cursor":"pointer"};idv.pageKind="album";lib.includeShare=false;lib.Markdown;lib.albumDetailsWd=200;lib.albumDetailsDiv=$('<div class="albumDetailsDiv">'+'<div id="title"></div>'+'<div id="description" style="word-wrap:break-word"></div>'+'<table id="albumFields">'+'<tr  id="authorRow"><td  class="rowTitle">Image By:</td><td class="rowValue"><span style="width:'+lib.albumDetailsWd+'px" id="author"/></td></tr>'+'<tr  id="yearRow" ><td class="rowTitle">Year:</td><td class="rowValue"><span style="width:'+lib.albumDetailsWd+'px" id="year"/></td></tr>'+'<tr id="externalLinkRow"><td  class="rowTitle">External Link:</td><td class="rowValue"><span style="width:'+lib.imageDetailsWd+'px" id="externalLink"/></td></tr>'+'<tr id="contributorRow"><td  class="rowTitle">Album created by:</td><td class="rowValue"><span style="width:'+lib.imageDetailsWd+'px" id="contributor"/></td></tr>'+'</table>'+'<div id="jsonRow"><a target="_blank" id="json">JSON</a></div>'+'<div id="docs"><span id="albumsWhat">about albums</span><span id="jsonWhat">about JSON</span></div>'+"<div id='aboutJSON'>"+idv.common.closeX+"<p>The JSON link above resolves to a machine-readable encoding of the contents of this album, in the "+'<a target="_blank" href="http://json.org">JSON format</a>. The form of the data should be '+"should be self-explanatory to those familiar with JSON, except for one detail. The encoding of the area covered by  a snap looks like this: </p> "+'<table id="jsonTable"><tr><td>{"coverage": </td><td>{"corner": {"x": 0.25, "y": 0.5},</td><tr><tr><td></td><td>"extent": {"x": 0.01, "y": 0.02}}</td></tr></table></p> '+'<p>The x and y values are normalized to the '+'width of the image. So, in this example, if the image is 1000 pixels wide,  the upper left corner of the snap is at pixel coordinates (250,500), its width '+' is 10 pixels, and its height is 20 pixels.</p>'+'</div>'+"<div id='aboutAlbums'>"+idv.common.closeX+"<p>Each image may have many albums associated with it, each with  a different set of snap shots, and a different author. There is "+"an ImageDiver page for each album (this is one such page).  Each image also has its own page, linked to from the top bar.</p>"+"</div>"+'<div id="buttons"><span id="editButton" class="clickableElement">Edit Album Properties</span><span id="deleteButton" class="clickableElement">Delete the Album</span></div>'+'</div>');lib.albumsHtml=function(dst,albums,thisAlbumTopic){dst.empty();var ln=albums.length;for(var i=0;i<ln;i++){var ca=albums[i];if(ca.topic==thisAlbumTopic)continue;var cc=ca.caption;var uname=lib.pathLast(lib.pathLast(ca.owner));if(i<ln-1)comma=",";else comma="";var aline=$('<span class="albumLink"><span>'+cc+'</span> by '+uname+comma+' </span>');dst.append(aline);(function(tp){ aline.click(function(){util.navigateToPage("/topic"+tp+"/index.html");});})(ca.topic);}}
lib.embedText=function(wd){var topic=lib.albumD.topic;var url="http://s3.imagediver.org/widget.js?album="; if(wd>=700){var ht=Math.round(wd*0.666);var url="http://s3.imagediver.org/topic"+topic+"/index.html?embed=true";var rs='<iframe src = "'+url+'" width="'+wd+'" height="'+ht+'"></iframe>';}else{var tps=topic.split("/");url+=tps[2]+"."+tps[3]+"."+tps[4]+"&width="+wd;var rs='<script type="text/javascript" src="'+url+'"></script>'}
var ers=util.htmlEscape(rs);return ers;}
lib.editPermissions=function(){return(!idv.atS3)&&(idv.loggedInUser)&&(lib.imOnly||(!lib.albumD)||(idv.loggedInUser==lib.albumD.owner));}
lib.test=function(){var ov=new image.Overlay("test",new geom.Rect(new geom.Point(12000,2000),new geom.Point(5000,1000)));lib.vp.addOverlay(ov);} 
lib.setVis=function(el,v){if(!el)return;if(v)el.show();else el.hide();}
lib.updateButtonVis=function(){if(lib.displayingError)return;lib.setVis(lib.linkButton,lib.imOnly?0:1);lib.setVis(lib.tumblrButton,(idv.homePage||lib.imOnly||idv.atS3)?0:1);var lns=lib.snapDs.length;lib.setVis(lib.selectedSnapActivator,lns<2?0:1);lib.setVis(lib.snapArrayButton,lns<2?0:1);return; if(idv.atS3){lib.setVis(lib.linkButton,1);lib.setVis(lib.tumblrButton,1);return;}
if(lib.isSnaps){if(lib.selectedSnap){lib.setVis(lib.linkButton,1);lib.setVis(lib.tumblrButton,1);return;}}
lib.setVis(lib.linkButton,0);lib.setVis(lib.tumblrButton,0);}
lib.initialize=function(){idv.util.commonInit();var mt=document.location.hash.match(/snap=(\d*)/);if(mt){lib.urlSnap=parseInt(mt[1]);}
var lc=document.location.href;var isNew=0;var sp=lc.split("#")
var sp0=sp[0]
var spq=sp0.split("?")
sp1=spq[0]
if(spq.length>1){var qs=spq[1];if(qs.indexOf("new=1")>=0){isNew=1;}}
lib.albumIsNew=isNew;idv.homePage=false;if(sp1.indexOf("/topic")<0){ idv.homePage=true;var topic=idv.homeTopic;}else{if(idv.topicDir=="/topicd"){var tpr=/topicd\/album\/([^\/]*)\/([^\/]*)\/([^\/]*)\//;}else{tpr=/topic\/album\/([^\/]*)\/([^\/]*)\/([^\/]*)\//;}
var m=sp1.match(tpr);if(!m){if(!m){lib.displayError("Bad Url");return;}
}
var topic="/album/"+m[1]+"/"+m[2]+"/"+m[3];}
tpo=new util.topicOb(topic);lib.imTopic=tpo.imageTopic();lib.topic=topic;if((!idv.atS3)&&m&&(m[3]=="-")){lib.imOnly=true;lib.topic=lib.imTopic;topic=lib.topic;}
if((!lib.imOnly)&&(!idv.homePage)&&(!idv.atS3)&&(!idv.loggedInUser)){var s3lnk="http://s3.imagediver.org"+idv.topicDir+topic+"/index.html";lib.displayError('See the public version of this album at <a href="'+s3lnk+'">'+s3lnk+'</a>');return;}
var url=idv.topicDir+topic+"/main.json";lib.loadingDiv=$('<div style="margin:40px"><center>LOADING...  <img src="/ajax-loader.gif"/></center></dir>');$('body').append(lib.loadingDiv); $.ajax({url:url,dataType:'json',success:function(rs){if(rs.status=="fail"){lib.displayError("Missing or ill-formed URL");return;}
if(lib.imOnly){if(rs.value)lib.imD=rs.value;else lib.imD=rs;$('document').ready(initialize2);}else{lib.albumD=rs.value?rs.value:rs;lib.snaps=util.arrayMap(lib.albumD.snaps,lib.toSnapDObject);lib.albumD.snaps=lib.snaps;lib.beenPublished=lib.albumD.published;lib.albumD.image=lib.imTopic;var imurl=idv.topicDir+lib.imTopic+"/main.json";$.getJSON(imurl,function(rs){if(rs.value)lib.imD=rs.value;else lib.imD=rs;lib.imD.topic=lib.imTopic;$('document').ready(initialize2);return;});return;}},error:function(jq,txt,er){lib.displayError("Missing or ill-formed URL");}});return;}
function initialize2(){if(lib.imOnly){var snaps=[];var snapDs=[];lib.isSnaps=false;lib.isSnaps=true;}else{var snaps=lib.snaps;lib.snaps=[]; 
var ln=snaps.length;var snapDs=Array(ln);for(var i=0;i<ln;i++){var sn=snaps[i];var ord=sn.ordinal;snapDs[ord-1]=sn;}
snapDs=util.arrayFilter(snapDs,function(v){return v!=undefined;});ln=snapDs.length;for(var i=0;i<ln;i++){snp=snapDs[i];snp.myIndex=i;}}
lib.snapDs=snapDs;$('document').ready(initialize3);}
function initialize3(){util.tlog("initialize");var albumD=lib.albumD;var imD=lib.imD;var imdim=imD.dimensions;var imx=imdim.x;var tps=lib.topic.split("/");if(!lib.imOnly){var aid=tps[4];lib.albumOwner=owner;lib.albumNum=aid;lib.albumId=aid;lib.albumString=owner+"."+aid;}else{var owner=tps[2];}
util.commonInit();idv.pageKind="album";var snapDs=lib.snapDs;lib.snapDsByTopicNum={};util.arrayForEach(snapDs,function(snapD){return snapD.internalize(imx);});util.arrayForEach(snapDs,function(snapD){var topicId=util.lastPathElement(snapD.topic);snapD.topicId=topicId; lib.snapDsByTopicNum[topicId]=snapD;});util.arrayForEach(snapDs,lib.fixSnapCoverage);if(!lib.imOnly&&!albumD){image.genTitleBar("No Such Album");return;};var imdim=imD.dimensions;var imx=imdim.x;var imy=imdim.y;var imar=imx/imy;page.twoColums=true; page.fullsizeOption=(imar>1.6);lib.setParams(imD);lib.genDivs();lib.genViewports();$(window).resize(function(){util.log("resize",$(window).width());lib.placeDivs();lib.resizeCurrentPanel();});util.tlog("pre add snaps");lib.addSnaps(snapDs,0);util.tlog("after add snaps");lib.hookupPanelActivators();lib.selectPanel("snapArray");util.tlog("pre place divs");lib.placeDivs();util.tlog("after place divs");lib.resizeCurrentPanel();lib.loadingDiv.hide();lib.vp.refresh(true);util.slog("REFRESH");util.addDialogDiv($('.columns')); if(lib.imOnly&&(lib.imD.owner==idv.loggedInUser)&&(lib.imD.title==undefined)&&(lib.imD.author==undefined)){lib.popEditImageLightbox(true);}
if(lib.albumIsNew&&!lib.imOnly){lib.popEditAlbumLightbox();}
setTimeout(function(){lib.addSnaps(snapDs,500000);lib.enterShowSnapsMode();lib.checkNoSnaps();lib.showSnapByTopic()},100);util.tlog("initialize done");}
lib.defaultPanelHeight=function(){return lib.theLayout.scale*lib.theLayout.panelCss.height;}
lib.testUpdate=3;})();
